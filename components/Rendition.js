var _jsxFileName="/Users/johanpoirier/workspace/tea/epubjs-rn/src/Rendition.js";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require("react");var _react2=_interopRequireDefault(_react);var _reactNative=require("react-native");var _reactNativeWkwebviewReborn=require("react-native-wkwebview-reborn");var _reactNativeWkwebviewReborn2=_interopRequireDefault(_reactNativeWkwebviewReborn);var _eventEmitter=require("event-emitter");var _eventEmitter2=_interopRequireDefault(_eventEmitter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var URL=require("epubjs/libs/url/url-polyfill.js");var EPUBJS="(function(e,t){'object'==typeof exports&&'undefined'!=typeof module?module.exports=t(require('xmldom'),require('jszip')):'function'==typeof define&&define.amd?define(['xmldom','jszip'],t):e.ePub=t(e.xmldom,e.JSZip)})(this,function(e,t){'use strict';function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,'default')?e['default']:e}function a(e,t){return t={exports:{}},e(t,t.exports),t.exports}function o(){var e=new Date().getTime();return'undefined'!=typeof performance&&'function'==typeof performance.now&&(e+=performance.now()),'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(t){var n=0|(e+16*Math.random())%16;return e=oe(e/16),('x'===t?n:8|3&n).toString(16)})}function r(e){return!!(e&&1==e.nodeType)}function s(e){return!isNaN(parseFloat(e))&&isFinite(e)}function l(e){var t=parseFloat(e);return s(e)&&oe(t)!==parseFloat(e)}function d(e){var t=['Webkit','webkit','Moz','O','ms'],n=['-webkit-','-webkit-','-moz-','-o-','-ms-'],a=e[0].toUpperCase()+e.slice(1),o=t.length;if('undefined'==typeof document||'undefined'!=typeof document.body.style[e])return e;for(var r=0;r<o;r++)if('undefined'!=typeof document.body.style[t[r]+a])return n[r]+e;return e}function c(e){for(var t=1,n=arguments.length,a;t<n;t++)for(var i in a=arguments[t],a)void 0===e[i]&&(e[i]=a[i]);return e}function p(e){var t=[].slice.call(arguments,1);return t.forEach(function(t){t&&Qa(t).forEach(function(n){Qn(e,n,Fa(t,n))})}),e}function u(e,t,n,a,i){var o=a||0,r=i||t.length,s=parseInt(o+(r-o)/2),l;return(n||(n=function(e,t){return e>t?1:e<t?-1:e==t?0:void 0}),0>=r-o)?s:(l=n(t[s],e),1==r-o?0<=l?s:s+1:0===l?s:-1===l?u(e,t,n,s,r):u(e,t,n,o,s))}function h(e,t,n,a,i){var o=a||0,r=i||t.length,s=parseInt(o+(r-o)/2),l;return(n||(n=function(e,t){return e>t?1:e<t?-1:e==t?0:void 0}),0>=r-o)?-1:(l=n(t[s],e),1==r-o?0===l?s:-1:0===l?s:-1===l?h(e,t,n,s,r):h(e,t,n,o,s))}function m(e){var t=window.getComputedStyle(e),n=0,a=0;return['width','paddingRight','paddingLeft','marginRight','marginLeft','borderRightWidth','borderLeftWidth'].forEach(function(e){n+=parseFloat(t[e])||0}),['height','paddingTop','paddingBottom','marginTop','marginBottom','borderTopWidth','borderBottomWidth'].forEach(function(e){a+=parseFloat(t[e])||0}),{height:a,width:n}}function y(e){var t=window.getComputedStyle(e),n=0,a=0;return['paddingRight','paddingLeft','marginRight','marginLeft','borderRightWidth','borderLeftWidth'].forEach(function(e){n+=parseFloat(t[e])||0}),['paddingTop','paddingBottom','marginTop','marginBottom','borderTopWidth','borderBottomWidth'].forEach(function(e){a+=parseFloat(t[e])||0}),{height:a,width:n}}function v(){var e=window.innerWidth,t=window.innerHeight;return{top:0,left:0,right:e,bottom:t,width:e,height:t}}function k(e,t){for(var n=e.parentNode,a=n.childNodes,o=-1,r=0,i;r<a.length&&(i=a[r],i.nodeType===t&&o++,i!=e);r++);return o}function b(e){return k(e,ti)}function x(e){return-1<['xml','opf','ncx'].indexOf(e)}function _(e,t){return new Blob([e],{type:t})}function E(e,t){var n=_(e,t),a;return a=ai.createObjectURL(n),a}function w(e){return ai.revokeObjectURL(e)}function S(e,t){var n,a;if('string'==typeof e)return n=btoa(encodeURIComponent(e)),a='data:'+t+';base64,'+n,a}function C(e){return Object.prototype.toString.call(e).slice(8,-1)}function R(t,n,a){var i,o;return o='undefined'==typeof DOMParser||a?e.DOMParser:DOMParser,65279===t.charCodeAt(0)&&(t=t.slice(1)),i=new o().parseFromString(t,n),i}function T(e,t){var n;if(!e)throw new Error('No Element Provided');return'undefined'==typeof e.querySelector?(n=e.getElementsByTagName(t),n.length)?n[0]:void 0:e.querySelector(t)}function O(e,t){return'undefined'==typeof e.querySelector?e.getElementsByTagName(t):e.querySelectorAll(t)}function L(e,t,n){var a,i;if('undefined'!=typeof e.querySelector){for(var o in t+='[',n)t+=o+'~=\\''+n[o]+'\\'';return t+=']',e.querySelector(t)}return(a=e.getElementsByTagName(t),i=Array.prototype.slice.call(a,0).filter(function(e){for(var t in n)if(e.getAttribute(t)===n[t])return!0;return!1}),i)?i[0]:void 0}function N(e,t){var n=e.ownerDocument||e;'undefined'==typeof n.createTreeWalker?A(e,function(e){e&&3===e.nodeType&&t(e)},!0):I(e,t,NodeFilter.SHOW_TEXT)}function I(e,t,n){for(var a=document.createTreeWalker(e,n,null,!1),i;i=a.nextNode();)t(i)}function A(e,t){if(t(e))return!0;if(e=e.firstChild,e)do{var n=A(e,t);if(n)return!0;e=e.nextSibling}while(e)}function P(e){return new Gn(function(t){var n=new FileReader;n.readAsDataURL(e),n.onloadend=function(){t(n.result)}})}function B(){var e=this;this.resolve=null,this.reject=null,this.id=o(),this.promise=new Gn(function(t,n){e.resolve=t,e.reject=n}),Na(this)}function j(e,t,n){var a;if('undefined'!=typeof e.querySelector&&(a=e.querySelector(t+'[*|type=\"'+n+'\"]')),!a||0===a.length){a=O(e,t);for(var o=0;o<a.length;o++)if(a[o].getAttributeNS('http://www.idpf.org/2007/ops','type')===n||a[o].getAttribute('epub:type')===n)return a[o]}else return a}function D(e){for(var t=[],n=e.childNodes,a=0,i;a<n.length;a++)i=n[a],1===i.nodeType&&t.push(i);return t}function z(e){for(var t=[e];e;e=e.parentNode)t.unshift(e);return t}function M(e,t,n){for(var a=[],o=e.childNodes,r=0,i;r<o.length;r++)if(i=o[r],1===i.nodeType&&i.nodeName.toLowerCase()===t){if(n)return i;a.push(i)}if(!n)return a}function q(e,t){var n;if(null!==e&&''!==t)for(n=e.parentNode;1===n.nodeType;){if(n.tagName.toLowerCase()===t)return n;n=n.parentNode}}function F(e,t){for(var n=e.index,a;n<t.length-1;){if(a=t[n+1],a&&(!0===a.linear||'yes'===a.linear))return a;n+=1}}function W(e,t){for(var n=e.index,a;0<n;){if(a=t[n-1],a&&(!0===a.linear||'yes'===a.linear))return a;n-=1}}function H(t){var n='undefined'!=typeof navigator&&navigator.userAgent||'',a=0<=n.indexOf('Trident'),i;i='undefined'==typeof XMLSerializer||a?e.XMLSerializer:XMLSerializer;var o=new i;return o.serializeToString(t)}function U(e){if('string'!=typeof e)throw new TypeError('Path must be a string. Received '+e)}function Y(e,t){for(var n='',a=-1,o=0,r=0,i;r<=e.length;++r){if(r<e.length)i=e.charCodeAt(r);else if(47===i)break;else i=47;if(47===i){if(a===r-1||1==o);else if(a!==r-1&&2==o){if(2>n.length||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(2<n.length){for(var s=n.length-1,l=s;0<=l&&47!==n.charCodeAt(l);--l);if(l!==s){n=-1===l?'':n.slice(0,l),a=r,o=0;continue}}else if(2===n.length||1===n.length){n='',a=r,o=0;continue}t&&(0<n.length?n+='/..':n='..')}else 0<n.length?n+='/'+e.slice(a+1,r):n=e.slice(a+1,r);a=r,o=0}else 46===i&&-1!=o?++o:o=-1}return n}function V(e,t){var n=t.dir||t.root,a=t.base||(t.name||'')+(t.ext||'');return n?n===t.root?n+a:n+e+a:a}function G(e,t){var n=t.href,a=-1<n.indexOf('://'),i,o;if(e){if(o=T(e,'head'),i=T(o,'base'),i||(i=e.createElement('base'),o.insertBefore(i,o.firstChild)),!a&&'undefined'!=typeof window&&window.location){var r=window.location.href.split('/'),s='';r.pop(),s=r.join('/'),n=s+n}i.setAttribute('href',n)}}function K(e,t){var n=t.canonical||t.href,a,i;e&&(a=T(e,'head'),i=T(a,'link[rel=\\'canonical\\']'),i?i.setAttribute('href',n):(i=e.createElement('link'),i.setAttribute('rel','canonical'),i.setAttribute('href',n),a.appendChild(i)))}function X(e,t){var n=t.idref||t.href,a,i;e&&(a=T(e,'head'),i=T(a,'link[property=\\'dc.identifier\\']'),i?i.setAttribute('content',n):(i=e.createElement('meta'),i.setAttribute('name','dc.identifier'),i.setAttribute('content',n),a.appendChild(i)))}function $(e,t){var n=e.querySelectorAll('a[href]');if(n.length)for(var a=T(e.ownerDocument,'base'),o=a?a.getAttribute('href'):e.ownerDocument.defaultView.location.href,r=function(e){var n=e.getAttribute('href');if(0!==n.indexOf('mailto:')){var a=-1<n.indexOf('://'),i=new ci(n,o);a?e.setAttribute('target','_blank'):e.onclick=function(){return i&&i.hash?t(i.Path.path+i.hash):i?t(i.Path.path):t(n),!1}}}.bind(this),s=0;s<n.length;s++)r(n[s])}function Z(e,t,n,a){function i(t){l.reject(t)}function o(){if(this.readyState===XMLHttpRequest.DONE){var e=!1;if((''===this.responseType||'document'===this.responseType)&&(e=this.responseXML),200===this.status||0===this.status||e){var n;if(!this.response&&!e)return l.reject({status:this.status,message:'Empty Response',stack:new Error().stack}),l.promise;if(403===this.status)return l.reject({status:this.status,response:this.response,message:'Forbidden',stack:new Error().stack}),l.promise;n=e?this.responseXML:x(t)?R(this.response,'text/xml'):'xhtml'==t?R(this.response,'application/xhtml+xml'):'html'==t||'htm'==t?R(this.response,'text/html'):'json'==t?JSON.parse(this.response):'blob'==t?s?this.response:new Blob([this.response]):this.response,l.resolve(n)}else l.reject({status:this.status,message:this.response,stack:new Error().stack})}}var s='undefined'!=typeof window&&window.URL,r=s?'blob':'arraybuffer',l=new B,d=new XMLHttpRequest,c=XMLHttpRequest.prototype,p;for(p in'overrideMimeType'in c||Object.defineProperty(c,'overrideMimeType',{value:function(){}}),n&&(d.withCredentials=!0),d.onreadystatechange=o,d.onerror=i,d.open('GET',e,!0),a)d.setRequestHeader(p,a[p]);return'json'==t&&d.setRequestHeader('Accept','application/json'),t||(t=new di(e).extension),'blob'==t&&(d.responseType=r),x(t)&&d.overrideMimeType('text/xml'),'binary'==t&&(d.responseType='arraybuffer'),d.send(),l.promise}function J(e){return null==e?void 0===e?yr:mr:fr&&fr in Object(e)?pr(e):gr(e)}function Q(e,t,n){function a(t){var n=y,a=f;return y=f=void 0,u=t,k=e.apply(a,n),k}function i(e){return u=e,b=setTimeout(s,t),h?a(e):k}function o(e){var n=e-x,a=e-u,i=t-n;return g?Or(i,v-a):i}function r(e){var n=e-x,a=e-u;return void 0===x||n>=t||0>n||g&&a>=v}function s(){var e=ir();return r(e)?l(e):void(b=setTimeout(s,o(e)))}function l(e){return(b=void 0,m&&y)?a(e):(y=f=void 0,k)}function d(){void 0!==b&&clearTimeout(b),u=0,y=x=f=b=void 0}function c(){return void 0===b?k:l(ir())}function p(){var e=ir(),n=r(e);if(y=arguments,f=this,x=e,n){if(void 0===b)return i(x);if(g)return b=setTimeout(s,t),a(x)}return void 0===b&&(b=setTimeout(s,t)),k}var u=0,h=!1,g=!1,m=!0,y,f,v,k,b,x;if('function'!=typeof e)throw new TypeError(Rr);return t=Cr(t)||0,Qo(n)&&(h=!!n.leading,g='maxWait'in n,v=g?Tr(Cr(n.maxWait)||0,t):v,m='trailing'in n?!!n.trailing:m),p.cancel=d,p.flush=c,p}function ee(e,t,n){var a=!0,i=!0;if('function'!=typeof e)throw new TypeError(Nr);return Qo(n)&&(a='leading'in n?!!n.leading:a,i='trailing'in n?!!n.trailing:i),Lr(e,t,{leading:a,maxWait:t,trailing:i})}var te=Math.round,ne=String.prototype,ae=Math.max,ie=Math.min,oe=Math.floor,re=Math.ceil;e=e&&e.hasOwnProperty('default')?e['default']:e,t=t&&t.hasOwnProperty('default')?t['default']:t;var se='undefined'==typeof window?'undefined'==typeof global?'undefined'==typeof self?{}:self:global:window,le=a(function(e){var t=e.exports={version:'2.4.0'};'number'==typeof __e&&(__e=t)}),de=le.version,ce=le.JSON||(le.JSON={stringify:JSON.stringify}),pe=function(){return ce.stringify.apply(ce,arguments)},ue=a(function(e){e.exports={default:pe,__esModule:!0}}),he=n(ue),ge=function(e){return isNaN(e=+e)?0:(0<e?oe:re)(e)},me=function(e){if(void 0==e)throw TypeError('Can\\'t call method on  '+e);return e},ye=!0,fe=a(function(e){var t=e.exports='undefined'!=typeof window&&window.Math==Math?window:'undefined'!=typeof self&&self.Math==Math?self:Function('return this')();'number'==typeof __g&&(__g=t)}),ve=function(e){if('function'!=typeof e)throw TypeError(e+' is not a function!');return e},ke=function(e,t,n){return(ve(e),void 0===t)?e:1===n?function(n){return e.call(t,n)}:2===n?function(n,a){return e.call(t,n,a)}:3===n?function(n,a,i){return e.call(t,n,a,i)}:function(){return e.apply(t,arguments)}},be=function(e){return'object'==typeof e?null!==e:'function'==typeof e},xe=function(e){if(!be(e))throw TypeError(e+' is not an object!');return e},_e=function(e){try{return!!e()}catch(t){return!0}},Ee=!_e(function(){return 7!=Object.defineProperty({},'a',{get:function(){return 7}}).a}),we=fe.document,Se=be(we)&&be(we.createElement),Ce=function(e){return Se?we.createElement(e):{}},Re=!Ee&&!_e(function(){return 7!=Object.defineProperty(Ce('div'),'a',{get:function(){return 7}}).a}),Te=function(e,t){if(!be(e))return e;var n,a;if(t&&'function'==typeof(n=e.toString)&&!be(a=n.call(e)))return a;if('function'==typeof(n=e.valueOf)&&!be(a=n.call(e)))return a;if(!t&&'function'==typeof(n=e.toString)&&!be(a=n.call(e)))return a;throw TypeError('Can\\'t convert object to primitive value')},Oe=Object.defineProperty,Le=Ee?Object.defineProperty:function(e,t,n){if(xe(e),t=Te(t,!0),xe(n),Re)try{return Oe(e,t,n)}catch(t){}if('get'in n||'set'in n)throw TypeError('Accessors not supported!');return'value'in n&&(e[t]=n.value),e},Ne={f:Le},Ie=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Ae=Ee?function(e,t,n){return Ne.f(e,t,Ie(1,n))}:function(e,t,n){return e[t]=n,e},Pe='prototype',Be=function(e,t,n){var a=e&Be.F,i=e&Be.G,o=e&Be.S,r=e&Be.P,s=e&Be.B,l=e&Be.W,d=i?le:le[t]||(le[t]={}),c=d[Pe],p=i?fe:o?fe[t]:(fe[t]||{})[Pe],u,h,g;for(u in i&&(n=t),n)h=!a&&p&&void 0!==p[u],h&&u in d||(g=h?p[u]:n[u],d[u]=i&&'function'!=typeof p[u]?n[u]:s&&h?ke(g,fe):l&&p[u]==g?function(e){var t=function(t,n,a){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n);}return new e(t,n,a)}return e.apply(this,arguments)};return t[Pe]=e[Pe],t}(g):r&&'function'==typeof g?ke(Function.call,g):g,r&&((d.virtual||(d.virtual={}))[u]=g,e&Be.R&&c&&!c[u]&&Ae(c,u,g)))};Be.F=1,Be.G=2,Be.S=4,Be.P=8,Be.B=16,Be.W=32,Be.U=64,Be.R=128;var je=Be,De=Ae,ze={}.hasOwnProperty,Me=function(e,t){return ze.call(e,t)},qe={},Fe={}.toString,We=function(e){return Fe.call(e).slice(8,-1)},He=Object('z').propertyIsEnumerable(0)?Object:function(e){return'String'==We(e)?e.split(''):Object(e)},Ue=function(e){return He(me(e))},Ye=function(e){return 0<e?ie(ge(e),9007199254740991):0},Ve=function(e,t){return e=ge(e),0>e?ae(e+t,0):ie(e,t)},Ge='__core-js_shared__',Ke=fe[Ge]||(fe[Ge]={}),Xe=function(e){return Ke[e]||(Ke[e]={})},$e=0,Ze=Math.random(),Je=function(e){return'Symbol('.concat(void 0===e?'':e,')_',(++$e+Ze).toString(36))},Qe=Xe('keys'),et=function(e){return Qe[e]||(Qe[e]=Je(e))},tt=function(e){return function(t,n,a){var i=Ue(t),o=Ye(i.length),r=Ve(a,o),s;if(e&&n!=n){for(;o>r;)if(s=i[r++],s!=s)return!0;}else for(;o>r;r++)if((e||r in i)&&i[r]===n)return e||r||0;return!e&&-1}}(!1),nt=et('IE_PROTO'),at=function(e,t){var n=Ue(e),a=0,i=[],o;for(o in n)o!=nt&&Me(n,o)&&i.push(o);for(;t.length>a;)Me(n,o=t[a++])&&(~tt(i,o)||i.push(o));return i},it=['constructor','hasOwnProperty','isPrototypeOf','propertyIsEnumerable','toLocaleString','toString','valueOf'],ot=Object.keys||function(e){return at(e,it)},rt=Ee?Object.defineProperties:function(e,t){xe(e);for(var n=ot(t),a=n.length,o=0,i;a>o;)Ne.f(e,i=n[o++],t[i]);return e},st=fe.document&&document.documentElement,lt=et('IE_PROTO'),dt=function(){},ct='prototype',pt=function(){var e=Ce('iframe'),t=it.length,n='<',a='>',i;for(e.style.display='none',st.appendChild(e),e.src='javascript:',i=e.contentWindow.document,i.open(),i.write(n+'script'+a+'document.F=Object'+n+'/script'+a),i.close(),pt=i.F;t--;)delete pt[ct][it[t]];return pt()},ut=Object.create||function(e,t){var n;return null===e?n=pt():(dt[ct]=xe(e),n=new dt,dt[ct]=null,n[lt]=e),void 0===t?n:rt(n,t)},ht=a(function(e){var t=Xe('wks'),n=fe.Symbol,a='function'==typeof n,i=e.exports=function(e){return t[e]||(t[e]=a&&n[e]||(a?n:Je)('Symbol.'+e))};i.store=t}),gt=Ne.f,mt=ht('toStringTag'),yt=function(e,t,n){e&&!Me(e=n?e:e.prototype,mt)&&gt(e,mt,{configurable:!0,value:t})},ft={};Ae(ft,ht('iterator'),function(){return this});var vt=function(e,t,n){e.prototype=ut(ft,{next:Ie(1,n)}),yt(e,t+' Iterator')},kt=function(e){return Object(me(e))},bt=et('IE_PROTO'),xt=Object.prototype,_t=Object.getPrototypeOf||function(e){return e=kt(e),Me(e,bt)?e[bt]:'function'==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?xt:null},Et=ht('iterator'),wt=!([].keys&&'next'in[].keys()),St='keys',Ct='values',Rt=function(){return this},Tt=function(e,t,n,a,i,o,r){vt(n,t,a);var s=function(e){return!wt&&e in p?p[e]:e===St?function(){return new n(this,e)}:e===Ct?function(){return new n(this,e)}:function(){return new n(this,e)}},l=t+' Iterator',d=i==Ct,c=!1,p=e.prototype,u=p[Et]||p['@@iterator']||i&&p[i],h=u||s(i),g=i?d?s('entries'):h:void 0,m='Array'==t?p.entries||u:u,y,f,v;if(m&&(v=_t(m.call(new e)),v!==Object.prototype&&(yt(v,l,!0),!ye)),d&&u&&u.name!==Ct&&(c=!0,h=function(){return u.call(this)}),r&&(wt||c||!p[Et])&&Ae(p,Et,h),qe[t]=h,qe[l]=Rt,i)if(y={values:d?h:s(Ct),keys:o?h:s(St),entries:g},r)for(f in y)f in p||De(p,f,y[f]);else je(je.P+je.F*(wt||c),t,y);return y},Ot=function(e){return function(t,n){var o=me(t)+'',r=ge(n),i=o.length,s,a;return 0>r||r>=i?e?'':void 0:(s=o.charCodeAt(r),55296>s||56319<s||r+1===i||56320>(a=o.charCodeAt(r+1))||57343<a?e?o.charAt(r):s:e?o.slice(r,r+2):(s-55296<<10)+(a-56320)+65536)}}(!0);Tt(String,'String',function(e){this._t=e+'',this._i=0},function(){var e=this._t,t=this._i,n;return t>=e.length?{value:void 0,done:!0}:(n=Ot(e,t),this._i+=n.length,{value:n,done:!1})});var Lt=function(e,t){return{value:t,done:!!e}},Nt=Tt(Array,'Array',function(e,t){this._t=Ue(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,Lt(1)):'keys'==t?Lt(0,n):'values'==t?Lt(0,e[n]):Lt(0,[n,e[n]])},'values');qe.Arguments=qe.Array;for(var It=ht('toStringTag'),At=['NodeList','DOMTokenList','MediaList','StyleSheetList','CSSRuleList'],Pt=0;5>Pt;Pt++){var i=At[Pt],Bt=fe[i],jt=Bt&&Bt.prototype;jt&&!jt[It]&&Ae(jt,It,i),qe[i]=qe.Array}var Dt=ht('toStringTag'),zt='Arguments'==We(function(){return arguments}()),Mt=function(e,t){try{return e[t]}catch(t){}},qt=function(e){var t,n,a;return void 0===e?'Undefined':null===e?'Null':'string'==typeof(n=Mt(t=Object(e),Dt))?n:zt?We(t):'Object'==(a=We(t))&&'function'==typeof t.callee?'Arguments':a},Ft=function(e,t,n,a){if(!(e instanceof t)||void 0!==a&&a in e)throw TypeError(n+': incorrect invocation!');return e},Wt=function(t,e,n,a){try{return a?e(xe(n)[0],n[1]):e(n)}catch(n){var i=t['return'];throw void 0!==i&&xe(i.call(t)),n}},Ht=ht('iterator'),Ut=Array.prototype,Yt=function(e){return void 0!==e&&(qe.Array===e||Ut[Ht]===e)},Vt=ht('iterator'),Gt=le.getIteratorMethod=function(e){if(void 0!=e)return e[Vt]||e['@@iterator']||qe[qt(e)]},Kt=a(function(e){var t={},n={},a=e.exports=function(e,a,i,o,r){var s=r?function(){return e}:Gt(e),l=ke(i,o,a?2:1),d=0,c,p,u,h;if('function'!=typeof s)throw TypeError(e+' is not iterable!');if(Yt(s)){for(c=Ye(e.length);c>d;d++)if(h=a?l(xe(p=e[d])[0],p[1]):l(e[d]),h===t||h===n)return h;}else for(u=s.call(e);!(p=u.next()).done;)if(h=Wt(u,l,p.value,a),h===t||h===n)return h};a.BREAK=t,a.RETURN=n}),Xt=ht('species'),$t=function(e,t){var n=xe(e).constructor,a;return void 0===n||void 0==(a=xe(n)[Xt])?t:ve(a)},Zt=function(e,t,n){var a=void 0===n;switch(t.length){case 0:return a?e():e.call(n);case 1:return a?e(t[0]):e.call(n,t[0]);case 2:return a?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return a?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return a?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3]);}return e.apply(n,t)},Jt=fe.process,Qt=fe.setImmediate,en=fe.clearImmediate,tn=fe.MessageChannel,nn=0,an={},on='onreadystatechange',rn=function(){var e=+this;if(an.hasOwnProperty(e)){var t=an[e];delete an[e],t()}},sn=function(e){rn.call(e.data)},ln,dn,cn;Qt&&en||(Qt=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return an[++nn]=function(){Zt('function'==typeof e?e:Function(e),t)},ln(nn),nn},en=function(e){delete an[e]},'process'==We(Jt)?ln=function(e){Jt.nextTick(ke(rn,e,1))}:tn?(dn=new tn,cn=dn.port2,dn.port1.onmessage=sn,ln=ke(cn.postMessage,cn,1)):fe.addEventListener&&'function'==typeof postMessage&&!fe.importScripts?(ln=function(e){fe.postMessage(e+'','*')},fe.addEventListener('message',sn,!1)):on in Ce('script')?ln=function(e){st.appendChild(Ce('script'))[on]=function(){st.removeChild(this),rn.call(e)}}:ln=function(e){setTimeout(ke(rn,e,1),0)});var pn={set:Qt,clear:en},un=pn.set,hn=fe.MutationObserver||fe.WebKitMutationObserver,gn=fe.process,mn=fe.Promise,yn='process'==We(gn),fn=ht('species'),vn=ht('iterator'),kn=!1;try{var bn=[7][vn]();bn['return']=function(){kn=!0}}catch(t){}var xn=function(e,t){if(!t&&!kn)return!1;var n=!1;try{var a=[7],i=a[vn]();i.next=function(){return{done:n=!0}},a[vn]=function(){return i},e(a)}catch(t){}return n},_n=pn.set,En=function(){var e=function(){var e,i;for(yn&&(e=gn.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(i){throw t?a():n=void 0,i}}n=void 0,e&&e.enter()},t,n,a;if(yn)a=function(){gn.nextTick(e)};else if(hn){var i=!0,o=document.createTextNode('');new hn(e).observe(o,{characterData:!0}),a=function(){o.data=i=!i}}else if(mn&&mn.resolve){var r=mn.resolve();a=function(){r.then(e)}}else a=function(){un.call(fe,e)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,a()),n=i}}(),wn='Promise',Sn=fe.TypeError,Cn=fe.process,Rn=fe[wn],Cn=fe.process,Tn='process'==qt(Cn),On=function(){},Ln=!!function(){try{var e=Rn.resolve(1),t=(e.constructor={})[ht('species')]=function(e){e(On,On)};return(Tn||'function'==typeof PromiseRejectionEvent)&&e.then(On)instanceof t}catch(t){}}(),Nn=function(e,t){return e===t||e===Rn&&t===Un},In=function(e){var t;return!!(be(e)&&'function'==typeof(t=e.then))&&t},An=function(e){return Nn(Rn,e)?new Pn(e):new Hn(e)},Pn=Hn=function(e){var t,n;this.promise=new e(function(e,a){if(void 0!==t||void 0!==n)throw Sn('Bad Promise constructor');t=e,n=a}),this.resolve=ve(t),this.reject=ve(n)},Bn=function(e){try{e()}catch(t){return{error:t}}},jn=function(e,t){if(!e._n){e._n=!0;var n=e._c;En(function(){for(var a=e._v,o=1==e._s,r=0,i=function(t){var n=o?t.ok:t.fail,i=t.resolve,r=t.reject,s=t.domain,l,d;try{n?(!o&&(2==e._h&&Mn(e),e._h=1),!0===n?l=a:(s&&s.enter(),l=n(a),s&&s.exit()),l===t.promise?r(Sn('Promise-chain cycle')):(d=In(l))?d.call(l,i,r):i(l)):r(a)}catch(t){r(t)}};n.length>r;)i(n[r++]);e._c=[],e._n=!1,t&&!e._h&&Dn(e)})}},Dn=function(e){_n.call(fe,function(){var t=e._v,n,a,i;if(zn(e)&&(n=Bn(function(){Tn?Cn.emit('unhandledRejection',t,e):(a=fe.onunhandledrejection)?a({promise:e,reason:t}):(i=fe.console)&&i.error&&i.error('Unhandled promise rejection',t)}),e._h=Tn||zn(e)?2:1),e._a=void 0,n)throw n.error})},zn=function(e){if(1==e._h)return!1;for(var t=e._a||e._c,n=0,a;t.length>n;)if(a=t[n++],a.fail||!zn(a.promise))return!1;return!0},Mn=function(e){_n.call(fe,function(){var t;Tn?Cn.emit('rejectionHandled',e):(t=fe.onrejectionhandled)&&t({promise:e,reason:e._v})})},qn=function(e){var t=this;t._d||(t._d=!0,t=t._w||t,t._v=e,t._s=2,!t._a&&(t._a=t._c.slice()),jn(t,!0))},Fn=function(e){var t=this,n;if(!t._d){t._d=!0,t=t._w||t;try{if(t===e)throw Sn('Promise can\\'t be resolved itself');(n=In(e))?En(function(){var a={_w:t,_d:!1};try{n.call(e,ke(Fn,a,1),ke(qn,a,1))}catch(t){qn.call(a,t)}}):(t._v=e,t._s=1,jn(t,!1))}catch(n){qn.call({_w:t,_d:!1},n)}}},Wn,Hn,Un;Ln||(Rn=function(e){Ft(this,Rn,wn,'_h'),ve(e),Wn.call(this);try{e(ke(Fn,this,1),ke(qn,this,1))}catch(e){qn.call(this,e)}},Wn=function(){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},Wn.prototype=function(e,t,n){for(var a in t)n&&e[a]?e[a]=t[a]:Ae(e,a,t[a]);return e}(Rn.prototype,{then:function(e,t){var n=An($t(this,Rn));return n.ok='function'!=typeof e||e,n.fail='function'==typeof t&&t,n.domain=Tn?Cn.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&jn(this,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),Pn=function(){var e=new Wn;this.promise=e,this.resolve=ke(Fn,e,1),this.reject=ke(qn,e,1)}),je(je.G+je.W+je.F*!Ln,{Promise:Rn}),yt(Rn,wn),function(e){var t='function'==typeof le[e]?le[e]:fe[e];Ee&&t&&!t[fn]&&Ne.f(t,fn,{configurable:!0,get:function(){return this}})}(wn),Un=le[wn],je(je.S+je.F*!Ln,wn,{reject:function(e){var t=An(this),n=t.reject;return n(e),t.promise}}),je(je.S+je.F*ye,wn,{resolve:function(e){if(e instanceof Rn&&Nn(e.constructor,this))return e;var t=An(this),n=t.resolve;return n(e),t.promise}}),je(je.S+je.F*!(Ln&&xn(function(e){Rn.all(e)['catch'](On)})),wn,{all:function(e){var t=this,n=An(t),a=n.resolve,i=n.reject,o=Bn(function(){var n=[],o=0,r=1;Kt(e,!1,function(e){var s=o++,l=!1;n.push(void 0),r++,t.resolve(e).then(function(e){l||(l=!0,n[s]=e,--r||a(n))},i)}),--r||a(n)});return o&&i(o.error),n.promise},race:function(e){var t=this,n=An(t),a=n.reject,i=Bn(function(){Kt(e,!1,function(e){t.resolve(e).then(n.resolve,a)})});return i&&a(i.error),n.promise}});var Yn=le.Promise,Vn=a(function(e){e.exports={default:Yn,__esModule:!0}}),Gn=n(Vn),Kn=a(function(e,t){t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}}),Xn=n(Kn);je(je.S+je.F*!Ee,'Object',{defineProperty:Ne.f});var $n=le.Object,Zn=function(e,t,n){return $n.defineProperty(e,t,n)},Jn=a(function(e){e.exports={default:Zn,__esModule:!0}}),Qn=n(Jn),ea=a(function(e,t){t.__esModule=!0;var n=function(e){return e&&e.__esModule?e:{default:e}}(Jn);t.default=function(){function e(e,t){for(var a=0,i;a<t.length;a++)i=t[a],i.enumerable=i.enumerable||!1,i.configurable=!0,'value'in i&&(i.writable=!0),(0,n.default)(e,i.key,i)}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}()}),ta=n(ea),na=function(){}(),aa=function(e){return e!==na&&null!==e},ia=Object.keys,oa=function(){try{return!0}catch(t){return!1}}()?Object.keys:function(e){return ia(aa(e)?Object(e):e)},ra=function(e){if(!aa(e))throw new TypeError('Cannot use null or undefined');return e},sa=function(e,t){var n=ae(arguments.length,2),a,o,i;for(e=Object(ra(e)),i=function(n){try{e[n]=t[n]}catch(t){a||(a=t)}},o=1;o<n;++o)t=arguments[o],oa(t).forEach(i);if(void 0!==a)throw a;return e},la=function(){var e=Object.assign,t;return'function'==typeof e&&(t={foo:'raz'},e(t,{bar:'dwa'},{trzy:'trzy'}),'razdwatrzy'===t.foo+t.bar+t.trzy)}()?Object.assign:sa,da=Array.prototype.forEach,ca=Object.create,pa=function(e,t){for(var n in e)t[n]=e[n]},ua=function(){var e=ca(null);return da.call(arguments,function(t){aa(t)&&pa(Object(t),e)}),e},ha=function(e){return'function'==typeof e},ga='razdwatrzy',ma=ne.indexOf,ya=function(){return'function'==typeof ga.contains&&!0===ga.contains('dwa')&&!1===ga.contains('foo')}()?ne.contains:function(e){return-1<ma.call(this,e,arguments[1])},fa=a(function(e){var t;t=e.exports=function(t,n){var a,i,o,r,s;return 2>arguments.length||'string'!=typeof t?(r=n,n=t,t=null):r=arguments[2],null==t?(a=o=!0,i=!1):(a=ya.call(t,'c'),i=ya.call(t,'e'),o=ya.call(t,'w')),s={value:n,configurable:a,enumerable:i,writable:o},r?la(ua(r),s):s},t.gs=function(t,n,a){var i,o,r,s;return'string'==typeof t?r=arguments[3]:(r=a,a=n,n=t,t=null),null==n?n=void 0:ha(n)?null==a?a=void 0:!ha(a)&&(r=a,a=void 0):(r=n,n=a=void 0),null==t?(i=!0,o=!1):(i=ya.call(t,'c'),o=ya.call(t,'e')),s={get:n,set:a,configurable:i,enumerable:o},r?la(ua(r),s):s}}),va=function(e){if('function'!=typeof e)throw new TypeError(e+' is not a function');return e},ka=a(function(e,t){var n=Function.prototype.apply,a=Function.prototype.call,i=Object.create,o=Object.defineProperty,r=Object.defineProperties,s=Object.prototype.hasOwnProperty,l={configurable:!0,enumerable:!1,writable:!0},d,c,p,u,h,g,m;d=function(e,t){var n;return va(t),s.call(this,'__ee__')?n=this.__ee__:(n=l.value=i(null),o(this,'__ee__',l),l.value=null),n[e]?'object'==typeof n[e]?n[e].push(t):n[e]=[n[e],t]:n[e]=t,this},c=function(e,t){var a,i;return va(t),i=this,d.call(this,e,a=function(){p.call(i,e,a),n.call(t,this,arguments)}),a.__eeOnceListener__=t,this},p=function(e,t){var n,a,o,r;if(va(t),!s.call(this,'__ee__'))return this;if(n=this.__ee__,!n[e])return this;if(a=n[e],'object'==typeof a)for(r=0;o=a[r];++r)(o===t||o.__eeOnceListener__===t)&&(2===a.length?n[e]=a[r?0:1]:a.splice(r,1));else(a===t||a.__eeOnceListener__===t)&&delete n[e];return this},u=function(e){var t,i,o,r,l;if(s.call(this,'__ee__')&&(r=this.__ee__[e],!!r))if('object'==typeof r){for(i=arguments.length,l=Array(i-1),t=1;t<i;++t)l[t-1]=arguments[t];for(r=r.slice(),t=0;o=r[t];++t)n.call(o,this,l)}else switch(arguments.length){case 1:a.call(r,this);break;case 2:a.call(r,this,arguments[1]);break;case 3:a.call(r,this,arguments[1],arguments[2]);break;default:for(i=arguments.length,l=Array(i-1),t=1;t<i;++t)l[t-1]=arguments[t];n.call(r,this,l);}},h={on:d,once:c,off:p,emit:u},g={on:fa(d),once:fa(c),off:fa(p),emit:fa(u)},m=r({},g),e.exports=t=function(e){return null==e?i(m):r(Object(e),g)},t.methods=h}),ba=ka.methods,xa=a(function(e){var t=Je('meta'),n=Ne.f,a=0,i=Object.isExtensible||function(){return!0},o=!_e(function(){return i(Object.preventExtensions({}))}),r=function(e){n(e,t,{value:{i:'O'+ ++a,w:{}}})},s=e.exports={KEY:t,NEED:!1,fastKey:function(e,n){if(!be(e))return'symbol'==typeof e?e:('string'==typeof e?'S':'P')+e;if(!Me(e,t)){if(!i(e))return'F';if(!n)return'E';r(e)}return e[t].i},getWeak:function(e,n){if(!Me(e,t)){if(!i(e))return!0;if(!n)return!1;r(e)}return e[t].w},onFreeze:function(e){return o&&s.NEED&&i(e)&&!Me(e,t)&&r(e),e}}}),_a=xa.KEY,Ea=xa.NEED,wa=xa.fastKey,Sa=xa.getWeak,Ca=xa.onFreeze,Ra=function(e,t){var n=(le.Object||{})[e]||Object[e],a={};a[e]=t(n),je(je.S+je.F*_e(function(){n(1)}),'Object',a)},Ta=xa.onFreeze;Ra('freeze',function(e){return function(t){return e&&be(t)?e(Ta(t)):t}});var Oa=le.Object.freeze,La=a(function(e){e.exports={default:Oa,__esModule:!0}}),Na=n(La),Ia={}.propertyIsEnumerable,Aa={f:Ia},Pa=Object.getOwnPropertyDescriptor,Ba=Ee?Pa:function(e,t){if(e=Ue(e),t=Te(t,!0),Re)try{return Pa(e,t)}catch(t){}return Me(e,t)?Ie(!Aa.f.call(e,t),e[t]):void 0},ja={f:Ba},Da=ja.f;Ra('getOwnPropertyDescriptor',function(){return function(e,t){return Da(Ue(e),t)}});var za=le.Object,Ma=function(e,t){return za.getOwnPropertyDescriptor(e,t)},qa=a(function(e){e.exports={default:Ma,__esModule:!0}}),Fa=n(qa),Wa=it.concat('length','prototype'),Ha=Object.getOwnPropertyNames||function(e){return at(e,Wa)},Ua={f:Ha},Ya=Ua.f,Va={}.toString,Ga='object'==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],Ka=function(e){try{return Ya(e)}catch(t){return Ga.slice()}},Xa={f:function(e){return Ga&&'[object Window]'==Va.call(e)?Ka(e):Ya(Ue(e))}};Ra('getOwnPropertyNames',function(){return Xa.f});var $a=le.Object,Za=function(e){return $a.getOwnPropertyNames(e)},Ja=a(function(e){e.exports={default:Za,__esModule:!0}}),Qa=n(Ja),ei='undefined'!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame),ti=1,ni=3,ai='undefined'==typeof URL?'undefined'==typeof window?void 0:window.URL||window.webkitURL||window.mozURL:URL,ii=function(){function e(){Xn(this,e),this.collapsed=!1,this.commonAncestorContainer=void 0,this.endContainer=void 0,this.endOffset=void 0,this.startContainer=void 0,this.startOffset=void 0}return ta(e,[{key:'setStart',value:function(e,t){this.startContainer=e,this.startOffset=t,this.endContainer?this.commonAncestorContainer=this._commonAncestorContainer():this.collapse(!0),this._checkCollapsed()}},{key:'setEnd',value:function(e,t){this.endContainer=e,this.endOffset=t,this.startContainer?(this.collapsed=!1,this.commonAncestorContainer=this._commonAncestorContainer()):this.collapse(!1),this._checkCollapsed()}},{key:'collapse',value:function(e){this.collapsed=!0,e?(this.endContainer=this.startContainer,this.endOffset=this.startOffset,this.commonAncestorContainer=this.startContainer.parentNode):(this.startContainer=this.endContainer,this.startOffset=this.endOffset,this.commonAncestorContainer=this.endOffset.parentNode)}},{key:'selectNode',value:function(e){var t=e.parentNode,n=Array.prototype.indexOf.call(t.childNodes,e);this.setStart(t,n),this.setEnd(t,n+1)}},{key:'selectNodeContents',value:function(e){var t=3===e.nodeType?e.textContent.length:parent.childNodes.length;this.setStart(e,0),this.setEnd(e,t)}},{key:'_commonAncestorContainer',value:function(e,t){var n=z(e||this.startContainer),a=z(t||this.endContainer);if(n[0]==a[0])for(var o=0;o<n.length;o++)if(n[o]!=a[o])return n[o-1]}},{key:'_checkCollapsed',value:function(){this.collapsed=this.startContainer===this.endContainer&&this.startOffset===this.endOffset}},{key:'toString',value:function(){}}]),e}(),oi=Object.freeze({requestAnimationFrame:ei,ELEMENT_NODE:ti,TEXT_NODE:ni,COMMENT_NODE:8,DOCUMENT_NODE:9,_URL:ai,uuid:o,documentHeight:function(){return ae(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)},isElement:r,isNumber:s,isFloat:l,prefixed:d,defaults:c,extend:p,insert:function(e,t,n){var a=u(e,t,n);return t.splice(a,0,e),a},locationOf:u,indexOfSorted:h,bounds:m,borders:y,windowBounds:v,indexOfNode:k,indexOfTextNode:function(e){return k(e,ni)},indexOfElementNode:b,isXml:x,createBlob:_,createBlobUrl:E,revokeBlobUrl:w,createBase64Url:S,type:C,parse:R,qs:T,qsa:O,qsp:L,sprint:N,treeWalker:I,walk:A,blob2base64:P,defer:B,querySelectorByType:j,findChildren:D,parents:z,filterChildren:M,getParentByTagName:q,nextSection:F,prevSection:W,serialize:H,RangeObject:ii});if(!ri)var ri={cwd:function(){return'/'}};var si={resolve:function(){for(var e='',t=!1,n=arguments.length-1,a;-1<=n&&!t;n--){var i;(0<=n?i=arguments[n]:(void 0===a&&(a=ri.cwd()),i=a),U(i),0!==i.length)&&(e=i+'/'+e,t=47===i.charCodeAt(0))}return e=Y(e,!t),t?0<e.length?'/'+e:'/':0<e.length?e:'.'},normalize:function(e){if(U(e),0===e.length)return'.';var t=47===e.charCodeAt(0),n=47===e.charCodeAt(e.length-1);return e=Y(e,!t),0!==e.length||t||(e='.'),0<e.length&&n&&(e+='/'),t?'/'+e:e},isAbsolute:function(e){return U(e),0<e.length&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return'.';for(var e=0,t,n;e<arguments.length;++e)n=arguments[e],U(n),0<n.length&&(void 0===t?t=n:t+='/'+n);return void 0===t?'.':si.normalize(t)},relative:function(e,t){if(U(e),U(t),e===t)return'';if(e=si.resolve(e),t=si.resolve(t),e===t)return'';for(var n=1;n<e.length&&47===e.charCodeAt(n);++n);for(var a=e.length,o=a-n,r=1;r<t.length&&47===t.charCodeAt(r);++r);for(var s=t.length,l=s-r,d=o<l?o:l,c=-1,p=0;p<=d;++p){if(p===d){if(l>d){if(47===t.charCodeAt(r+p))return t.slice(r+p+1);if(0==p)return t.slice(r+p)}else o>d&&(47===e.charCodeAt(n+p)?c=p:0===p&&(c=0));break}var i=e.charCodeAt(n+p),u=t.charCodeAt(r+p);if(i!==u)break;else 47===i&&(c=p)}var h='';for(p=n+c+1;p<=a;++p)(p===a||47===e.charCodeAt(p))&&(h+=0===h.length?'..':'/..');return 0<h.length?h+t.slice(r+c):(r+=c,47===t.charCodeAt(r)&&++r,t.slice(r))},_makeLong:function(e){return e},dirname:function(e){if(U(e),0===e.length)return'.';for(var t=e.charCodeAt(0),n=47===t,a=-1,o=!0,r=e.length-1;1<=r;--r)if(t=e.charCodeAt(r),47!==t)o=!1;else if(!o){a=r;break}return-1===a?n?'/':'.':n&&1===a?'//':e.slice(0,a)},basename:function(e,t){if(void 0!==t&&'string'!=typeof t)throw new TypeError('\"ext\" argument must be a string');U(e);var n=0,a=-1,o=!0,r;if(void 0!==t&&0<t.length&&t.length<=e.length){if(t.length===e.length&&t===e)return'';var i=t.length-1,s=-1;for(r=e.length-1;0<=r;--r){var l=e.charCodeAt(r);if(47!==l)-1==s&&(o=!1,s=r+1),0<=i&&(l===t.charCodeAt(i)?-1==--i&&(a=r):(i=-1,a=s));else if(!o){n=r+1;break}}return n===a?a=s:-1===a&&(a=e.length),e.slice(n,a)}for(r=e.length-1;0<=r;--r)if(47!==e.charCodeAt(r))-1===a&&(o=!1,a=r+1);else if(!o){n=r+1;break}return-1===a?'':e.slice(n,a)},extname:function(e){U(e);for(var t=-1,n=0,a=-1,o=!0,r=0,s=e.length-1,i;0<=s;--s){if(i=e.charCodeAt(s),47===i){if(!o){n=s+1;break}continue}-1==a&&(o=!1,a=s+1),46===i?-1===t?t=s:1!=r&&(r=1):-1!==t&&(r=-1)}return-1===t||-1===a||0==r||1==r&&t===a-1&&t===n+1?'':e.slice(t,a)},format:function(e){if(null===e||'object'!=typeof e)throw new TypeError('Parameter \"pathObject\" must be an object, not '+typeof e);return V('/',e)},parse:function(e){U(e);var t={root:'',dir:'',base:'',ext:'',name:''};if(0===e.length)return t;var n=e.charCodeAt(0),a=47===n,o;a?(t.root='/',o=1):o=0;for(var r=-1,s=0,l=-1,d=!0,c=e.length-1,i=0;c>=o;--c){if(n=e.charCodeAt(c),47===n){if(!d){s=c+1;break}continue}-1==l&&(d=!1,l=c+1),46===n?-1==r?r=c:1!=i&&(i=1):-1!=r&&(i=-1)}return-1==r||-1==l||0==i||1==i&&r==l-1&&r==s+1?-1!=l&&(0==s&&a?t.base=t.name=e.slice(1,l):t.base=t.name=e.slice(s,l)):(0==s&&a?(t.name=e.slice(1,r),t.base=e.slice(1,l)):(t.name=e.slice(s,r),t.base=e.slice(s,l)),t.ext=e.slice(r,l)),0<s?t.dir=e.slice(0,s-1):a&&(t.dir='/'),t},sep:'/',delimiter:':',posix:null},li=si,di=function(){function e(t){Xn(this,e);var n,a;n=t.indexOf('://'),-1<n&&(t=new URL(t).pathname),a=this.parse(t),this.path=t,this.directory=this.isDirectory(t)?t:a.dir+'/',this.filename=a.base,this.extension=a.ext.slice(1)}return ta(e,[{key:'parse',value:function(e){return li.parse(e)}},{key:'isAbsolute',value:function(e){return li.isAbsolute(e||this.path)}},{key:'isDirectory',value:function(e){return'/'===e.charAt(e.length-1)}},{key:'resolve',value:function(e){return li.resolve(this.directory,e)}},{key:'relative',value:function(e){return li.relative(this.directory,e)}},{key:'splitPath',value:function(e){return this.splitPathRe.exec(e).slice(1)}},{key:'toString',value:function(){return this.path}}]),e}(),ci=function(){function e(t,n){Xn(this,e);var a=-1<t.indexOf('://'),i=t,o;if(this.Url=void 0,this.href=t,this.protocol='',this.origin='',this.hash='',this.hash='',this.search='',this.base=n,a||!1===n||'string'==typeof n||'undefined'==typeof window||'undefined'==typeof window.location||(this.base=window.location.href),a||this.base)try{this.Url=this.base?new URL(t,this.base):new URL(t),this.href=this.Url.href,this.protocol=this.Url.protocol,this.origin=this.Url.origin,this.hash=this.Url.hash,this.search=this.Url.search,i=this.Url.pathname}catch(t){this.Url=void 0,this.base&&(o=new di(this.base),i=o.resolve(i))}this.Path=new di(i),this.directory=this.Path.directory,this.filename=this.Path.filename,this.extension=this.Path.extension}return ta(e,[{key:'path',value:function(){return this.Path}},{key:'resolve',value:function(e){var t=-1<e.indexOf('://'),n;return t?e:(n=li.resolve(this.directory,e),this.origin+n)}},{key:'relative',value:function(e){return li.relative(e,this.directory)}},{key:'toString',value:function(){return this.href}}]),e}(),pi={f:ht},ui=pi.f('iterator'),hi=a(function(e){e.exports={default:ui,__esModule:!0}});n(hi);var gi=Ne.f,mi=function(e){var t=le.Symbol||(le.Symbol={});'_'==e.charAt(0)||e in t||gi(t,e,{value:pi.f(e)})},yi=function(e,t){for(var n=Ue(e),a=ot(n),i=a.length,o=0,r;i>o;)if(n[r=a[o++]]===t)return r},fi=Object.getOwnPropertySymbols,vi={f:fi},ki=function(e){var t=ot(e),n=vi.f;if(n)for(var a=n(e),o=Aa.f,r=0,i;a.length>r;)o.call(e,i=a[r++])&&t.push(i);return t},bi=Array.isArray||function(e){return'Array'==We(e)},xi=xa.KEY,_i=ja.f,Ei=Ne.f,wi=Xa.f,Si=fe.Symbol,Ci=fe.JSON,Ri=Ci&&Ci.stringify,Ti='prototype',Oi=ht('_hidden'),Li=ht('toPrimitive'),Ni={}.propertyIsEnumerable,Ii=Xe('symbol-registry'),Ai=Xe('symbols'),Pi=Xe('op-symbols'),Bi=Object[Ti],ji='function'==typeof Si,Di=fe.QObject,zi=!Di||!Di[Ti]||!Di[Ti].findChild,Mi=Ee&&_e(function(){return 7!=ut(Ei({},'a',{get:function(){return Ei(this,'a',{value:7}).a}})).a})?function(e,t,n){var a=_i(Bi,t);a&&delete Bi[t],Ei(e,t,n),a&&e!==Bi&&Ei(Bi,t,a)}:Ei,qi=function(e){var t=Ai[e]=ut(Si[Ti]);return t._k=e,t},Fi=ji&&'symbol'==typeof Si.iterator?function(e){return'symbol'==typeof e}:function(e){return e instanceof Si},Wi=function(e,t,n){return e===Bi&&Wi(Pi,t,n),xe(e),t=Te(t,!0),xe(n),Me(Ai,t)?(n.enumerable?(Me(e,Oi)&&e[Oi][t]&&(e[Oi][t]=!1),n=ut(n,{enumerable:Ie(0,!1)})):(!Me(e,Oi)&&Ei(e,Oi,Ie(1,{})),e[Oi][t]=!0),Mi(e,t,n)):Ei(e,t,n)},Hi=function(e,t){xe(e);for(var n=ki(t=Ue(t)),a=0,i=n.length,o;i>a;)Wi(e,o=n[a++],t[o]);return e},Ui=function(e,t){if(e=Ue(e),t=Te(t,!0),e!==Bi||!Me(Ai,t)||Me(Pi,t)){var n=_i(e,t);return n&&Me(Ai,t)&&!(Me(e,Oi)&&e[Oi][t])&&(n.enumerable=!0),n}},Yi=function(e){for(var t=wi(Ue(e)),n=[],a=0,i;t.length>a;)Me(Ai,i=t[a++])||i==Oi||i==xi||n.push(i);return n},Vi=function(e){for(var t=e===Bi,n=wi(t?Pi:Ue(e)),a=[],o=0,i;n.length>o;)Me(Ai,i=n[o++])&&(!t||Me(Bi,i))&&a.push(Ai[i]);return a};ji||(Si=function(){if(this instanceof Si)throw TypeError('Symbol is not a constructor!');var e=Je(0<arguments.length?arguments[0]:void 0),t=function(n){this===Bi&&t.call(Pi,n),Me(this,Oi)&&Me(this[Oi],e)&&(this[Oi][e]=!1),Mi(this,e,Ie(1,n))};return Ee&&zi&&Mi(Bi,e,{configurable:!0,set:t}),qi(e)},De(Si[Ti],'toString',function(){return this._k}),ja.f=Ui,Ne.f=Wi,Ua.f=Xa.f=Yi,Aa.f=function(e){var t=Ni.call(this,e=Te(e,!0));return(this!==Bi||!Me(Ai,e)||Me(Pi,e))&&(!(t||!Me(this,e)||!Me(Ai,e)||Me(this,Oi)&&this[Oi][e])||t)},vi.f=Vi,pi.f=function(e){return qi(ht(e))}),je(je.G+je.W+je.F*!ji,{Symbol:Si});for(var Gi=['hasInstance','isConcatSpreadable','iterator','match','replace','search','species','split','toPrimitive','toStringTag','unscopables'],Ki=0;Gi.length>Ki;)ht(Gi[Ki++]);for(var Gi=ot(ht.store),Ki=0;Gi.length>Ki;)mi(Gi[Ki++]);je(je.S+je.F*!ji,'Symbol',{for:function(e){return Me(Ii,e+='')?Ii[e]:Ii[e]=Si(e)},keyFor:function(e){if(Fi(e))return yi(Ii,e);throw TypeError(e+' is not a symbol!')},useSetter:function(){zi=!0},useSimple:function(){zi=!1}}),je(je.S+je.F*!ji,'Object',{create:function(e,t){return void 0===t?ut(e):Hi(ut(e),t)},defineProperty:Wi,defineProperties:Hi,getOwnPropertyDescriptor:Ui,getOwnPropertyNames:Yi,getOwnPropertySymbols:Vi}),Ci&&je(je.S+je.F*(!ji||_e(function(){var e=Si();return'[null]'!=Ri([e])||'{}'!=Ri({a:e})||'{}'!=Ri(Object(e))})),'JSON',{stringify:function(e){if(!(void 0===e||Fi(e))){for(var t=[e],n=1,a,i;arguments.length>n;)t.push(arguments[n++]);return a=t[1],'function'==typeof a&&(i=a),(i||!bi(a))&&(a=function(e,t){if(i&&(t=i.call(this,e,t)),!Fi(t))return t}),t[1]=a,Ri.apply(Ci,t)}}}),Si[Ti][Li]||Ae(Si[Ti],Li,Si[Ti].valueOf),yt(Si,'Symbol'),yt(Math,'Math',!0),yt(fe.JSON,'JSON',!0),mi('asyncIterator'),mi('observable');var Xi=le.Symbol,$i=a(function(e){e.exports={default:Xi,__esModule:!0}});n($i);var Zi=a(function(e,t){function n(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var a=n(hi),i=n($i),o='function'==typeof i.default&&'symbol'==typeof a.default?function(e){return typeof e}:function(e){return e&&'function'==typeof i.default&&e.constructor===i.default&&e!==i.default.prototype?'symbol':typeof e};t.default='function'==typeof i.default&&'symbol'===o(a.default)?function(e){return'undefined'==typeof e?'undefined':o(e)}:function(e){return e&&'function'==typeof i.default&&e.constructor===i.default&&e!==i.default.prototype?'symbol':'undefined'==typeof e?'undefined':o(e)}}),Ji=n(Zi),Qi=1,eo=3,to=function(){function e(t,n,a){Xn(this,e);var i;if(this.str='',this.base={},this.spinePos=0,this.range=!1,this.path={},this.start=null,this.end=null,!(this instanceof e))return new e(t,n,a);if('string'==typeof n?this.base=this.parseComponent(n):'object'===('undefined'==typeof n?'undefined':Ji(n))&&n.steps&&(this.base=n),i=this.checkType(t),'string'===i)return this.str=t,p(this,this.parse(t));if('range'===i)return p(this,this.fromRange(t,this.base,a));if('node'===i)return p(this,this.fromNode(t,this.base,a));if('EpubCFI'===i&&t.path)return t;if(!t)return this;throw new TypeError('not a valid argument for EpubCFI')}return ta(e,[{key:'checkType',value:function(t){return this.isCfiString(t)?'string':'object'===('undefined'==typeof t?'undefined':Ji(t))&&('Range'===C(t)||'undefined'!=typeof t.startContainer)?'range':'object'===('undefined'==typeof t?'undefined':Ji(t))&&'undefined'!=typeof t.nodeType?'node':!!('object'===('undefined'==typeof t?'undefined':Ji(t))&&t instanceof e)&&'EpubCFI'}},{key:'parse',value:function(e){var t={spinePos:-1,range:!1,base:{},path:{},start:null,end:null},n,a,i;return'string'==typeof e?(0===e.indexOf('epubcfi(')&&')'===e[e.length-1]&&(e=e.slice(8,e.length-1)),n=this.getChapterComponent(e),!n)?{spinePos:-1}:(t.base=this.parseComponent(n),a=this.getPathComponent(e),t.path=this.parseComponent(a),i=this.getRange(e),i&&(t.range=!0,t.start=this.parseComponent(i[0]),t.end=this.parseComponent(i[1])),!t.base.steps||2>t.base.steps.length)?{spinePos:-1}:(t.spinePos=t.base.steps[1].index,t):{spinePos:-1}}},{key:'parseComponent',value:function(e){var t={steps:[],terminal:{offset:null,assertion:null}},n=e.split(':'),a=n[0].split('/'),i;return 1<n.length&&(i=n[1],t.terminal=this.parseTerminal(i)),''===a[0]&&a.shift(),t.steps=a.map(function(e){return this.parseStep(e)}.bind(this)),t}},{key:'parseStep',value:function(e){var t,n,a,i,o;if(i=e.match(/\\[(.*)\\]/),i&&i[1]&&(o=i[1]),n=parseInt(e),!isNaN(n))return 0==n%2?(t='element',a=n/2-1):(t='text',a=(n-1)/2),{type:t,index:a,id:o||null}}},{key:'parseTerminal',value:function(e){var t=e.match(/\\[(.*)\\]/),n,a;return t&&t[1]?(n=parseInt(e.split('[')[0]),a=t[1]):n=parseInt(e),s(n)||(n=null),{offset:n,assertion:a}}},{key:'getChapterComponent',value:function(e){var t=e.split('!');return t[0]}},{key:'getPathComponent',value:function(e){var t=e.split('!');if(t[1]){var n=t[1].split(',');return n[0]}}},{key:'getRange',value:function(e){var t=e.split(',');return 3===t.length&&[t[1],t[2]]}},{key:'getCharecterOffsetComponent',value:function(e){var t=e.split(':');return t[1]||''}},{key:'joinSteps',value:function(e){return e?e.map(function(e){var t='';return'element'===e.type&&(t+=2*(e.index+1)),'text'===e.type&&(t+=1+2*e.index),e.id&&(t+='['+e.id+']'),t}).join('/'):''}},{key:'segmentString',value:function(e){var t='/';return t+=this.joinSteps(e.steps),e.terminal&&null!=e.terminal.offset&&(t+=':'+e.terminal.offset),e.terminal&&null!=e.terminal.assertion&&(t+='['+e.terminal.assertion+']'),t}},{key:'toString',value:function(){var e='epubcfi(';return e+=this.segmentString(this.base),e+='!',e+=this.segmentString(this.path),this.range&&this.start&&(e+=',',e+=this.segmentString(this.start)),this.range&&this.end&&(e+=',',e+=this.segmentString(this.end)),e+=')',e}},{key:'compare',value:function(t,n){var a,o,r,s;if('string'==typeof t&&(t=new e(t)),'string'==typeof n&&(n=new e(n)),t.spinePos>n.spinePos)return 1;if(t.spinePos<n.spinePos)return-1;t.range?(a=t.path.steps.concat(t.start.steps),r=t.start.terminal):(a=t.path.steps,r=t.path.terminal),n.range?(o=n.path.steps.concat(n.start.steps),s=n.start.terminal):(o=n.path.steps,s=n.path.terminal);for(var l=0;l<a.length;l++){if(!a[l])return-1;if(!o[l])return 1;if(a[l].index>o[l].index)return 1;if(a[l].index<o[l].index)return-1}return a.length<o.length?1:r.offset>s.offset?1:r.offset<s.offset?-1:0}},{key:'step',value:function(e){var t=e.nodeType===eo?'text':'element';return{id:e.id,tagName:e.tagName,type:t,index:this.position(e)}}},{key:'filteredStep',value:function(e,t){var n=this.filter(e,t),a;if(n)return a=n.nodeType===eo?'text':'element',{id:n.id,tagName:n.tagName,type:a,index:this.filteredPosition(n,t)}}},{key:'pathTo',value:function(e,t,n){for(var a={steps:[],terminal:{offset:null,assertion:null}},i=e,o;i&&i.parentNode&&i.parentNode.nodeType!=9;)o=n?this.filteredStep(i,n):this.step(i),o&&a.steps.unshift(o),i=i.parentNode;return null!=t&&0<=t&&(a.terminal.offset=t,'text'!=a.steps[a.steps.length-1].type&&a.steps.push({type:'text',index:0})),a}},{key:'equalStep',value:function(e,t){return!!(e&&t)&&e.index===t.index&&e.id===t.id&&e.type===t.type}},{key:'fromRange',value:function(e,t,n){var a={range:!1,base:{},path:{},start:null,end:null},o=e.startContainer,r=e.endContainer,s=e.startOffset,l=e.endOffset,d=!1;if(n&&(d=null!=o.ownerDocument.querySelector('.'+n)),'string'==typeof t?(a.base=this.parseComponent(t),a.spinePos=a.base.steps[1].index):'object'===('undefined'==typeof t?'undefined':Ji(t))&&(a.base=t),e.collapsed)d&&(s=this.patchOffset(o,s,n)),a.path=this.pathTo(o,s,n);else{a.range=!0,d&&(s=this.patchOffset(o,s,n)),a.start=this.pathTo(o,s,n),d&&(l=this.patchOffset(r,l,n)),a.end=this.pathTo(r,l,n),a.path={steps:[],terminal:null};var c=a.start.steps.length,p;for(p=0;p<c&&this.equalStep(a.start.steps[p],a.end.steps[p]);p++)p===c-1?a.start.terminal===a.end.terminal&&(a.path.steps.push(a.start.steps[p]),a.range=!1):a.path.steps.push(a.start.steps[p]);a.start.steps=a.start.steps.slice(a.path.steps.length),a.end.steps=a.end.steps.slice(a.path.steps.length)}return a}},{key:'fromNode',value:function(e,t,n){var a={range:!1,base:{},path:{},start:null,end:null};return'string'==typeof t?(a.base=this.parseComponent(t),a.spinePos=a.base.steps[1].index):'object'===('undefined'==typeof t?'undefined':Ji(t))&&(a.base=t),a.path=this.pathTo(e,null,n),a}},{key:'filter',value:function(e,t){var n=!1,a,i,o,r,s;return e.nodeType===eo?(n=!0,o=e.parentNode,a=e.parentNode.classList.contains(t)):(n=!1,a=e.classList.contains(t)),a&&n?(r=o.previousSibling,s=o.nextSibling,r&&r.nodeType===eo?i=r:s&&s.nodeType===eo&&(i=s),i?i:e):(!a||n)&&e}},{key:'patchOffset',value:function(e,t,n){if(e.nodeType!=eo)throw new Error('Anchor must be a text node');var a=e,i=t;for(e.parentNode.classList.contains(n)&&(a=e.parentNode);a.previousSibling;){if(a.previousSibling.nodeType!==Qi)i+=a.previousSibling.textContent.length;else if(a.previousSibling.classList.contains(n))i+=a.previousSibling.textContent.length;else break;a=a.previousSibling}return i}},{key:'normalizedMap',value:function(e,t,n){var a={},o=-1,r=e.length,s,i,l;for(s=0;s<r;s++)i=e[s].nodeType,i===Qi&&e[s].classList.contains(n)&&(i=eo),0<s&&i===eo&&l===eo?a[s]=o:t===i&&(++o,a[s]=o),l=i;return a}},{key:'position',value:function(e){var t,n;return e.nodeType===Qi?(t=e.parentNode.children,!t&&(t=D(e.parentNode)),n=Array.prototype.indexOf.call(t,e)):(t=this.textNodes(e.parentNode),n=t.indexOf(e)),n}},{key:'filteredPosition',value:function(e,t){var n,a,i;return e.nodeType===Qi?(n=e.parentNode.children,i=this.normalizedMap(n,Qi,t)):(n=e.parentNode.childNodes,e.parentNode.classList.contains(t)&&(e=e.parentNode,n=e.parentNode.childNodes),i=this.normalizedMap(n,eo,t)),a=Array.prototype.indexOf.call(n,e),i[a]}},{key:'stepsToXpath',value:function(e){var t=['.','*'];return e.forEach(function(e){var n=e.index+1;e.id?t.push('*[position()='+n+' and @id=\\''+e.id+'\\']'):'text'===e.type?t.push('text()['+n+']'):t.push('*['+n+']')}),t.join('/')}},{key:'stepsToQuerySelector',value:function(e){var t=['html'];return e.forEach(function(e){var n=e.index+1;e.id?t.push('#'+e.id):'text'===e.type||t.push('*:nth-child('+n+')')}),t.join('>')}},{key:'textNodes',value:function(e,t){return Array.prototype.slice.call(e.childNodes).filter(function(e){return e.nodeType===eo||!!(t&&e.classList.contains(t))})}},{key:'walkToNode',value:function(e,t,n){var a=t||document,o=a.documentElement,r=e.length,s,l,d;for(d=0;d<r&&(l=e[d],'element'===l.type?l.id?o=a.getElementById(l.id):(s=o.children||D(o),o=s[l.index]):'text'===l.type&&(o=this.textNodes(o,n)[l.index]),!!o);d++);return o}},{key:'findNode',value:function(e,t,n){var a=t||document,i,o;return n||'undefined'==typeof a.evaluate?n?i=this.walkToNode(e,a,n):i=this.walkToNode(e,a):(o=this.stepsToXpath(e),i=a.evaluate(o,a,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue),i}},{key:'fixMiss',value:function(e,t,n,a){var i=this.findNode(e.slice(0,-1),n,a),o=i.childNodes,r=this.normalizedMap(o,eo,a),s=e[e.length-1].index,l,d;for(var c in r){if(!r.hasOwnProperty(c))return;if(r[c]===s)if(l=o[c],d=l.textContent.length,t>d)t-=d;else{i=l.nodeType===Qi?l.childNodes[0]:l;break}}return{container:i,offset:t}}},{key:'toRange',value:function(e,t){var n=e||document,a=this,i=!!t&&null!=n.querySelector('.'+t),o,r,s,l,d,c,p,u;if(o='undefined'==typeof n.createRange?new ii:n.createRange(),a.range?(r=a.start,c=a.path.steps.concat(r.steps),l=this.findNode(c,n,i?t:null),s=a.end,p=a.path.steps.concat(s.steps),d=this.findNode(p,n,i?t:null)):(r=a.path,c=a.path.steps,l=this.findNode(a.path.steps,n,i?t:null)),l)try{null==r.terminal.offset?o.setStart(l,0):o.setStart(l,r.terminal.offset)}catch(a){u=this.fixMiss(c,r.terminal.offset,n,i?t:null),o.setStart(u.container,u.offset)}else return console.log('No startContainer found for',this.toString()),null;if(d)try{null==s.terminal.offset?o.setEnd(d,0):o.setEnd(d,s.terminal.offset)}catch(r){u=this.fixMiss(p,a.end.terminal.offset,n,i?t:null),o.setEnd(u.container,u.offset)}return o}},{key:'isCfiString',value:function(e){return'string'==typeof e&&0===e.indexOf('epubcfi(')&&')'===e[e.length-1]}},{key:'generateChapterComponent',value:function(e,t,n){var a=parseInt(t),i='/'+2*(e+1)+'/';return i+=2*(a+1),n&&(i+='['+n+']'),i}},{key:'collapse',value:function(e){this.range&&(this.range=!1,e?(this.path.steps=this.path.steps.concat(this.start.steps),this.path.terminal=this.start.terminal):(this.path.steps=this.path.steps.concat(this.end.steps),this.path.terminal=this.end.terminal))}}]),e}(),no=function(){function e(t){Xn(this,e),this.context=t||this,this.hooks=[]}return ta(e,[{key:'register',value:function(){for(var e=0;e<arguments.length;++e)if('function'==typeof arguments[e])this.hooks.push(arguments[e]);else for(var t=0;t<arguments[e].length;++t)this.hooks.push(arguments[e][t])}},{key:'trigger',value:function(){var e=arguments,t=this.context,n=[];return this.hooks.forEach(function(a){var i=a.apply(t,e);i&&'function'==typeof i.then&&n.push(i)}),Gn.all(n)}},{key:'list',value:function(){return this.hooks}},{key:'clear',value:function(){return this.hooks=[]}}]),e}(),ao=function(){function t(e,n,a){Xn(this,t),this.item=e,this.idref=e.idref,this.linear='yes'===e.linear,this.properties=e.properties,this.index=e.index,this.href=e.href,this.source=e.source,this.canonical=e.canonical,this.type=e.type,this.next=e.next,this.prev=e.prev,this.cfiBase=e.cfiBase,n?this.hooks=n:(this.hooks={},this.hooks.serialize=new no(this),this.hooks.content=new no(this)),this.document=void 0,this.contents=void 0,this.output=void 0,this.originalHref=void 0,this.settings=a||{}}return ta(t,[{key:'load',value:function(e){var t=e||this.request||Z,n=new B,a=n.promise;if(this.contents)n.resolve(this.contents);else{var i='application/xhtml+xml'===this.type?'xhtml':'html';t(this.href,i).then(function(e){return this.document=e,this.contents=e.documentElement,this.hooks.content.trigger(this.document,this)}.bind(this)).then(function(){n.resolve(this.contents)}.bind(this)).catch(function(e){n.reject(e)})}return a}},{key:'base',value:function(){return G(this.document,this)}},{key:'render',value:function(t){var n=new B,a=n.promise;return this.output,this.load(t).then(function(t){var n='undefined'!=typeof navigator&&navigator.userAgent||'',a=0<=n.indexOf('Trident'),i;i='undefined'==typeof XMLSerializer||a?e.XMLSerializer:XMLSerializer;var o=new i;return this.output=o.serializeToString(t),this.output}.bind(this)).then(function(){return this.hooks.serialize.trigger(this.output,this)}.bind(this)).then(function(){n.resolve(this.output)}.bind(this)).catch(function(e){n.reject(e)}),a}},{key:'find',value:function(e){var t=this,n=[],a=e.toLowerCase(),i=function(e){for(var i=e.textContent.toLowerCase(),o=t.document.createRange(),r=-1,s=150,l,d,c;-1!=d;)d=i.indexOf(a,r+1),-1!=d&&(o=t.document.createRange(),o.setStart(e,d),o.setEnd(e,d+a.length),l=t.cfiFromRange(o),e.textContent.length<s?c=e.textContent:(c=e.textContent.substring(d-s/2,d+s/2),c='...'+c+'...'),n.push({cfi:l,excerpt:c})),r=d};return N(t.document,function(e){i(e)}),n}},{key:'reconcileLayoutSettings',value:function(e){var t={layout:e.layout,spread:e.spread,orientation:e.orientation};return this.properties.forEach(function(e){var n=e.replace('rendition:',''),a=n.indexOf('-'),i,o;-1!=a&&(i=n.slice(0,a),o=n.slice(a+1),t[i]=o)}),t}},{key:'cfiFromRange',value:function(e){return new to(e,this.cfiBase).toString()}},{key:'cfiFromElement',value:function(e){return new to(e,this.cfiBase).toString()}},{key:'unload',value:function(){this.document=void 0,this.contents=void 0,this.output=void 0}},{key:'toObject',value:function(){return{idref:this.idref,linear:this.linear?'yes':'no',href:this.href,source:this.source,type:this.type,canonical:this.canonical,cfiBase:this.cfiBase}}},{key:'createUrl',value:function(e){var t=this,n=this.type;return this.render(e).then(function(e){return new Blob([e],{type:n})}).then(function(e){return t.settings.replacements&&'base64'===t.settings.replacements?P(e).then(function(e){return S(e,n)}):E(e,n)}).then(function(e){return t.originalHref=t.href,t.href=e,t.unload(),e})}},{key:'destroy',value:function(){this.unload(),this.hooks.serialize.clear(),this.hooks.content.clear(),this.originalHref&&w(this.href),this.hooks=void 0,this.idref=void 0,this.linear=void 0,this.properties=void 0,this.index=void 0,this.href=void 0,this.source=void 0,this.next=void 0,this.prev=void 0,this.cfiBase=void 0}}]),t}(),io=function(){function e(t){Xn(this,e),this.spineItems=[],this.spineByHref={},this.spineById={},this.hooks={},this.hooks.serialize=new no,this.hooks.content=new no,this.hooks.content.register(G),this.hooks.content.register(K),this.hooks.content.register(X),this.epubcfi=new to,this.loaded=!1,this.items=void 0,this.manifest=void 0,this.spineNodeIndex=void 0,this.baseUrl=void 0,this.length=void 0,t&&this.unpack(t)}return ta(e,[{key:'unpack',value:function(e){var t=this;this.items=e,this.length=this.items.length,this.items.forEach(function(e){'yes'===e.linear?(e.prev=function(){for(var t=e.index,n;0<t;){if(n=this.get(t-1),n&&n.linear)return n;t-=1}}.bind(t),e.next=function(){for(var t=e.index,n;t<this.spineItems.length-1;){if(n=this.get(t+1),n&&n.linear)return n;t+=1}}.bind(t)):(e.prev=function(){},e.next=function(){});var n=new ao(e,t.hooks);t.append(n)}),this.loaded=!0}},{key:'get',value:function(e){var t;if('undefined'==typeof e)for(;t<this.spineItems.length;){var n=this.spineItems[t];if(n&&n.linear)break;t+=1}else if(this.epubcfi.isCfiString(e)){var a=new to(e);t=a.spinePos}else'number'==typeof e||!1===isNaN(e)?t=e:'string'==typeof e&&0===e.indexOf('#')?t=this.spineById[e.substring(1)]:'string'==typeof e&&(e=e.split('#')[0],t=void 0===this.spineById[e]?void 0===this.spineById[e]?this.spineByHref[encodeURI(e)]:this.spineByHref[e]:this.spineById[e]);return void 0==t?void 0:this.spineItems[t]}},{key:'append',value:function(e){var t=this.spineItems.length;return e.index=t,this.spineItems.push(e),this.spineByHref[decodeURI(e.href)]=t,this.spineByHref[encodeURI(e.href)]=t,this.spineByHref[e.href]=t,e.source&&(this.spineByHref[e.source]=t),this.spineById[e.idref]=t,t}},{key:'prepend',value:function(e){return this.spineByHref[e.href]=0,this.spineById[e.idref]=0,this.spineItems.forEach(function(e,t){e.index=t}),0}},{key:'remove',value:function(e){var t=this.spineItems.indexOf(e);if(-1<t)return delete this.spineByHref[e.href],delete this.spineById[e.idref],this.spineItems.splice(t,1)}},{key:'each',value:function(){return this.spineItems.forEach.apply(this.spineItems,arguments)}},{key:'map',value:function(){return this.spineItems.map.apply(this.spineItems,arguments)}},{key:'first',value:function(){var e=0;do{var t=this.get(e);if(t&&t.linear)return t;e+=1}while(e<this.spineItems.length)}},{key:'last',value:function(){var e=this.spineItems.length-1;do{var t=this.get(e);if(t&&t.linear)return t;e-=1}while(0<=e)}},{key:'toArray',value:function(){return this.spineItems.map(function(e){return e.toObject()})}},{key:'toJSON',value:function(){return he(this.toArray())}},{key:'destroy',value:function(){this.each(function(e){return e.destroy()}),this.spineItems=void 0,this.spineByHref=void 0,this.spineById=void 0,this.hooks.serialize.clear(),this.hooks.content.clear(),this.hooks=void 0,this.epubcfi=void 0,this.loaded=!1,this.items=void 0,this.manifest=void 0,this.spineNodeIndex=void 0,this.baseUrl=void 0,this.length=void 0}}]),e}(),oo=function(){function e(t){Xn(this,e),this._q=[],this.context=t,this.tick=ei,this.running=!1,this.paused=!1}return ta(e,[{key:'enqueue',value:function(){var e=[].shift.call(arguments),t=arguments,n,a,i;if(!e)throw new Error('No Task Provided');return'function'==typeof e?(n=new B,a=n.promise,i={task:e,args:t,deferred:n,promise:a}):i={promise:e},this._q.push(i),!1!=this.paused||this.running||this.run(),i.promise}},{key:'dequeue',value:function(){var e,t,n;if(this._q.length&&!this.paused){if(e=this._q.shift(),t=e.task,t)return n=t.apply(this.context,e.args),n&&'function'==typeof n.then?n.then(function(){e.deferred.resolve.apply(this.context,arguments)}.bind(this),function(){e.deferred.reject.apply(this.context,arguments)}.bind(this)):(e.deferred.resolve.apply(this.context,n),e.promise);if(e.promise)return e.promise}else return e=new B,e.deferred.resolve(),e.promise}},{key:'dump',value:function(){for(;this._q.length;)this.dequeue()}},{key:'run',value:function(){var e=this;return this.running||(this.running=!0,this.defered=new B),this.tick.call(window,function(){e._q.length?e.dequeue().then(function(){this.run()}.bind(e)):(e.defered.resolve(),e.running=void 0)}),!0==this.paused&&(this.paused=!1),this.defered.promise}},{key:'flush',value:function(){return this.running?this.running:this._q.length?(this.running=this.dequeue().then(function(){return this.running=void 0,this.flush()}.bind(this)),this.running):void 0}},{key:'clear',value:function(){this._q=[]}},{key:'length',value:function(){return this._q.length}},{key:'pause',value:function(){this.paused=!0}},{key:'stop',value:function(){this._q=[],this.running=!1,this.paused=!0}}]),e}(),ro='0.4',so=['keydown','keyup','keypressed','mouseup','mousedown','click','touchend','touchstart'],lo={BOOK:{OPEN_FAILED:'openFailed',READY:'ready'},CONTENTS:{EXPAND:'expand',RESIZE:'resize',SELECTED:'selected',SELECTED_RANGE:'selectedRange',LINK_CLICKED:'linkClicked'},LOCATIONS:{CHANGED:'changed'},MANAGERS:{RESIZE:'resize',RESIZED:'resized',ORIENTATION_CHANGE:'orientationchange',ADDED:'added',SCROLL:'scroll',SCROLLED:'scrolled'},VIEWS:{AXIS:'axis',LOAD_ERROR:'loaderror',RENDERED:'rendered',RESIZED:'resized',DISPLAYED:'displayed',SHOWN:'shown',HIDDEN:'hidden',MARK_CLICKED:'markClicked'},RENDITION:{STARTED:'started',ATTACHED:'attached',DISPLAYED:'displayed',DISPLAY_ERROR:'displayerror',RENDERED:'rendered',REMOVED:'removed',RESIZED:'resized',ORIENTATION_CHANGE:'orientationchange',LOCATION_CHANGED:'locationChanged',RELOCATED:'relocated',MARK_CLICKED:'markClicked',SELECTED:'selected',LAYOUT:'layout',WORKER_FAILED:'workerFailed',WORKER_INACTIVE:'workerInactive'},LAYOUT:{UPDATED:'updated'}},co=function(){function e(t){Xn(this,e),t&&this.unpack(t)}return ta(e,[{key:'unpack',value:function(e){e.locations&&this.unpackLocations(e.locations),e.pages&&this.unpackPages(e.page)}},{key:'unpackLocations',value:function(e){this.locations=e,this.totalLocations=this.locations.length-1}},{key:'unpackPages',value:function(e){var t=this;this.pages=e,this.firstPage=parseInt(this.pages[0]),this.lastPage=parseInt(this.pages[this.pages.length-1]),this.totalPages=this.lastPage-this.firstPage,e.forEach(function(e){e.cfi&&t.pageLocations.push(e.cfi)})}},{key:'locationFromCfi',value:function(e){var t;return(to.prototype.isCfiString(e)&&(e=new to(e)),0===this.locations.length)?-1:(t=u(e,this.locations,to.prototype.compare),t>this.totalLocations?this.totalLocations:t)}},{key:'percentageFromCfi',value:function(e){if(0===this.locations.length)return null;var t=this.locationFromCfi(e);return this.percentageFromLocation(t)}},{key:'percentageFromLocation',value:function(e){return e&&this.totalLocations?e/this.totalLocations:0}},{key:'cfiFromLocation',value:function(e){var t=-1;return'number'!=typeof e&&(e=parseInt(e)),0<=e&&e<this.locations.length&&(t=this.locations[e]),t}},{key:'cfiFromPercentage',value:function(e){var t;if(1<e&&console.warn('Normalize cfiFromPercentage value to between 0 - 1'),1<=e){var n=new to(this.locations[this.totalLocations]);return n.collapse(),n.toString()}return t=re(this.totalLocations*e),this.cfiFromLocation(t)}},{key:'pageFromCfi',value:function(e){var t=-1;if(!this.pageLocations||0===this.pageLocations.length)return-1;var n=indexOfSorted(e,this.pageLocations,to.prototype.compare);return-1==n?(n=u(e,this.pageLocations,to.prototype.compare),t=0<=n-1?this.pages[n-1]:this.pages[0],void 0!==t||(t=-1)):t=this.pages[n],t}},{key:'cfiFromPage',value:function(e){var t=-1;'number'!=typeof e&&(e=parseInt(e));var n=this.pages.indexOf(e);return-1!=n&&(t=this.pageLocations[n]),t}},{key:'pageFromPercentage',value:function(e){var t=te(this.totalPages*e);return t}},{key:'percentageFromPage',value:function(e){var t=(e-this.firstPage)/this.totalPages;return te(1e3*t)/1e3}},{key:'percentagePageFromCfi',value:function(e){var t=this.pageFromCfi(e),n=this.percentageFromPage(t);return n}},{key:'destroy',value:function(){}}]),e}();ka(co.prototype);var po=function(){function e(t){Xn(this,e),this.toc=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},t&&this.unpack(t)}return ta(e,[{key:'get',value:function(e){var t;return e?(0===e.indexOf('#')?t=this.tocById[e.substring(1)]:e in this.tocByHref&&(t=this.tocByHref[e]),this.toc[t]):this.toc}},{key:'landmark',value:function(e){var t;return t=this.landmarksByType[e],this.landmarks[t]}},{key:'unpack',value:function(e){e.toc&&this.unpackToc(e.toc),e.landmarks&&this.unpackLandmarks(e.landmarks)}},{key:'unpackToc',value:function(e){var t=this;this.toc=e,e.forEach(function(e,n){t.tocByHref[e.href]=n,e.source&&(t.tocByHref[e.href]=n),e.id&&(t.tocId[e.id]=n)})}},{key:'unpackLandmarks',value:function(e){var t=this;this.landmarks=e,e.forEach(function(e,n){t.landmarksByType[e.type]=n})}},{key:'destroy',value:function(){this.toc=void 0,this.tocByHref=void 0,this.tocById=void 0,this.landmarks=void 0,this.landmarksByType=void 0}}]),e}(),uo=function(){function e(t){Xn(this,e),this.sections=new io,this.navigation=new po,this.locators=new co,this.manifest={\"@context\":'http://readium.org/webpub/default.jsonld',metadata:{\"@type\":'http://schema.org/Book'},resources:[],toc:[],landmarks:[],locations:[],pages:[],spine:[],links:[]},t&&this.parse(t)}return ta(e,[{key:'parse',value:function(e){if(e){'string'==typeof e&&(e=JSON.parse(e));var t=e,n=t.metadata,a=t.resources,i=t.toc,o=t.landmarks,r=t.locations,s=t.pages,l=t.spine,d=t.links;this.metadata=n,this.resources=a,this.spine=l,this.toc=i,this.landmarks=o,this.locations=r,this.pages=s,this.links=d}}},{key:'section',value:function(e){return this.sections.get(e)}},{key:'getRange',value:function(e){var t=new to(e),n=this.sections.get(t.spinePos);return n?n.load().then(function(){var e=t.toRange(n.document);return e}):new Gn(function(e,t){t('CFI could not be found')})}},{key:'key',value:function(e){var t=e||this.metadata.identifier;return'epubjs-'+ro+'-'+t}},{key:'toObject',value:function(){return this.manifest}},{key:'toJSON',value:function(){return he(this.manifest)}},{key:'destroy',value:function(){this.sections&&this.sections.destroy(),this.locators&&this.locators.destroy(),this.navigation&&this.navigation.destroy(),this.sections=void 0,this.locators=void 0,this.navigation=void 0,this.manifest=void 0}},{key:'url',get:function(){var e=this.manifest.links.find(function(e){return'self'===e.rel});return e&&e.href},set:function(e){var t=this.manifest.links.find(function(e){return'self'===e.rel});return t?t.href=e:(t={rel:'self',href:e,type:'application/webpub+json'},this.manifest.links.push(t)),this.path=t.href,t&&t.href}},{key:'path',get:function(){return this._path},set:function(e){var t=new ci(e);return this._path=t.Path,this._path}},{key:'spine',get:function(){return this.manifest.spine},set:function(e){if(e)return this.sections.unpack(e),this.manifest.spine=e,this.manifest.spine}},{key:'cover',get:function(){var e=this.manifest.links.find(function(e){return'cover'===e.rel});return e&&e.href},set:function(e){var t=this.manifest.links.find(function(e){return'cover'===e.rel});return t?t.href=e:(t={rel:'cover',href:e},this.manifest.links.push(t)),t&&t.href}},{key:'metadata',get:function(){return this.manifest.metadata},set:function(e){if(e)return this.manifest.metadata=e,e['@type']||(this.manifest.metadata['@type']='http://schema.org/Book'),this.manifest.metadata}},{key:'resources',get:function(){return this.manifest.resources},set:function(e){var t=this;if(e)return this.manifest.resources=e.map(function(e){return e.properties&&e.properties.length&&(-1<e.properties.indexOf('cover-image')&&(e.rel='cover'),-1<e.properties.indexOf('nav')&&(e.rel='contents'),e.rel&&'cover'===e.rel&&(t.cover=e.href)),e}),this.manifest.resources}},{key:'toc',get:function(){return this.manifest.toc},set:function(e){if(e)return this.navigation.unpackToc(e),this.manifest.toc=e}},{key:'landmarks',get:function(){return this.manifest.landmarks},set:function(e){if(e)return this.navigation.unpackLandmarks(e),this.manifest.landmarks=e}},{key:'locations',get:function(){return this.manifest.locations},set:function(e){if(e)return this.locators.unpackLocations(e),this.manifest.locations=e}},{key:'pages',get:function(){return this.manifest.pages},set:function(e){if(e)return this.locators.unpackPages(e),this.manifest.pages=e}},{key:'links',get:function(){return this.manifest.links},set:function(e){var t=this;if(e)return e.forEach(function(e){'cover'===e.rel&&(t.cover=e.href),'self'===e.rel&&(t.path=e.href)}),this.manifest.links=e}},{key:'source',get:function(){var e=this.manifest.links.find(function(e){return'source'===e.rel});return e},set:function(e){var t=this.manifest.links.find(function(e){return'source'===e.rel});return t?t.href=e:(t={rel:'source',href:e,type:'application/epub+zip'},this.manifest.links.push(t)),t}}]),e}();ka(uo.prototype),Ra('keys',function(){return function(e){return ot(kt(e))}});var ho=le.Object.keys,go=a(function(e){e.exports={default:ho,__esModule:!0}}),mo=n(go),yo=function(){function e(t){Xn(this,e),this.settings=t,this.name=t.layout||'reflowable',this._spread='none'!==t.spread,this._minSpreadWidth=t.minSpreadWidth||800,this._evenSpreads=t.evenSpreads||!1,this._flow='scrolled'===t.flow||'scrolled-continuous'===t.flow||'scrolled-doc'===t.flow?'scrolled':'paginated',this.width=0,this.height=0,this.spreadWidth=0,this.delta=0,this.columnWidth=0,this.gap=0,this.divisor=1,this.props={name:this.name,spread:this._spread,flow:this._flow,width:0,height:0,spreadWidth:0,delta:0,columnWidth:0,gap:0,divisor:1}}return ta(e,[{key:'flow',value:function(e){return'undefined'!=typeof e&&(this._flow='scrolled'===e||'scrolled-continuous'===e||'scrolled-doc'===e?'scrolled':'paginated',this.update({flow:this._flow})),this._flow}},{key:'spread',value:function(e,t){return e&&(this._spread='none'!==e,this.update({spread:this._spread})),0<=t&&(this._minSpreadWidth=t),this._spread}},{key:'calculate',value:function(e,t,n){var a=1,i=n||0,o=e,r=t,s=oe(o/12),l,d,c,p;a=this._spread&&o>=this._minSpreadWidth?2:1,'reflowable'!==this.name||'paginated'!==this._flow||0<=n||(i=0==s%2?s:s-1),'pre-paginated'===this.name&&(i=0),1<a?(l=o/a-i,c=l+i):(l=o,c=o),'pre-paginated'===this.name&&1<a&&(o=l),d=l*a+i,p=o,this.width=o,this.height=r,this.spreadWidth=d,this.pageWidth=c,this.delta=p,this.columnWidth=l,this.gap=i,this.divisor=a,this.update({width:o,height:r,spreadWidth:d,pageWidth:c,delta:p,columnWidth:l,gap:i,divisor:a})}},{key:'format',value:function(e){var t;return t='pre-paginated'===this.name?e.fit(this.columnWidth,this.height):'paginated'===this._flow?e.columns(this.width,this.height,this.columnWidth,this.gap):e.size(this.width,null),t}},{key:'count',value:function(e,t){var n,a;return'pre-paginated'===this.name?(n=1,a=1):'paginated'===this._flow?(t=t||this.delta,n=re(e/t),a=n*this.divisor):(t=t||this.height,n=re(e/t),a=n),{spreads:n,pages:a}}},{key:'update',value:function(e){var t=this;if(mo(e).forEach(function(n){t.props[n]===e[n]&&delete e[n]}),0<mo(e).length){var n=p(this.props,e);this.emit(lo.LAYOUT.UPDATED,n,e)}}}]),e}();ka(yo.prototype);var fo=function(){function e(t){Xn(this,e),this.rendition=t,this._themes={default:{rules:{},url:'',serialized:''}},this._overrides={},this._current='default',this._injected=[],this.rendition.hooks.content.register(this.inject.bind(this)),this.rendition.hooks.content.register(this.overrides.bind(this))}return ta(e,[{key:'register',value:function(){return 0===arguments.length?void 0:1===arguments.length&&'object'===Ji(arguments[0])?this.registerThemes(arguments[0]):1===arguments.length&&'string'==typeof arguments[0]?this.default(arguments[0]):2===arguments.length&&'string'==typeof arguments[1]?this.registerUrl(arguments[0],arguments[1]):2===arguments.length&&'object'===Ji(arguments[1])?this.registerRules(arguments[0],arguments[1]):void 0}},{key:'default',value:function(e){return e?'string'==typeof e?this.registerUrl('default',e):'object'===('undefined'==typeof e?'undefined':Ji(e))?this.registerRules('default',e):void 0:void 0}},{key:'registerThemes',value:function(e){for(var t in e)e.hasOwnProperty(t)&&('string'==typeof e[t]?this.registerUrl(t,e[t]):this.registerRules(t,e[t]))}},{key:'registerUrl',value:function(e,t){var n=new ci(t);this._themes[e]={url:n.toString()},this._injected[e]&&this.update(e)}},{key:'registerRules',value:function(e,t){this._themes[e]={rules:t},this._injected[e]&&this.update(e)}},{key:'select',value:function(e){var t=this._current,n;this._current=e,this.update(e),n=this.rendition.getContents(),n.forEach(function(n){n.removeClass(t),n.addClass(e)})}},{key:'update',value:function(e){var t=this,n=this.rendition.getContents();n.forEach(function(n){t.add(e,n)})}},{key:'inject',value:function(e){var t=[],n=this._themes,a;for(var i in n)n.hasOwnProperty(i)&&(i===this._current||'default'===i)&&(a=n[i],(a.rules&&0<mo(a.rules).length||a.url&&-1===t.indexOf(a.url))&&this.add(i,e),this._injected.push(i));'default'!=this._current&&e.addClass(this._current)}},{key:'add',value:function(e,t){var n=this._themes[e];n&&t&&(n.url?t.addStylesheet(n.url):n.serialized||n.rules&&(t.addStylesheetRules(n.rules),n.injected=!0))}},{key:'override',value:function(e,t){var n=this,a=this.rendition.getContents();this._overrides[e]=t,a.forEach(function(t){t.css(e,n._overrides[e])})}},{key:'overrides',value:function(e){var t=this._overrides;for(var n in t)t.hasOwnProperty(n)&&e.css(n,t[n])}},{key:'fontSize',value:function(e){this.override('font-size',e)}},{key:'font',value:function(e){this.override('font-family',e)}},{key:'destroy',value:function(){this.rendition=void 0,this._themes=void 0,this._overrides=void 0,this._current=void 0,this._injected=void 0}}]),e}(),vo=function(){function e(t,n,a,i){Xn(this,e),this.layout=t,this.horizontal='horizontal'===a,this.direction=n||'ltr',this._dev=i}return ta(e,[{key:'section',value:function(e){var t=this.findRanges(e),n=this.rangeListToCfiList(e.section.cfiBase,t);return n}},{key:'page',value:function(e,t,n,a){var i=!!(e&&e.document)&&e.document.body,o;if(i){if(o=this.rangePairToCfiPair(t,{start:this.findStart(i,n,a),end:this.findEnd(i,n,a)}),!0===this._dev){var s=e.document,l=new to(o.start).toRange(s),d=new to(o.end).toRange(s),c=s.defaultView.getSelection(),p=s.createRange();c.removeAllRanges(),p.setStart(l.startContainer,l.startOffset),p.setEnd(d.endContainer,d.endOffset),c.addRange(p)}return o}}},{key:'walk',value:function(e,t){if(!(e&&e.nodeType===Node.TEXT_NODE)){var n={acceptNode:function(e){return 0<e.data.trim().length?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},a=n.acceptNode;a.acceptNode=n.acceptNode;for(var i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,a,!1),o,r;(o=i.nextNode())&&(r=t(o),!r););return r}}},{key:'findRanges',value:function(e){for(var t=[],n=e.contents.scrollWidth(),a=re(n/this.layout.spreadWidth),o=a*this.layout.divisor,r=this.layout.columnWidth,s=this.layout.gap,l=0,i,d;l<o.pages;l++)i=(r+s)*l,d=r*(l+1)+s*l,t.push({start:this.findStart(e.document.body,i,d),end:this.findEnd(e.document.body,i,d)});return t}},{key:'findStart',value:function(e,t,n){for(var a=this,i=[e],o=e,r,s;i.length;)if(r=i.shift(),s=this.walk(r,function(e){var r,s,l,d,c;if(c=a.getBounds(e),a.horizontal&&'ltr'===a.direction){if(r=a.horizontal?c.left:c.top,s=a.horizontal?c.right:c.bottom,r>=t&&r<=n)return e;if(s>t)return e;o=e,i.push(e)}else if(a.horizontal&&'rtl'===a.direction){if(r=c.left,s=c.right,s<=n&&s>=t)return e;if(r<n)return e;o=e,i.push(e)}else{if(l=c.top,d=c.bottom,l>=t&&l<=n)return e;if(d>t)return e;o=e,i.push(e)}}),s)return this.findTextStartRange(s,t,n);return this.findTextStartRange(o,t,n)}},{key:'findEnd',value:function(e,t,n){for(var a=this,i=[e],o=e,r,s;i.length;)if(r=i.shift(),s=this.walk(r,function(e){var r,s,l,d,c;if(c=a.getBounds(e),a.horizontal&&'ltr'===a.direction){if(r=te(c.left),s=te(c.right),r>n&&o)return o;if(s>n)return e;o=e,i.push(e)}else if(a.horizontal&&'rtl'===a.direction){if(r=te(a.horizontal?c.left:c.top),s=te(a.horizontal?c.right:c.bottom),s<t&&o)return o;if(r<t)return e;o=e,i.push(e)}else{if(l=te(c.top),d=te(c.bottom),l>n&&o)return o;if(d>n)return e;o=e,i.push(e)}}),s)return this.findTextEndRange(s,t,n);return this.findTextEndRange(o,t,n)}},{key:'findTextStartRange',value:function(e,t,n){for(var a=this.splitTextNodeIntoRanges(e),o=0,i,r,s,l,d;o<a.length;o++)if(i=a[o],r=i.getBoundingClientRect(),this.horizontal&&'ltr'===this.direction){if(s=r.left,s>=t)return i;}else if(this.horizontal&&'rtl'===this.direction){if(d=r.right,d<=n)return i;}else if(l=r.top,l>=t)return i;return a[0]}},{key:'findTextEndRange',value:function(e,t,n){for(var a=this.splitTextNodeIntoRanges(e),o=0,i,r,s,l,d,c,p;o<a.length;o++){if(r=a[o],s=r.getBoundingClientRect(),this.horizontal&&'ltr'===this.direction){if(l=s.left,d=s.right,l>n&&i)return i;if(d>n)return r}else if(this.horizontal&&'rtl'===this.direction){if(l=s.left,d=s.right,d<t&&i)return i;if(l<t)return r}else{if(c=s.top,p=s.bottom,c>n&&i)return i;if(p>n)return r}i=r}return a[a.length-1]}},{key:'splitTextNodeIntoRanges',value:function(e,t){var n=[],a=e.textContent||'',i=a.trim(),o=e.ownerDocument,r=t||' ',s=i.indexOf(r),l;if(-1===s||e.nodeType!=Node.TEXT_NODE)return l=o.createRange(),l.selectNodeContents(e),[l];for(l=o.createRange(),l.setStart(e,0),l.setEnd(e,s),n.push(l),l=!1;-1!=s;)s=i.indexOf(r,s+1),0<s&&(l&&(l.setEnd(e,s),n.push(l)),l=o.createRange(),l.setStart(e,s+1));return l&&(l.setEnd(e,i.length),n.push(l)),n}},{key:'rangePairToCfiPair',value:function(e,t){var n=t.start,a=t.end;n.collapse(!0),a.collapse(!1);var i=new to(n,e).toString(),o=new to(a,e).toString();return{start:i,end:o}}},{key:'rangeListToCfiList',value:function(e,t){for(var n=[],a=0,i;a<t.length;a++)i=this.rangePairToCfiPair(e,t[a]),n.push(i);return n}},{key:'getBounds',value:function(e){var t;if(e.nodeType==Node.TEXT_NODE){var n=document.createRange();n.selectNodeContents(e),t=n.getBoundingClientRect()}else t=e.getBoundingClientRect();return t}},{key:'axis',value:function(e){return e&&(this.horizontal='horizontal'===e),this.horizontal}}]),e}(),ko=/Chrome/.test(navigator.userAgent),bo=!ko&&/AppleWebKit/.test(navigator.userAgent),xo=function(){function e(t,n,a,i){Xn(this,e),this.epubcfi=new to,this.document=t,this.documentElement=this.document.documentElement,this.content=n||this.document.body,this.window=this.document.defaultView,this._size={width:0,height:0},this.sectionIndex=i||0,this.cfiBase=a||'',this.epubReadingSystem('epub.js',ePub.VERSION),this.listeners()}return ta(e,[{key:'width',value:function(e){var t=this.content;return e&&s(e)&&(e+='px'),e&&(t.style.width=e),this.window.getComputedStyle(t).width}},{key:'height',value:function(e){var t=this.content;return e&&s(e)&&(e+='px'),e&&(t.style.height=e),this.window.getComputedStyle(t).height}},{key:'contentWidth',value:function(e){var t=this.content||this.document.body;return e&&s(e)&&(e+='px'),e&&(t.style.width=e),this.window.getComputedStyle(t).width}},{key:'contentHeight',value:function(e){var t=this.content||this.document.body;return e&&s(e)&&(e+='px'),e&&(t.style.height=e),this.window.getComputedStyle(t).height}},{key:'textWidth',value:function(){var e=this.document.createRange(),t=this.content||this.document.body,n=y(t),a;return e.selectNodeContents(t),a=e.getBoundingClientRect().width,n&&n.width&&(a+=n.width),te(a)}},{key:'textHeight',value:function(){var e=this.document.createRange(),t=this.content||this.document.body,n=y(t),a;return e.selectNodeContents(t),a=e.getBoundingClientRect().height,a&&n.height&&(a+=n.height),re(a)}},{key:'scrollWidth',value:function(){var e=this.documentElement.scrollWidth;return e}},{key:'scrollHeight',value:function(){var e=this.documentElement.scrollHeight;return e}},{key:'overflow',value:function(e){return e&&(this.documentElement.style.overflow=e),this.window.getComputedStyle(this.documentElement).overflow}},{key:'overflowX',value:function(e){return e&&(this.documentElement.style.overflowX=e),this.window.getComputedStyle(this.documentElement).overflowX}},{key:'overflowY',value:function(e){return e&&(this.documentElement.style.overflowY=e),this.window.getComputedStyle(this.documentElement).overflowY}},{key:'css',value:function(e,t,n){var a=this.content||this.document.body;return t&&a.style.setProperty(e,t,n?'important':''),this.window.getComputedStyle(a)[e]}},{key:'viewport',value:function(e){var t=this.document.querySelector('meta[name=\\'viewport\\']'),n={width:void 0,height:void 0,scale:void 0,minimum:void 0,maximum:void 0,scalable:void 0},a=[],i={};if(t&&t.hasAttribute('content')){var o=t.getAttribute('content'),r=o.match(/width\\s*=\\s*([^,]*)/),s=o.match(/height\\s*=\\s*([^,]*)/),l=o.match(/initial-scale\\s*=\\s*([^,]*)/),d=o.match(/minimum-scale\\s*=\\s*([^,]*)/),p=o.match(/maximum-scale\\s*=\\s*([^,]*)/),u=o.match(/user-scalable\\s*=\\s*([^,]*)/);r&&r.length&&'undefined'!=typeof r[1]&&(n.width=r[1]),s&&s.length&&'undefined'!=typeof s[1]&&(n.height=s[1]),l&&l.length&&'undefined'!=typeof l[1]&&(n.scale=l[1]),d&&d.length&&'undefined'!=typeof d[1]&&(n.minimum=d[1]),p&&p.length&&'undefined'!=typeof p[1]&&(n.maximum=p[1]),u&&u.length&&'undefined'!=typeof u[1]&&(n.scalable=u[1])}return i=c(e||{},n),e&&(i.width&&a.push('width='+i.width),i.height&&a.push('height='+i.height),i.scale&&a.push('initial-scale='+i.scale),'no'===i.scalable?(a.push('minimum-scale='+i.scale),a.push('maximum-scale='+i.scale),a.push('user-scalable='+i.scalable)):(i.scalable&&a.push('user-scalable='+i.scalable),i.minimum&&a.push('minimum-scale='+i.minimum),i.maximum&&a.push('minimum-scale='+i.maximum)),!t&&(t=this.document.createElement('meta'),t.setAttribute('name','viewport'),this.document.querySelector('head').appendChild(t)),t.setAttribute('content',a.join(', ')),this.window.scrollTo(0,0)),i}},{key:'expand',value:function(){this.emit(lo.CONTENTS.EXPAND)}},{key:'listeners',value:function(){this.imageLoadListeners(),this.mediaQueryListeners(),this.addEventListeners(),this.addSelectionListeners(),this.resizeListeners(),this.linksHandler()}},{key:'removeListeners',value:function(){this.removeEventListeners(),this.removeSelectionListeners(),clearTimeout(this.expanding)}},{key:'resizeCheck',value:function(){var e=this.textWidth(),t=this.textHeight();(e!=this._size.width||t!=this._size.height)&&(this._size={width:e,height:t},this.onResize&&this.onResize(this._size),this.emit(lo.CONTENTS.RESIZE,this._size))}},{key:'resizeListeners',value:function(){clearTimeout(this.expanding),requestAnimationFrame(this.resizeCheck.bind(this)),this.expanding=setTimeout(this.resizeListeners.bind(this),350)}},{key:'transitionListeners',value:function(){var e=this.content;e.style.transitionProperty='font, font-size, font-size-adjust, font-stretch, font-variation-settings, font-weight, width, height',e.style.transitionDuration='0.001ms',e.style.transitionTimingFunction='linear',e.style.transitionDelay='0',this.document.addEventListener('transitionend',this.resizeCheck.bind(this))}},{key:'mediaQueryListeners',value:function(){for(var e=this.document.styleSheets,t=function(e){e.matches&&!this._expanding&&setTimeout(this.expand.bind(this),1)}.bind(this),n=0;n<e.length;n+=1){var a;try{a=e[n].cssRules}catch(t){return}if(!a)return;for(var i=0;i<a.length;i+=1)if(a[i].media){var o=this.window.matchMedia(a[i].media.mediaText);o.addListener(t)}}}},{key:'resizeObservers',value:function(){var e=this;this.observer=new MutationObserver(function(){e.resizeCheck()});this.observer.observe(this.document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}},{key:'imageLoadListeners',value:function(){for(var e=this.document.querySelectorAll('img'),t=0,n;t<e.length;t++)n=e[t],'undefined'!=typeof n.naturalWidth&&0===n.naturalWidth&&(n.onload=this.expand.bind(this))}},{key:'fontLoadListeners',value:function(){this.document&&this.document.fonts&&this.document.fonts.ready.then(function(){this.resizeCheck()}.bind(this))}},{key:'root',value:function(){return this.document?this.document.documentElement:null}},{key:'locationOf',value:function(e,t){var n={left:0,top:0},a;if(!this.document)return n;if(this.epubcfi.isCfiString(e)){var i=new to(e).toRange(this.document,t);if(i)if(i.startContainer.nodeType===Node.ELEMENT_NODE)a=i.startContainer.getBoundingClientRect(),n.left=a.left,n.top=a.top;else if(bo){var o=i.startContainer,r=new Range;try{o.nodeType===1?a=o.getBoundingClientRect():i.startOffset+2<o.length?(r.setStart(o,i.startOffset),r.setEnd(o,i.startOffset+2),a=r.getBoundingClientRect()):0<i.startOffset-2?(r.setStart(o,i.startOffset-2),r.setEnd(o,i.startOffset),a=r.getBoundingClientRect()):a=o.parentNode.getBoundingClientRect()}catch(t){console.error(t,t.stack)}}else a=i.getBoundingClientRect()}else if('string'==typeof e&&-1<e.indexOf('#')){var s=e.substring(e.indexOf('#')+1),l=this.document.getElementById(s);l&&(a=l.getBoundingClientRect())}return a&&(n.left=a.left,n.top=a.top),n}},{key:'addStylesheet',value:function(e){return new Gn(function(t){var n=!1,a;return this.document?(a=this.document.querySelector('link[href=\\''+e+'\\']'),a?void t(!0):void(a=this.document.createElement('link'),a.type='text/css',a.rel='stylesheet',a.href=e,a.onload=a.onreadystatechange=function(){n||this.readyState&&'complete'!=this.readyState||(n=!0,setTimeout(function(){t(!0)},1))},this.document.head.appendChild(a))):void t(!1)}.bind(this))}},{key:'addStylesheetRules',value:function(e){var t='epubjs-inserted-css',n,a;if(this.document&&e&&0!==e.length)if(n=this.document.getElementById('#'+t),n||(n=this.document.createElement('style'),n.id=t),this.document.head.appendChild(n),a=n.sheet,'[object Array]'===Object.prototype.toString.call(e))for(var o=0,i=e.length;o<i;o++){var r=1,s=e[o],l=e[o][0],d='';'[object Array]'===Object.prototype.toString.call(s[1][0])&&(s=s[1],r=0);for(var c=s.length,p;r<c;r++)p=s[r],d+=p[0]+':'+p[1]+(p[2]?' !important':'')+';\\n';a.insertRule(l+'{'+d+'}',a.cssRules.length)}else{var u=mo(e);u.forEach(function(t){var n=e[t];if(Array.isArray(n))n.forEach(function(e){var n=mo(e),i=n.map(function(t){return t+':'+e[t]}).join(';');a.insertRule(t+'{'+i+'}',a.cssRules.length)});else{var i=mo(n),o=i.map(function(e){return e+':'+n[e]}).join(';');a.insertRule(t+'{'+o+'}',a.cssRules.length)}})}}},{key:'addScript',value:function(e){return new Gn(function(t){var n=!1,a;return this.document?void(a=this.document.createElement('script'),a.type='text/javascript',a.async=!0,a.src=e,a.onload=a.onreadystatechange=function(){n||this.readyState&&'complete'!=this.readyState||(n=!0,setTimeout(function(){t(!0)},1))},this.document.head.appendChild(a)):void t(!1)}.bind(this))}},{key:'addClass',value:function(e){var t;this.document&&(t=this.content||this.document.body,t&&t.classList.add(e))}},{key:'removeClass',value:function(e){var t;this.document&&(t=this.content||this.document.body,t&&t.classList.remove(e))}},{key:'addEventListeners',value:function(){this.document&&so.forEach(function(e){this.document.addEventListener(e,this.triggerEvent.bind(this),!1)},this)}},{key:'removeEventListeners',value:function(){this.document&&so.forEach(function(e){this.document.removeEventListener(e,this.triggerEvent,!1)},this)}},{key:'triggerEvent',value:function(t){this.emit(t.type,t)}},{key:'addSelectionListeners',value:function(){this.document&&this.document.addEventListener('selectionchange',this.onSelectionChange.bind(this),!1)}},{key:'removeSelectionListeners',value:function(){this.document&&this.document.removeEventListener('selectionchange',this.onSelectionChange,!1)}},{key:'onSelectionChange',value:function(){this.selectionEndTimeout&&clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=setTimeout(function(){var e=this.window.getSelection();this.triggerSelectedEvent(e)}.bind(this),250)}},{key:'triggerSelectedEvent',value:function(e){var t,n;e&&0<e.rangeCount&&(t=e.getRangeAt(0),!t.collapsed&&(n=new to(t,this.cfiBase).toString(),this.emit(lo.CONTENTS.SELECTED,n),this.emit(lo.CONTENTS.SELECTED_RANGE,t)))}},{key:'range',value:function(e,t){var n=new to(e);return n.toRange(this.document,t)}},{key:'cfiFromRange',value:function(e,t){return new to(e,this.cfiBase,t).toString()}},{key:'cfiFromNode',value:function(e,t){return new to(e,this.cfiBase,t).toString()}},{key:'map',value:function(e){var t=new vo(e);return t.section()}},{key:'size',value:function(e,t){var n={scale:1,scalable:'no'};this.layoutStyle('scrolling'),0<=e&&(this.width(e),n.width=e,this.css('padding','0 '+e/12+'px',!0)),0<=t&&(this.height(t),n.height=t),this.css('margin','0'),this.css('box-sizing','border-box'),this.viewport(n)}},{key:'columns',value:function(e,t,n,a){var i=d('column-axis'),o=d('column-gap'),r=d('column-width'),s=d('column-fill'),l=this.writingMode(),c=0===l.indexOf('vertical')?'vertical':'horizontal';this.layoutStyle('paginated'),'rtl'===this.content.dir&&this.direction('rtl'),this.width(e),this.height(t),this.viewport({width:e,height:t,scale:1,scalable:'no'}),this.css('overflow-y','hidden'),this.css('margin','0',!0),'vertical'==c?this.css('padding',a/2+'px 20px',!0):this.css('padding','20px '+a/2+'px',!0),this.css('box-sizing','border-box'),this.css('max-width','inherit'),this.css(i,'horizontal'),this.css(s,'auto'),this.css(o,a+'px'),this.css(r,n+'px')}},{key:'scaler',value:function(e,t,n){var a='';this.css('transform-origin','top left'),(0<=t||0<=n)&&(a=' translate('+(t||0)+'px, '+(n||0)+'px )'),this.css('transform','scale('+e+')'+a)}},{key:'fit',value:function(e,t){var n=this.viewport(),a=e/parseInt(n.width),i=t/parseInt(n.height),o=a<i?a:i,r=(t-n.height*o)/2;this.layoutStyle('paginated'),this.width(e),this.height(t),this.overflow('hidden'),this.scaler(o,0,r),this.css('background-color','transparent')}},{key:'direction',value:function(e){this.documentElement&&(this.documentElement.style.direction=e)}},{key:'mapPage',value:function(e,t,n,a,i){var o=new vo(t,i);return o.page(this,e,n,a)}},{key:'linksHandler',value:function(){var e=this;$(this.content,function(t){e.emit(lo.CONTENTS.LINK_CLICKED,t)})}},{key:'writingMode',value:function(e){var t=d('writing-mode');return e&&this.documentElement&&(this.documentElement.style[t]=e),this.window.getComputedStyle(this.documentElement)[t]||''}},{key:'layoutStyle',value:function(e){return e&&(this._layoutStyle=e,navigator.epubReadingSystem.layoutStyle=this._layoutStyle),this._layoutStyle||'paginated'}},{key:'epubReadingSystem',value:function(e,t){return navigator.epubReadingSystem={name:e,version:t,layoutStyle:this.layoutStyle(),hasFeature:function(e){return'dom-manipulation'===e||'layout-changes'===e||'touch-events'===e||'mouse-events'===e||'keyboard-events'===e||'spine-scripting'!==e&&!1}},navigator.epubReadingSystem}},{key:'addIdentifier',value:function(e){var t=this.document.createElement('meta');t.setAttribute('name','dc.relation.ispartof'),e&&t.setAttribute('content',e),this.document.getElementsByTagName('head')[0].appendChild(t)}},{key:'destroy',value:function(){this.observer&&this.observer.disconnect(),this.document.removeEventListener('transitionend',this.resizeCheck),this.removeListeners()}}],[{key:'listenedEvents',get:function(){return so}}]),e}();ka(xo.prototype);var _o=function(){function e(t){Xn(this,e),this.rendition=t,this.highlights=[],this.underlines=[],this.marks=[],this._annotations={},this._annotationsBySectionIndex={},this.rendition.hooks.render.register(this.inject.bind(this)),this.rendition.hooks.unloaded.register(this.clear.bind(this))}return ta(e,[{key:'add',value:function(e,t,n,a){var i=encodeURI(t),o=new to(t),r=o.spinePos,s=new Eo({type:e,cfiRange:t,data:n,sectionIndex:r,cb:a});this._annotations[i]=s,r in this._annotationsBySectionIndex?this._annotationsBySectionIndex[r].push(i):this._annotationsBySectionIndex[r]=[i];var l=this.rendition.views();return l.forEach(function(e){s.sectionIndex===e.index&&s.attach(e)}),s}},{key:'remove',value:function(e,t){var n=this,a=encodeURI(e);if(a in this._annotations){var i=this._annotations[a];if(t&&i.type!==t)return;var o=this.rendition.views();o.forEach(function(e){n._removeFromAnnotationBySectionIndex(i.sectionIndex,a),i.sectionIndex===e.index&&i.detach(e)}),delete this._annotations[a]}}},{key:'_removeFromAnnotationBySectionIndex',value:function(e,t){this._annotationsBySectionIndex[e]=this._annotationsAt(e).filter(function(e){return e!==t})}},{key:'_annotationsAt',value:function(e){return this._annotationsBySectionIndex[e]}},{key:'highlight',value:function(e,t,n){this.add('highlight',e,t,n)}},{key:'underline',value:function(e,t,n){this.add('underline',e,t,n)}},{key:'mark',value:function(e,t,n){this.add('mark',e,t,n)}},{key:'each',value:function(){return this._annotations.forEach.apply(this._annotations,arguments)}},{key:'inject',value:function(e){var t=this,n=e.index;if(n in this._annotationsBySectionIndex){var a=this._annotationsBySectionIndex[n];a.forEach(function(n){var a=t._annotations[n];a.attach(e)})}}},{key:'clear',value:function(e){var t=this,n=e.index;if(n in this._annotationsBySectionIndex){var a=this._annotationsBySectionIndex[n];a.forEach(function(n){var a=t._annotations[n];a.detach(e)})}}},{key:'show',value:function(){}},{key:'hide',value:function(){}}]),e}(),Eo=function(){function e(t){var n=t.type,a=t.cfiRange,i=t.data,o=t.sectionIndex,r=t.cb;Xn(this,e),this.type=n,this.cfiRange=a,this.data=i,this.sectionIndex=o,this.mark=void 0,this.cb=r}return ta(e,[{key:'update',value:function(e){this.data=e}},{key:'attach',value:function(e){var t=this.cfiRange,n=this.data,a=this.type,i=this.cb,o;return'highlight'===a?o=e.highlight(t,n,i):'underline'===a?o=e.underline(t,n,i):'mark'===a&&(o=e.mark(t,n,i)),this.mark=o,o}},{key:'detach',value:function(e){var t=this.cfiRange,n=this.type,a;return e&&('highlight'===n?a=e.unhighlight(t):'underline'===n?a=e.ununderline(t):'mark'===n&&(a=e.unmark(t))),this.mark=void 0,a}},{key:'text',value:function(){}}]),e}();ka(Eo.prototype);var wo=function(){function e(t,n){Xn(this,e),this.request=t,this.pause=n||100,this.q=new oo(this),this.epubcfi=new to,this._locations=[],this.total=0,this.break=150,this._current=0,this.currentLocation='',this._currentCfi='',this.processingTimeout=void 0}return ta(e,[{key:'generate',value:function(e,t){return this.spine=e,t&&(this.break=t),this.q.pause(),this.spine.each(function(e){e.linear&&this.q.enqueue(this.process.bind(this),e)}.bind(this)),this.q.run().then(function(){return this.total=this._locations.length-1,this._currentCfi&&(this.currentLocation=this._currentCfi),this._locations}.bind(this))}},{key:'createRange',value:function(){return{startContainer:void 0,startOffset:void 0,endContainer:void 0,endOffset:void 0}}},{key:'process',value:function(e){return e.load(this.request).then(function(t){var n=new B,a=this.parse(t,e.cfiBase);return this._locations=this._locations.concat(a),e.unload(),this.processingTimeout=setTimeout(function(){return n.resolve(a)},this.pause),n.promise}.bind(this))}},{key:'parse',value:function(e,t,n){var a=[],i=e.ownerDocument,o=T(i,'body'),r=0,s=n||this.break,l=function(e){var n=e.length,i=0,o;if(0===e.textContent.trim().length)return!1;for(0==r&&(d=this.createRange(),d.startContainer=e,d.startOffset=0),o=s-r,o>n&&(r+=n,i=n);i<n;)if(o=s-r,0===r&&(i+=1,d=this.createRange(),d.startContainer=e,d.startOffset=i),i+o>=n)r+=n-i,i=n;else{i+=o,d.endContainer=e,d.endOffset=i;var l=new to(d,t).toString();a.push(l),r=0}c=e},d,c;if(N(o,l.bind(this)),d&&d.startContainer&&c){d.endContainer=c,d.endOffset=c.length;var p=new to(d,t).toString();a.push(p),r=0}return a}},{key:'locationFromCfi',value:function(e){var t;return(to.prototype.isCfiString(e)&&(e=new to(e)),0===this._locations.length)?-1:(t=u(e,this._locations,this.epubcfi.compare),t>this.total?this.total:t)}},{key:'percentageFromCfi',value:function(e){if(0===this._locations.length)return null;var t=this.locationFromCfi(e);return this.percentageFromLocation(t)}},{key:'percentageFromLocation',value:function(e){return e&&this.total?e/this.total:0}},{key:'cfiFromLocation',value:function(e){var t=-1;return'number'!=typeof e&&(e=parseInt(e)),0<=e&&e<this._locations.length&&(t=this._locations[e]),t}},{key:'cfiFromPercentage',value:function(e){var t;if(1<e&&console.warn('Normalize cfiFromPercentage value to between 0 - 1'),1<=e){var n=new to(this._locations[this.total]);return n.collapse(),n.toString()}return t=re(this.total*e),this.cfiFromLocation(t)}},{key:'load',value:function(e){return this._locations='string'==typeof e?JSON.parse(e):e,this.total=this._locations.length-1,this._locations}},{key:'save',value:function(){return this.toJSON()}},{key:'getCurrent',value:function(){return this._current}},{key:'setCurrent',value:function(e){var t;if('string'==typeof e)this._currentCfi=e;else if('number'==typeof e)this._current=e;else return;0===this._locations.length||('string'==typeof e?(t=this.locationFromCfi(e),this._current=t):t=e,this.emit(lo.LOCATIONS.CHANGED,{percentage:this.percentageFromLocation(t)}))}},{key:'length',value:function(){return this._locations.length}},{key:'toArray',value:function(){return this._locations}},{key:'toJSON',value:function(){return he(this._locations)}},{key:'destroy',value:function(){this.spine=void 0,this.request=void 0,this.pause=void 0,this.q.stop(),this.q=void 0,this.epubcfi=void 0,this._locations=void 0,this.total=void 0,this.break=void 0,this._current=void 0,this.currentLocation=void 0,this._currentCfi=void 0,clearTimeout(this.processingTimeout)}},{key:'currentLocation',get:function(){return this._current},set:function(e){this.setCurrent(e)}}]),e}();ka(wo.prototype);var So=function(){function e(t){Xn(this,e),this.pages=[],this.locations=[],this.epubcfi=new to,this.firstPage=0,this.lastPage=0,this.totalPages=0,this.toc=void 0,this.ncx=void 0,t&&(this.pageList=this.parse(t)),this.pageList&&this.pageList.length&&this.process(this.pageList)}return ta(e,[{key:'parse',value:function(e){var t=T(e,'html'),n=T(e,'ncx');return t?this.parseNav(e):void n}},{key:'parseNav',value:function(e){var t=j(e,'nav','page-list'),n=t?O(t,'li'):[],a=n.length,o=[],r,i;if(!n||0===a)return o;for(r=0;r<a;++r)i=this.item(n[r]),o.push(i);return o}},{key:'item',value:function(e){var t=T(e,'a'),n=t.getAttribute('href')||'',a=t.textContent||'',i=parseInt(a),o=n.indexOf('epubcfi'),r,s,l;return-1==o?{href:n,page:i}:(r=n.split('#'),s=r[0],l=!!(1<r.length)&&r[1],{cfi:l,href:n,packageUrl:s,page:i})}},{key:'process',value:function(e){e.forEach(function(e){this.pages.push(e.page),e.cfi&&this.locations.push(e.cfi)},this),this.firstPage=parseInt(this.pages[0]),this.lastPage=parseInt(this.pages[this.pages.length-1]),this.totalPages=this.lastPage-this.firstPage}},{key:'pageFromCfi',value:function(e){var t=-1;if(0===this.locations.length)return-1;var n=h(e,this.locations,this.epubcfi.compare);return-1==n?(n=u(e,this.locations,this.epubcfi.compare),t=0<=n-1?this.pages[n-1]:this.pages[0],void 0!==t||(t=-1)):t=this.pages[n],t}},{key:'cfiFromPage',value:function(e){var t=-1;'number'!=typeof e&&(e=parseInt(e));var n=this.pages.indexOf(e);return-1!=n&&(t=this.locations[n]),t}},{key:'pageFromPercentage',value:function(e){var t=te(this.totalPages*e);return t}},{key:'percentageFromPage',value:function(e){var t=(e-this.firstPage)/this.totalPages;return te(1e3*t)/1e3}},{key:'percentageFromCfi',value:function(e){var t=this.pageFromCfi(e),n=this.percentageFromPage(t);return n}},{key:'toArray',value:function(){return this.locations}},{key:'toJSON',value:function(){return he(this.locations)}},{key:'destroy',value:function(){this.pages=void 0,this.locations=void 0,this.epubcfi=void 0,this.pageList=void 0,this.toc=void 0,this.ncx=void 0}}]),e}(),Co=function(){function e(t){Xn(this,e),this.packagePath='',this.directory='',this.encoding='',t&&this.parse(t)}return ta(e,[{key:'parse',value:function(e){var t;if(!e)throw new Error('Container File Not Found');if(t=T(e,'rootfile'),!t)throw new Error('No RootFile Found');this.packagePath=t.getAttribute('full-path'),this.directory=li.dirname(this.packagePath),this.encoding=e.xmlEncoding}},{key:'destroy',value:function(){this.packagePath=void 0,this.directory=void 0,this.encoding=void 0}}]),e}(),Ro=function(){function e(t){Xn(this,e),this.manifest={},this.navPath='',this.ncxPath='',this.coverPath='',this.spineNodeIndex=0,this.spine=[],this.metadata={},t&&this.parse(t)}return ta(e,[{key:'parse',value:function(e){var t,n,a;if(!e)throw new Error('Package File Not Found');if(t=T(e,'metadata'),!t)throw new Error('No Metadata Found');if(n=T(e,'manifest'),!n)throw new Error('No Manifest Found');if(a=T(e,'spine'),!a)throw new Error('No Spine Found');return this.manifest=this.parseManifest(n),this.navPath=this.findNavPath(n),this.ncxPath=this.findNcxPath(n,a),this.coverPath=this.findCoverPath(e),this.spineNodeIndex=b(a),this.spine=this.parseSpine(a,this.manifest),this.metadata=this.parseMetadata(t),this.metadata.direction=a.getAttribute('page-progression-direction'),{metadata:this.metadata,spine:this.spine,manifest:this.manifest,navPath:this.navPath,ncxPath:this.ncxPath,coverPath:this.coverPath,spineNodeIndex:this.spineNodeIndex}}},{key:'parseMetadata',value:function(e){var t={title:this.getElementText(e,'title'),creator:this.getElementText(e,'creator'),description:this.getElementText(e,'description'),pubdate:this.getElementText(e,'date'),publisher:this.getElementText(e,'publisher'),identifier:this.getElementText(e,'identifier'),language:this.getElementText(e,'language'),rights:this.getElementText(e,'rights'),modified_date:this.getPropertyText(e,'dcterms:modified'),layout:this.getPropertyText(e,'rendition:layout'),orientation:this.getPropertyText(e,'rendition:orientation'),flow:this.getPropertyText(e,'rendition:flow'),viewport:this.getPropertyText(e,'rendition:viewport')};return t}},{key:'parseManifest',value:function(e){var t={},n=O(e,'item'),a=Array.prototype.slice.call(n);return a.forEach(function(e){var n=e.getAttribute('id'),a=e.getAttribute('href')||'',i=e.getAttribute('media-type')||'',o=e.getAttribute('properties')||'';t[n]={href:a,type:i,properties:o.length?o.split(' '):[]}}),t}},{key:'parseSpine',value:function(e){var t=[],n=O(e,'itemref'),a=Array.prototype.slice.call(n);return a.forEach(function(e,n){var a=e.getAttribute('idref'),i=e.getAttribute('properties')||'',o=i.length?i.split(' '):[],r={idref:a,linear:e.getAttribute('linear')||'yes',properties:o,index:n};t.push(r)}),t}},{key:'findNavPath',value:function(e){var t=L(e,'item',{properties:'nav'});return!!t&&t.getAttribute('href')}},{key:'findNcxPath',value:function(e,t){var n=L(e,'item',{\"media-type\":'application/x-dtbncx+xml'}),a;return n||(a=t.getAttribute('toc'),a&&(n=e.getElementById(a))),!!n&&n.getAttribute('href')}},{key:'findCoverPath',value:function(e){var t=T(e,'package'),n=t.getAttribute('version');if('2.0'===n){var a=L(e,'meta',{name:'cover'});if(a){var i=a.getAttribute('content'),o=e.getElementById(i);return o?o.getAttribute('href'):''}return!1}var r=L(e,'item',{properties:'cover-image'});return r?r.getAttribute('href'):''}},{key:'getElementText',value:function(e,t){var n=e.getElementsByTagNameNS('http://purl.org/dc/elements/1.1/',t),a;return n&&0!==n.length?(a=n[0],a.childNodes.length?a.childNodes[0].nodeValue:''):''}},{key:'getPropertyText',value:function(e,t){var n=L(e,'meta',{property:t});return n&&n.childNodes.length?n.childNodes[0].nodeValue:''}},{key:'load',value:function(e){var t=this;return this.metadata=e.metadata,this.spine=e.spine.map(function(e,n){var a=e.idref;return a||(e.idref=encodeURIComponent(e.href)),'undefined'==typeof e.linear&&(e.linear='yes'),e.rel&&'cover'===e.rel[0]&&(t.coverPath=e.href),e.index=n,t.manifest[e.idref]=e,e}),e.resources&&e.resources.forEach(function(e){var n=e.id||e.href;t.manifest[n]=e,e.rel&&'cover'===e.rel[0]&&(t.coverPath=e.href)}),this.spineNodeIndex=0,this.toc=e.toc,{metadata:this.metadata,spine:this.spine,manifest:this.manifest,navPath:this.navPath,ncxPath:this.ncxPath,coverPath:this.coverPath,spineNodeIndex:this.spineNodeIndex,toc:this.toc}}},{key:'destroy',value:function(){this.manifest=void 0,this.navPath=void 0,this.ncxPath=void 0,this.coverPath=void 0,this.spineNodeIndex=void 0,this.spine=void 0,this.metadata=void 0}}]),e}(),To=function(){function e(t,n){Xn(this,e),this.toc=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},this.length=0,this.url=n||'',t&&this.parse(t)}return ta(e,[{key:'parse',value:function(e){var t=e.nodeType,n,a;t&&(n=T(e,'html'),a=T(e,'ncx')),t?n?(this.toc=this.parseNav(e),this.landmarks=this.parseLandmarks(e)):a&&(this.toc=this.parseNcx(e)):this.toc=this.load(e),this.length=0,this.unpack(this.toc)}},{key:'unpack',value:function(e){for(var t=0,n,a;t<e.length;t++)n=e[t],a=n.href,n.href&&(this.tocByHref[a]=t),n.id&&(this.tocById[a]=t),this.length++,n.children.length&&this.unpack(n.children)}},{key:'get',value:function(e){var t;return e?(0===e.indexOf('#')?t=this.tocById[e.substring(1)]:e in this.tocByHref&&(t=this.tocByHref[e]),this.toc[t]):this.toc}},{key:'landmark',value:function(e){var t;return e?(t=this.landmarksByType[e],this.landmarks[t]):this.landmarks}},{key:'parseNav',value:function(e){var t=j(e,'nav','toc'),n=t?O(t,'li'):[],a=n.length,o={},r=[],s,i,l;if(!n||0===a)return r;for(s=0;s<a;++s)i=this.navItem(n[s]),i&&(o[i.id]=i,i.parentIndex?(l=o[i.parent],l.children.push(i)):r.push(i));return r}},{key:'navItem',value:function(e){var t=e.getAttribute('id')||void 0,n=M(e,'a',!0);if(n){t||(t='epubjs-autogen-toc-id-'+o(),e.setAttribute('id',t));var a=n.getAttribute('href')||'',i=n.textContent||'',r=q(e,'li'),s=a.split('#'),l;for(''===s[0]&&(a=this.url+a),r&&(l=r.getAttribute('id'));!l&&r;)r=q(r,'li'),r&&(l=r.getAttribute('id'));return{id:t,href:a,title:i,children:[],parent:l}}}},{key:'parseLandmarks',value:function(e){var t=j(e,'nav','landmarks'),n=t?O(t,'li'):[],a=n.length,o=[],r,i;if(!n||0===a)return o;for(r=0;r<a;++r)i=this.landmarkItem(n[r]),i&&(o.push(i),this.landmarksByType[i.type]=r);return o}},{key:'landmarkItem',value:function(e){var t=M(e,'a',!0);if(t){var n=t.getAttributeNS('http://www.idpf.org/2007/ops','type')||void 0,a=t.getAttribute('href')||'',i=t.textContent||'',o=a.split('#');return''===o[0]&&(a=this.url+a),{href:a,title:i,type:n}}}},{key:'parseNcx',value:function(e){var t=O(e,'navPoint'),n=t.length,a={},o=[],r,i,s;if(!t||0===n)return o;for(r=0;r<n;++r)i=this.ncxItem(t[r]),a[i.id]=i,i.parent?(s=a[i.parent],s.children.push(i)):o.push(i);return o}},{key:'ncxItem',value:function(e){var t=e.getAttribute('id')||!1,n=T(e,'content'),a=n.getAttribute('src'),i=T(e,'navLabel'),r=i.textContent?i.textContent:'',s=e.parentNode,l;return s&&'navPoint'===s.nodeName&&(l=s.getAttribute('id')),t||(t='epubjs-autogen-toc-id-'+o(),e.setAttribute('id',t)),{id:t,href:a,title:r,children:[],parent:l}}},{key:'load',value:function(e){var t=this;return e.map(function(e){return e.children&&(e.children=t.load(e.children)),e})}},{key:'forEach',value:function(e){return this.toc.forEach(e)}},{key:'getTocArray',value:function(e){return this.toc.map(function(t){var n=e?e(t.href):t.href,a={href:n,title:t.title};return t.children.length&&(a.children=t.children),a})}},{key:'getLandmarksArray',value:function(e){return this.landmarks.map(function(t){var n=e?e(t.href):t.href,a={href:n,title:t.title,type:t.type};return a})}}]),e}(),Oo=Object.assign,Lo=!Oo||_e(function(){var e={},t={},n=Symbol(),a='abcdefghijklmnopqrst';return e[n]=7,a.split('').forEach(function(e){t[e]=e}),7!=Oo({},e)[n]||Object.keys(Oo({},t)).join('')!=a})?function(e){for(var t=kt(e),n=arguments.length,a=1,i=vi.f,o=Aa.f;n>a;)for(var r=He(arguments[a++]),s=i?ot(r).concat(i(r)):ot(r),l=s.length,d=0,c;l>d;)o.call(r,c=s[d++])&&(t[c]=r[c]);return t}:Oo;je(je.S+je.F,'Object',{assign:Lo});var No=le.Object.assign,Io=a(function(e){e.exports={default:No,__esModule:!0}}),Ao=n(Io),Po={application:{ecmascript:['es','ecma'],javascript:'js',ogg:'ogx',pdf:'pdf',postscript:['ps','ai','eps','epsi','epsf','eps2','eps3'],\"rdf+xml\":'rdf',smil:['smi','smil'],\"xhtml+xml\":['xhtml','xht'],xml:['xml','xsl','xsd','opf','ncx'],zip:'zip',\"x-httpd-eruby\":'rhtml',\"x-latex\":'latex',\"x-maker\":['frm','maker','frame','fm','fb','book','fbdoc'],\"x-object\":'o',\"x-shockwave-flash\":['swf','swfl'],\"x-silverlight\":'scr',\"epub+zip\":'epub',\"font-tdpfr\":'pfr',\"inkml+xml\":['ink','inkml'],json:'json',\"jsonml+json\":'jsonml',\"mathml+xml\":'mathml',\"metalink+xml\":'metalink',mp4:'mp4s',\"omdoc+xml\":'omdoc',oxps:'oxps',\"vnd.amazon.ebook\":'azw',widget:'wgt',\"x-dtbook+xml\":'dtb',\"x-dtbresource+xml\":'res',\"x-font-bdf\":'bdf',\"x-font-ghostscript\":'gsf',\"x-font-linux-psf\":'psf',\"x-font-otf\":'otf',\"x-font-pcf\":'pcf',\"x-font-snf\":'snf',\"x-font-ttf\":['ttf','ttc'],\"x-font-type1\":['pfa','pfb','pfm','afm'],\"x-font-woff\":'woff',\"x-mobipocket-ebook\":['prc','mobi'],\"x-mspublisher\":'pub',\"x-nzb\":'nzb',\"x-tgif\":'obj',\"xaml+xml\":'xaml',\"xml-dtd\":'dtd',\"xproc+xml\":'xpl',\"xslt+xml\":'xslt',\"internet-property-stream\":'acx',\"x-compress\":'z',\"x-compressed\":'tgz',\"x-gzip\":'gz'},audio:{flac:'flac',midi:['mid','midi','kar','rmi'],mpeg:['mpga','mpega','mp2','mp3','m4a','mp2a','m2a','m3a'],mpegurl:'m3u',ogg:['oga','ogg','spx'],\"x-aiff\":['aif','aiff','aifc'],\"x-ms-wma\":'wma',\"x-wav\":'wav',adpcm:'adp',mp4:'mp4a',webm:'weba',\"x-aac\":'aac',\"x-caf\":'caf',\"x-matroska\":'mka',\"x-pn-realaudio-plugin\":'rmp',xm:'xm',mid:['mid','rmi']},image:{gif:'gif',ief:'ief',jpeg:['jpeg','jpg','jpe'],pcx:'pcx',png:'png',\"svg+xml\":['svg','svgz'],tiff:['tiff','tif'],\"x-icon\":'ico',bmp:'bmp',webp:'webp',\"x-pict\":['pic','pct'],\"x-tga\":'tga',\"cis-cod\":'cod'},text:{\"cache-manifest\":['manifest','appcache'],css:'css',csv:'csv',html:['html','htm','shtml','stm'],mathml:'mml',plain:['txt','text','brf','conf','def','list','log','in','bas'],richtext:'rtx',\"tab-separated-values\":'tsv',\"x-bibtex\":'bib'},video:{mpeg:['mpeg','mpg','mpe','m1v','m2v','mp2','mpa','mpv2'],mp4:['mp4','mp4v','mpg4'],quicktime:['qt','mov'],ogg:'ogv',\"vnd.mpegurl\":['mxu','m4u'],\"x-flv\":'flv',\"x-la-asf\":['lsf','lsx'],\"x-mng\":'mng',\"x-ms-asf\":['asf','asx','asr'],\"x-ms-wm\":'wm',\"x-ms-wmv\":'wmv',\"x-ms-wmx\":'wmx',\"x-ms-wvx\":'wvx',\"x-msvideo\":'avi',\"x-sgi-movie\":'movie',\"x-matroska\":['mpv','mkv','mk3d','mks'],\"3gpp2\":'3g2',h261:'h261',h263:'h263',h264:'h264',jpeg:'jpgv',jpm:['jpm','jpgm'],mj2:['mj2','mjp2'],\"vnd.ms-playready.media.pyv\":'pyv',\"vnd.uvvu.mp4\":['uvu','uvvu'],\"vnd.vivo\":'viv',webm:'webm',\"x-f4v\":'f4v',\"x-m4v\":'m4v',\"x-ms-vob\":'vob',\"x-smv\":'smv'}},Bo=function(){var e={},t,n,a,i;for(t in Po)if(Po.hasOwnProperty(t))for(n in Po[t])if(Po[t].hasOwnProperty(n))if(a=Po[t][n],'string'==typeof a)e[a]=t+'/'+n;else for(i=0;i<a.length;i++)e[a[i]]=t+'/'+n;return e}(),jo={lookup:function(e){return e&&Bo[e.split('.').pop().toLowerCase()]||'text/plain'}},Do=function(){function e(t,n){Xn(this,e),this.settings={replacements:n&&n.replacements||'blobUrl',archive:n&&n.archive,load:n&&n.load,url:n&&n.url,inject:n&&n.inject||{}},this.urlCache={},this.resources=Ao({},t),this.resourcesByHref={},this.ids=[],this.html=[],this.assets=[],this.css=[],'string'==typeof this.settings.url?(this.url=new ci(this.settings.url),this.path=new di(this.settings.url)):'object'===Ji(this.settings.url)?(this.url=this.settings.url,this.path=new di(this.url.toString())):this.path=new di('/'),t&&this.split(t)}return ta(e,[{key:'split',value:function(e){var t=this,n=mo(e),a=n.filter(function(t){var n=e[t];if('application/xhtml+xml'===n.type||'text/html'===n.type)return!0}),i=n.filter(function(t){var n=e[t];if('application/xhtml+xml'!==n.type&&'text/html'!==n.type&&'text/css'!==n.type)return!0}),o=n.filter(function(t){var n=e[t];if('text/css'===n.type)return!0});return n.forEach(function(n){var a=e[n];a.id=n,a.source||(a.source=a.href),t.resourcesByHref[a.href]=n}),this.ids=n,this.html=a,this.assets=i,this.css=o,{html:a,assets:i,css:o}}},{key:'cache',value:function(e,t){var n=this;if('undefined'==typeof caches)return new Gn(function(e){e([])});this.cacheKey=e;var a=this.url;return'string'==typeof t&&(a=new ci(t)),this.ids.map(function(i){var o=n.resources[i],r=o.source||o.href,s=-1<r.indexOf('://'),l=s?r:n.path.resolve(r),d;if(!s&&a)d=a.resolve(r);else{var c=new ci(r,t),p=encodeURIComponent(c.origin);l=l.replace(c.origin,''),d=new ci(e+p+l,location.href).toString()}n.resources[i].path=l,n.resources[i].cached=d,n.urlCache[l]=d}),caches.open(e).then(function(e){var t=n.ids.map(function(t){var a=n.resources[t],i=a.cached,o=a.path,r=jo.lookup(o);return e.match(i).then(function(t){if(!t){var s;return s='application/xhtml+xml'===a.type||'text/html'===a.type?n.settings.load(o,'text').then(function(e){return n.settings.inject.identifier&&(e=n.injectIdentifier(e,n.settings.inject.identifier)),n.settings.inject.script&&(e=n.injectScript(e,n.settings.inject.script)),n.settings.inject.stylesheet&&(e=n.injectStylesheet(e,n.settings.inject.script)),_(e,a.type)}):n.settings.load(o,'blob'),s.then(function(t){var a=new Response(t,{status:200,headers:{\"Content-Type\":r}});return n.urlCache[o]=i,e.put(i,a)},function(){return console.warn('Missing Resource',o),o}).then(function(){return i})}return n.urlCache[o]=i,i})});return Gn.all(t)})}},{key:'replacements',value:function(){var e=this;if('none'===this.settings.replacements)return new Gn(function(e){e([])}.bind(this));var t=[],n=this.assets.map(function(n){var a=e.replacementUrl(n);return t.push(a),a}),a=Gn.all(n).then(function(){return e.css.map(function(n){var a=e.replacementCss(n);return t.push(a),a})}),i=a.then(function(){return e.html.map(function(n){var a=e.replacementHtml(n);return t.push(a),a})});return i.then(function(){return Gn.all(t)}).then(function(e){return e})}},{key:'replacementUrl',value:function(e){var t=this,n=this.resources[e],a=this.url.resolve(n.href),i;return i='base64'===this.settings.replacements?this.base64UrlFrom(a):this.blobUrlFrom(a),i.then(function(n){return t.resources[e].replacement=n,t.urlCache[a]=n,n}).catch(function(e){return console.error(e),null})}},{key:'replacementCss',value:function(e){var t=this,n=this.resources[e],a=n.href,i;if(this.path.isAbsolute(a))return new Gn(function(e){e(a)});var o=this.path.resolve(a),r=new di(o),s;return s=this.settings.archive?this.settings.archive.getText(o):this.settings.load(o,'text'),s.then(function(e){var n={};return t.ids.forEach(function(e){var a=t.resources[e];if(a.replacement){var i=a.href,o=t.path.resolve(i),s=r.relative(o);n[s]=a.replacement}}),e=t.substitute(e,n),i='base64'===t.settings.replacements?S(e,'text/css'):E(e,'text/css'),i},function(){return new Gn(function(e){e()})}).then(function(n){return n&&(t.resources[e].replacement=n,t.urlCache[r]=n),n})}},{key:'replacementHtml',value:function(e){var t=this,n=this.resources[e],a=n.href,i=jo.lookup(a),o;if(this.path.isAbsolute(a))return new Gn(function(e){e(a)});var r=this.path.resolve(a),s=new di(r),l;return l=this.settings.archive?this.settings.archive.getText(r):this.settings.load(r,'text'),l.then(function(e){var n={};return t.ids.forEach(function(e){var a=t.resources[e];if(a.replacement){var i=a.href,o=t.path.resolve(i),r=s.relative(o);n[r]=a.replacement}}),e=t.substitute(e,n),t.settings.inject.base&&(e=t.injectBase(e,t.settings.inject.base)),t.settings.inject.identifier&&(e=t.injectIdentifier(e,t.settings.inject.identifier)),t.settings.inject.script&&(e=t.injectScript(e,t.settings.inject.script)),t.settings.inject.stylesheet&&(e=t.injectStylesheet(e,t.settings.inject.script)),o='base64'===t.settings.replacements?S(e,i):E(e,i),o},function(){return new Gn(function(e){e()})}).then(function(n){return n&&(t.resources[e].replacement=n,t.urlCache[s]=n),n})}},{key:'blobUrlFrom',value:function(e){var t=new ci(e),n=jo.lookup(t.filename);return this.settings.archive?this.settings.archive.createUrl(e,{base64:!1}):this.settings.load(e,'blob').then(function(e){return E(e,n)})}},{key:'base64UrlFrom',value:function(e){var t=new ci(e),n=jo.lookup(t.filename);return this.settings.archive?this.settings.archive.createUrl(e,{base64:!0}):this.settings.load(e,'blob').then(function(e){return P(e)}).then(function(e){return S(e,n)})}},{key:'substitute',value:function(e,t){var n=mo(t).map(function(e){return e.replace(/[.?*+^$[\\]\\\\(){}|-]/g,'\\\\$&')}).join('|'),a=new RegExp('('+n+')','g');return e.replace(a,function(e){return t[e]})}},{key:'injectStylesheet',value:function(e,t){var n=/<[ ]*\\/head[ ]*>/;return e.replace(n,'<link href=\"'+t+'\" rel=\"stylesheet\" />'+'$&')}},{key:'injectScript',value:function(e,t){var n=/<[ ]*\\/head[ ]*>/;return e.replace(n,'<script src=\"'+t+'\" type=\"text/javascript\"></script>'+'$&')}},{key:'injectIdentifier',value:function(e,t){var n=/<[ ]*\\/head[ ]*>/;return e.replace(n,'<meta name=\"dc.relation.ispartof\" content=\"'+t+'\" />'+'$&')}},{key:'injectBase',value:function(e,t){var n=/<[ ]*head[ ]*>/,a=-1<t.indexOf('://');if(!a&&'undefined'!=typeof window&&window.location){var i=window.location.href.split('/'),o='';i.pop(),o=i.join('/'),t=o+t}var r='<base href=\"'+t+'\" />';return e.replace(n,'$&'+r)}},{key:'origin',value:function(e){this.url=new ci(e)}},{key:'resolve',value:function(e){if(e){var t=-1<e.indexOf('://'),n=t?e:this.path.resolve(e),a=n,i=n.split('?'),o=n.split('#'),r=n;1<i.length?r=i[0]:1<o.length&&(r=o[0]);var s=this.urlCache[r];return s?(a=s,1<i.length?a+='?'+i[1]:1<o.length&&(a+='#'+o[1])):this.url?a=this.url.resolve(e):a=e,a}}},{key:'toArray',value:function(){var e=this;return this.ids.map(function(t){var n=e.resources[t],a=n.type,i=n.properties,o=n.id,r=n.href,s=n.cached||n.replacement||e.url&&e.url.resolve(n.href)||n.href;return{href:s,source:r,type:a,properties:i,id:o}})}},{key:'forEach',value:function(e){var t=this;return this.ids.forEach(function(n){var a=t.resources[n];a.id=key,e(a)})}},{key:'map',value:function(e){var t=this;return this.ids.map(function(n){var a=t.resources[n];return a.id=key,e(a)})}},{key:'filter',value:function(e){var t=this;return this.ids.filter(function(n){var a=t.resources[n];return a.id=key,e(a)})}},{key:'get',value:function(e){if(e in this.resources)return this.resources[e];if(e in this.resourcesByHref){var t=this.resourcesByHref[e];return this.resources[t]}}},{key:'revokeBlobUrls',value:function(){var e=this;this.ids.forEach(function(t){var n=e.resources[t];n.replacement&&w(n.replacement)})}},{key:'destroy',value:function(){this.revokeBlobUrls(),this.settings=void 0,this.manifest=void 0,this.html=void 0,this.assets=void 0,this.css=void 0,this.urls=void 0,this.cssUrls=void 0}}]),e}(),zo=function(){function e(){Xn(this,e),this.zip=void 0,this.urlCache={},this.checkRequirements()}return ta(e,[{key:'checkRequirements',value:function(){try{this.zip=new t}catch(t){throw new Error('JSZip lib not loaded')}}},{key:'open',value:function(e,t){return this.zip.loadAsync(e,{base64:t})}},{key:'openUrl',value:function(e,t){return Z(e,'binary').then(function(e){return this.zip.loadAsync(e,{base64:t})}.bind(this))}},{key:'request',value:function(e,t){var n=new B,a=new di(e),i;return t||(t=a.extension),i='blob'==t?this.getBlob(e):this.getText(e),i?i.then(function(e){var a=this.handleResponse(e,t);n.resolve(a)}.bind(this)):n.reject({message:'File not found in the epub: '+e,stack:new Error().stack}),n.promise}},{key:'handleResponse',value:function(e,t){var n;return n='json'==t?JSON.parse(e):x(t)?R(e,'text/xml'):'xhtml'==t?R(e,'application/xhtml+xml'):'html'==t||'htm'==t?R(e,'text/html'):e,n}},{key:'getBlob',value:function(e,t){var n=decodeURIComponent(e.substr(1)),a=this.zip.file(n);if(a)return t=t||jo.lookup(a.name),a.async('uint8array').then(function(e){return new Blob([e],{type:t})})}},{key:'getText',value:function(e){var t=decodeURIComponent(e.substr(1)),n=this.zip.file(t);if(n)return n.async('string').then(function(e){return e})}},{key:'getBase64',value:function(e,t){var n=decodeURIComponent(e.substr(1)),a=this.zip.file(n);if(a)return t=t||jo.lookup(a.name),a.async('base64').then(function(e){return'data:'+t+';base64,'+e})}},{key:'createUrl',value:function(e,t){var n=new B,a=t&&t.base64,i,o;return e in this.urlCache?(n.resolve(this.urlCache[e]),n.promise):(a?(o=this.getBase64(e),o&&o.then(function(t){this.urlCache[e]=t,n.resolve(t)}.bind(this))):(o=this.getBlob(e),o&&o.then(function(t){i=URL.createObjectURL(t),this.urlCache[e]=i,n.resolve(i)}.bind(this))),o||n.reject({message:'File not found in the epub: '+e,stack:new Error().stack}),n.promise)}},{key:'revokeUrl',value:function(e){var t=this.urlCache[e];t&&URL.revokeObjectURL(t)}},{key:'destroy',value:function(){for(var e in this.urlCache)URL.revokeObjectURL(e);this.zip=void 0,this.urlCache={}}}]),e}(),Mo='META-INF/container.xml',qo={BINARY:'binary',BASE64:'base64',EPUB:'epub',OPF:'opf',MANIFEST:'json',DIRECTORY:'directory'},Fo=function(){function e(t,n){var a=this;Xn(this,e),'undefined'==typeof n&&'object'===('undefined'==typeof t?'undefined':Ji(t))&&(n=t,t=void 0),this.settings=p(this.settings||{},{requestMethod:void 0,requestCredentials:void 0,requestHeaders:void 0,encoding:void 0,replacements:void 0,cache:void 0,stylesheet:null,script:null}),p(this.settings,n),this.opening=new B,this.opened=this.opening.promise,this.isOpen=!1,this.book=void 0,this.ready=this.opened.then(function(){return a.manifest=a.book.toJSON(),a.emit(lo.BOOK.READY,a.manifest),a.book}),this.request=this.settings.requestMethod||Z,this.archived=!1,this.container=void 0,this.packaging=void 0,this.locations=void 0,this.pageList=void 0,t&&this.open(t).catch(function(e){var n=new Error('Cannot load book at '+t);a.emit(lo.BOOK.OPEN_FAILED,n),console.error(e)})}return ta(e,[{key:'open',value:function(e,t){var n=this,a=t||this.determineType(e),i,o;return'undefined'!=typeof window&&(o=window.location.href),'undefined'!=typeof self&&(o=self.location.href),a===qo.BINARY?(this.archived=!0,this.url=new ci('/',''),this.locationUrl=new ci(o),i=this.openEpub(e)):a===qo.BASE64?(this.archived=!0,this.url=new ci('/',''),this.locationUrl=new ci(o),i=this.openEpub(e,a)):a===qo.EPUB?(this.archived=!0,this.url=new ci('/',''),this.locationUrl=new ci(e,o),i=this.request(e,'binary').then(this.openEpub.bind(this))):a==qo.OPF?(this.url=new ci(e),this.locationUrl=new ci(e),i=this.openPackaging(this.url.Path.toString())):a==qo.MANIFEST?(this.url=new ci(e),this.locationUrl=new ci(e),i=this.openManifest(this.url.Path.toString())):(this.url=new ci(e),this.locationUrl=new ci(e),i=this.openContainer(Mo).then(this.openPackaging.bind(this))),i.then(function(e){return n.unpack(e)})}},{key:'openEpub',value:function(e,t){var n=this;return this.unarchive(e,t||this.settings.encoding).then(function(){return n.openContainer(Mo)}).then(function(e){return n.openPackaging(e)})}},{key:'openContainer',value:function(e){var t=this;return this.load(e).then(function(e){return t.container=new Co(e),t.resolve(t.container.packagePath)})}},{key:'openPackaging',value:function(e){var t=this;return this.path=new di(e),this.load(e).then(function(e){return t.packaging=new Ro(e),t.packaging})}},{key:'openManifest',value:function(e){var t=this;return this.path=new di(e),this.load(e).then(function(e){return t.packaging=new Ro,t.packaging.load(e),t.packaging})}},{key:'load',value:function(e,t){var n;return this.archived?(n=this.resolve(e),this.archive.request(n,t)):(n=this.resolve(e),this.request(n,t,this.settings.requestCredentials,this.settings.requestHeaders))}},{key:'resolve',value:function(e,t){if(e){var n=e,a=-1<e.indexOf('://');return a?e:(this.path&&(n=this.path.resolve(e)),(!0===t||this.url)&&(n=this.url.resolve(n)),n)}}},{key:'determineType',value:function(e){var t,n,a;return'base64'===this.settings.encoding?qo.BASE64:'string'==typeof e?(t=new ci(e),n=t.path(),a=n.extension,a?'epub'===a?qo.EPUB:'opf'===a?qo.OPF:'json'===a?qo.MANIFEST:void 0:qo.DIRECTORY):qo.BINARY}},{key:'unpack',value:function(e){var t=this;this.package=e;var n=this.path.toString(),a;a=this.archived?new ci(n,''):this.url?this.url:new ci(n),this.resources=new Do(this.package.manifest,{archive:this.archive,url:a,load:this.load.bind(this),replacements:this.settings.replacements,inject:{script:this.settings.script,stylesheet:this.settings.stylesheet,identifer:this.package.metadata.identifier}});var i=[];if('undefined'==typeof caches&&(this.settings.replacements=!0,this.settings.cache=!1),'undefined'==typeof this.settings.cache&&this.settings.worker&&(this.settings.cache=!0),this.archived&&!this.settings.worker&&!this.settings.cache&&'undefined'==typeof this.settings.replacements&&(this.settings.replacements=!0),this.settings.cache&&'undefined'!=typeof caches){var o,r,s;!this.archived||(o=encodeURIComponent(this.locationUrl.toString()),s='epubjs-zip/',a=new ci(s+o+n,location.href),r=this.resources.cache(s,a.toString()),this.cacheUrl=a),(this.settings.script||this.settings.stylesheet)&&i.push(r)}if(this.settings.replacements){var l=this.resources.replacements();i.push(l)}return Gn.all(i).then(function(){return t.loadNavigation(t.package).then(function(){return t.navigation})}).then(function(){return t.isOpen=!0,t.book=t.toBook(),t.opening.resolve(t),t.book}).catch(function(e){console.error(e)})}},{key:'cache',value:function(e,t,n){var a=this;return e||(e=this.key()),this.resources.cache(e,t,n).then(function(){return a.book=a.toBook(),a.book}).catch(function(e){console.error(e)})}},{key:'replacements',value:function(){var e=this;return this.resources.replacements().then(function(){return e.book=e.toBook(),e.book}).catch(function(e){console.error(e)})}},{key:'loadNavigation',value:function(e){var t=this,n=e.navPath||e.ncxPath,a=e.toc;return n?this.load(n,'xml').then(function(e){return t.navigation=new To(e,t.resolve(n)),t.pageList=new So(e),t.navigation}):new Gn(function(e){t.navigation=new To(null),t.pageList=new So,e(t.navigation)})}},{key:'setRequestCredentials',value:function(e){this.settings.requestCredentials=e}},{key:'setRequestHeaders',value:function(e){this.settings.requestHeaders=e}},{key:'unarchive',value:function(e,t){return this.archive=new zo,this.archive.open(e,t)}},{key:'generateLocations',value:function(e){var t=this;if(this.book)return this.locations||(this.locations=new wo),this.locations.generate(this.book.sections,e).then(function(e){return t.book.locations=e,e})}},{key:'loadLocations',value:function(e){var t;if(this.book)return this.locations||(this.locations=new wo),t='string'==typeof t?JSON.parse(e):e,this.book.locations=t,t}},{key:'key',value:function(e){var t=e||this.package.metadata.identifier||this.url.filename;return'epubjs-'+ro+'-'+t}},{key:'toBook',value:function(){var e=this,t=this.resources.resolve.bind(this.resources),n=new uo;return n.url='',n.url=this.cacheUrl?this.cacheUrl.resolve('manifest.json'):this.locationUrl.resolve('manifest.json'),this.archived&&(n.source=this.locationUrl.toString()),n.resources=this.resources.toArray(),n.spine=this.package.spine.map(function(t,a){var o=e.resources.get(t.idref)||t,r=e.resources.resolve(o.href),s=n.resources.findIndex(function(e){return e.id===o.id});return-1<s&&n.resources.splice(s,1),t.index=a,t.cfiBase=new to().generateChapterComponent(e.package.spineNodeIndex,t.index,t.idref),o&&(t.source=o.href,t.href=r,t.type=o.type,o.properties&&o.properties.length&&t.properties.push.apply(t.properties,o.properties)),t}),n.metadata=this.package.metadata,this.navigation&&(n.toc=this.navigation.getTocArray(t),n.landmarks=this.navigation.getLandmarksArray(t)),this.pageList&&(n.pages=this.pageList.toArray()),this.locations&&(n.locations=this.locations.toArray()),n}},{key:'destroy',value:function(){this.opened=void 0,this.loading=void 0,this.loaded=void 0,this.ready=void 0,this.isOpen=!1,this.isRendered=!1,this.book&&this.book.destroy(),this.locations&&this.locations.destroy(),this.pageList&&this.pageList.destroy(),this.archive&&this.archive.destroy(),this.resources&&this.resources.destroy(),this.container&&this.container.destroy(),this.packaging&&this.packaging.destroy(),this.spine=void 0,this.locations=void 0,this.pageList=void 0,this.archive=void 0,this.resources=void 0,this.container=void 0,this.packaging=void 0,this.navigation=void 0,this.url=void 0,this.path=void 0,this.archived=!1}}]),e}();ka(Fo.prototype);var Wo=a(function(e,t){function n(e){return document.createElementNS('http://www.w3.org/2000/svg',e)}Object.defineProperty(t,'__esModule',{value:!0}),t.createElement=n,t.default={createElement:n}});n(Wo);var Ho=Wo.createElement,Uo=a(function(e,t){function n(n,r){function t(s){for(var e=r.length-1;0<=e;e--){var i=r[e],t=s.clientX,l=s.clientY;if(s.touches&&s.touches.length&&(t=s.touches[0].clientX,l=s.touches[0].clientY),!!o(i,n,t,l)){i.dispatchEvent(a(s));break}}}if('iframe'===n.nodeName||'IFRAME'===n.nodeName)try{this.target=n.contentDocument}catch(e){this.target=n}else this.target=n;for(var e=['mouseup','mousedown','click','touchstart'],i=0,s;i<e.length;i++)s=e[i],this.target.addEventListener(s,function(n){return t(n)},!1)}function a(t){var e=Object.assign({},t,{bubbles:!1});try{return new MouseEvent(t.type,e)}catch(a){var n=document.createEvent('MouseEvents');return n.initMouseEvent(t.type,!1,e.cancelable,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),n}}function o(e,t,n,a){function o(e,t,n){var a=e.top-s.top,i=e.left-s.left,o=a+e.height,r=i+e.width;return a<=n&&i<=t&&o>n&&r>t}var s=t.getBoundingClientRect(),r=e.getBoundingClientRect();if(!o(r,n,a))return!1;for(var l=e.getClientRects(),d=0,i=l.length;d<i;d++)if(o(l[d],n,a))return!0;return!1}Object.defineProperty(t,'__esModule',{value:!0}),t.proxyMouse=n,t.clone=a,t.default={proxyMouse:n}});n(Uo);var Yo=Uo.proxyMouse,Vo=Uo.clone,Go=a(function(e,t){function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!e)throw new ReferenceError('this hasn\\'t been initialised - super() hasn\\'t been called');return t&&('object'==typeof t||'function'==typeof t)?t:e}function i(e,t){if('function'!=typeof t&&null!==t)throw new TypeError('Super expression must either be null or a function, not '+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}function r(e,t){var n=t.getBoundingClientRect(),a=e.getBoundingClientRect();return{top:a.top-n.top,left:a.left-n.left,height:e.scrollHeight,width:e.scrollWidth}}function s(e,t){e.style.top=t.top+'px',e.style.left=t.left+'px',e.style.height=t.height+'px',e.style.width=t.width+'px'}function l(e,t){return t.right<=e.right&&t.left>=e.left&&t.top>=e.top&&t.bottom<=e.bottom}Object.defineProperty(t,'__esModule',{value:!0}),t.Underline=t.Highlight=t.Mark=t.Pane=void 0;var d=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,a)}if('value'in i)return i.value;var r=i.get;return void 0===r?void 0:r.call(a)},c=function(){function e(e,t){for(var n=0,a;n<t.length;n++)a=t[n],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),p=n(Wo),u=n(Uo),h=t.Pane=function(){function e(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:document.body;o(this,e),this.target=t,this.element=p.default.createElement('svg'),this.marks=[],this.element.style.position='absolute',this.element.setAttribute('pointer-events','none'),u.default.proxyMouse(this.target,this.marks),this.container=n,this.container.appendChild(this.element),this.render()}return c(e,[{key:'addMark',value:function(e){var t=p.default.createElement('g');return this.element.appendChild(t),e.bind(t,this.container),this.marks.push(e),e.render(),e}},{key:'removeMark',value:function(e){var t=this.marks.indexOf(e);if(-1!==t){var n=e.unbind();this.element.removeChild(n),this.marks.splice(t,1)}}},{key:'render',value:function(){s(this.element,r(this.target,this.container));var e=!0,t=!1,n;try{for(var a=this.marks[Symbol.iterator](),i,o;!(e=(i=a.next()).done);e=!0)o=i.value,o.render()}catch(e){t=!0,n=e}finally{try{!e&&a.return&&a.return()}finally{if(t)throw n}}}}]),e}(),g=t.Mark=function(){function e(){o(this,e),this.element=null}return c(e,[{key:'bind',value:function(e,t){this.element=e,this.container=t}},{key:'unbind',value:function(){var e=this.element;return this.element=null,e}},{key:'render',value:function(){}},{key:'dispatchEvent',value:function(t){this.element&&this.element.dispatchEvent(t)}},{key:'getBoundingClientRect',value:function(){return this.element.getBoundingClientRect()}},{key:'getClientRects',value:function(){for(var e=[],t=this.element.firstChild;t;)e.push(t.getBoundingClientRect()),t=t.nextSibling;return e}},{key:'filteredRanges',value:function(){var e=Array.from(this.range.getClientRects());return e.filter(function(t){for(var n=0;n<e.length;n++){if(e[n]===t)return!0;var a=l(e[n],t);if(a)return!1}return!0})}}]),e}(),m=t.Highlight=function(e){function t(e,n,i,r){o(this,t);var s=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return s.range=e,s.className=n,s.data=i||{},s.attributes=r||{},s}return i(t,e),c(t,[{key:'bind',value:function(e,n){for(var a in d(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),'bind',this).call(this,e,n),this.data)this.data.hasOwnProperty(a)&&(this.element.dataset[a]=this.data[a]);for(var a in this.attributes)this.attributes.hasOwnProperty(a)&&this.element.setAttribute(a,this.attributes[a]);this.className&&this.element.classList.add(this.className)}},{key:'render',value:function(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);for(var e=this.element.ownerDocument.createDocumentFragment(),t=this.filteredRanges(),n=this.element.getBoundingClientRect(),a=this.container.getBoundingClientRect(),o=0,i=t.length;o<i;o++){var s=t[o],r=p.default.createElement('rect');r.setAttribute('x',s.left-n.left+a.left),r.setAttribute('y',s.top-n.top+a.top),r.setAttribute('height',s.height),r.setAttribute('width',s.width),e.appendChild(r)}this.element.appendChild(e)}}]),t}(g),y=t.Underline=function(e){function t(e,n,i,r){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r))}return i(t,e),c(t,[{key:'render',value:function(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);for(var e=this.element.ownerDocument.createDocumentFragment(),t=this.filteredRanges(),n=this.element.getBoundingClientRect(),a=this.container.getBoundingClientRect(),o=0,i=t.length;o<i;o++){var s=t[o],r=p.default.createElement('rect');r.setAttribute('x',s.left-n.left+a.left),r.setAttribute('y',s.top-n.top+a.top),r.setAttribute('height',s.height),r.setAttribute('width',s.width),r.setAttribute('fill','none');var l=p.default.createElement('line');l.setAttribute('x1',s.left-n.left+a.left),l.setAttribute('x2',s.left-n.left+a.left+s.width),l.setAttribute('y1',s.top-n.top+a.top+s.height-1),l.setAttribute('y2',s.top-n.top+a.top+s.height-1),l.setAttribute('stroke-width',1),l.setAttribute('stroke','black'),l.setAttribute('stroke-linecap','square'),e.appendChild(r),e.appendChild(l)}this.element.appendChild(e)}}]),t}(m)});n(Go);var Ko=Go.Underline,Xo=Go.Highlight,$o=Go.Mark,Zo=Go.Pane,Jo=function(){function e(t,n){Xn(this,e),this.settings=p({ignoreClass:'',axis:n.layout&&'scrolled'===n.layout.props.flow?'vertical':'horizontal',direction:void 0,width:0,height:0,layout:void 0,globalLayoutProperties:{},method:'url'},n||{}),this.id='epubjs-view-'+o(),this.section=t,this.index=t.index,this.element=this.container(this.settings.axis),this.added=!1,this.displayed=!1,this.rendered=!1,this.fixedWidth=0,this.fixedHeight=0,this.epubcfi=new to,this.layout=this.settings.layout,this.pane=void 0,this.highlights={},this.underlines={},this.marks={}}return ta(e,[{key:'container',value:function(e){var t=document.createElement('div');return t.classList.add('epub-view'),t.style.height='0px',t.style.width='0px',t.style.overflow='hidden',t.style.position='relative',t.style.display='block',t.style.flex=e&&'horizontal'==e?'none':'initial',t}},{key:'create',value:function(){return this.iframe?this.iframe:(this.element||(this.element=this.createContainer()),this.iframe=document.createElement('iframe'),this.iframe.id=this.id,this.iframe.scrolling='no',this.iframe.style.overflow='hidden',this.iframe.seamless='seamless',this.iframe.style.border='none',this.iframe.setAttribute('enable-annotation','true'),this.resizing=!0,this.element.style.visibility='hidden',this.iframe.style.visibility='hidden',this.iframe.style.width='0',this.iframe.style.height='0',this._width=0,this._height=0,this.element.setAttribute('ref',this.index),this.element.appendChild(this.iframe),this.added=!0,this.elementBounds=m(this.element),this.supportsSrcdoc=!!('srcdoc'in this.iframe),this.iframe)}},{key:'render',value:function(){var e;return this.create(),this.size(),e='url'===this.settings.method?this.section.href:e?this.section.contents:Z(this.section.href),this.load(e).then(function(){var e=this;this.layout.format(this.contents);var t=this.contents.writingMode(),n=0===t.indexOf('vertical')?'vertical':'horizontal';return this.setAxis(n),this.emit(lo.VIEWS.AXIS,n),this.addListeners(),new Gn(function(t){e.expand(),t()})}.bind(this),function(t){return this.emit(lo.VIEWS.LOAD_ERROR,t),new Gn(function(e,n){n(t)})}.bind(this)).then(function(){this.emit(lo.VIEWS.RENDERED,this.section)}.bind(this))}},{key:'reset',value:function(){this.iframe&&(this.iframe.style.width='0',this.iframe.style.height='0',this._width=0,this._height=0,this._textWidth=void 0,this._contentWidth=void 0,this._textHeight=void 0,this._contentHeight=void 0),this._needsReframe=!0}},{key:'size',value:function(e,t){var n=e||this.settings.width,a=t||this.settings.height;'pre-paginated'===this.layout.name?this.lock('both',n,a):'horizontal'===this.settings.axis?this.lock('height',n,a):this.lock('width',n,a),this.settings.width=n,this.settings.height=a}},{key:'lock',value:function(e,t,n){var a=y(this.element),i;i=this.iframe?y(this.iframe):{width:0,height:0},'width'==e&&s(t)&&(this.lockedWidth=t-a.width-i.width),'height'==e&&s(n)&&(this.lockedHeight=n-a.height-i.height),'both'===e&&s(t)&&s(n)&&(this.lockedWidth=t-a.width-i.width,this.lockedHeight=n-a.height-i.height),this.displayed&&this.iframe&&this.expand()}},{key:'expand',value:function(){var e=this.lockedWidth,t=this.lockedHeight,n;!this.iframe||this._expanding||(this._expanding=!0,'pre-paginated'===this.layout.name?(e=this.layout.columnWidth,t=this.layout.height):'horizontal'===this.settings.axis?(e=this.contents.textWidth(),0<e%this.layout.pageWidth&&(e=re(e/this.layout.pageWidth)*this.layout.pageWidth),this.settings.forceEvenPages&&(n=e/this.layout.delta,1<this.layout.divisor&&'reflowable'===this.layout.name&&0<n%2&&(e+=this.layout.gap+this.layout.columnWidth))):'vertical'===this.settings.axis&&(t=this.contents.scrollHeight()),(this._needsReframe||e!=this._width||t!=this._height)&&this.reframe(e,t),this._expanding=!1)}},{key:'reframe',value:function(e,t){var n;s(e)&&(this.element.style.width=e+'px',this.iframe.style.width=e+'px',this._width=e),s(t)&&(this.element.style.height=t+'px',this.iframe.style.height=t+'px',this._height=t);var a=this.prevBounds?e-this.prevBounds.width:e,i=this.prevBounds?t-this.prevBounds.height:t;n={width:e,height:t,widthDelta:a,heightDelta:i},this.pane&&this.pane.render(),this.onResize(this,n),this.emit(lo.VIEWS.RESIZED,n),this.prevBounds=n,this.elementBounds=m(this.element)}},{key:'load',value:function(e){var t=this,n=new B,a=n.promise;return this.iframe?(this.iframe.onload=function(e){this.onLoad(e,n)}.bind(this),'url'==this.settings.method?this.iframe.src=e:e.then(function(e){var n=H(e);'blobUrl'===t.settings.method?(t.blobUrl=E(n,'application/xhtml+xml'),t.iframe.src=t.blobUrl):'srcdoc'===t.settings.method&&(t.iframe.srcdoc=n)}),a):(n.reject(new Error('No Iframe Available')),a)}},{key:'onLoad',value:function(e,t){var n=this;this.window=this.iframe.contentWindow,this.document=this.iframe.contentDocument,this.contents=new xo(this.document,this.document.body,this.section.cfiBase,this.section.index),this.rendering=!1,this.contents.on(lo.CONTENTS.EXPAND,function(){n.displayed&&n.iframe&&(n.expand(),n.contents&&n.layout.format(n.contents))}),this.contents.on(lo.CONTENTS.RESIZE,function(){n.displayed&&n.iframe&&(n.expand(),n.contents&&n.layout.format(n.contents))}),t.resolve(this.contents)}},{key:'setLayout',value:function(e){this.layout=e,this.contents&&(this.layout.format(this.contents),this.expand())}},{key:'setAxis',value:function(e){'scrolled'===this.layout.props.flow&&(e='vertical'),this.settings.axis=e,this.element.style.flex='horizontal'==e?'none':'initial',this.size()}},{key:'addListeners',value:function(){}},{key:'removeListeners',value:function(){}},{key:'display',value:function(e){var t=new B;return this.displayed?t.resolve(this):this.render(e).then(function(){this.emit(lo.VIEWS.DISPLAYED,this),this.onDisplayed(this),this.displayed=!0,t.resolve(this)}.bind(this),function(e){t.reject(e,this)}),t.promise}},{key:'show',value:function(){this.element.style.visibility='visible',this.iframe&&(this.iframe.style.visibility='visible'),this.emit(lo.VIEWS.SHOWN,this)}},{key:'hide',value:function(){this.element.style.visibility='hidden',this.iframe.style.visibility='hidden',this.stopExpanding=!0,this.emit(lo.VIEWS.HIDDEN,this)}},{key:'offset',value:function(){return{top:this.element.offsetTop,left:this.element.offsetLeft}}},{key:'width',value:function(){return this._width}},{key:'height',value:function(){return this._height}},{key:'position',value:function(){return this.element.getBoundingClientRect()}},{key:'locationOf',value:function(e){var t=this.contents.locationOf(e,this.settings.ignoreClass);return{left:t.left,top:t.top}}},{key:'onDisplayed',value:function(){}},{key:'onResize',value:function(){}},{key:'bounds',value:function(e){return(e||!this.elementBounds)&&(this.elementBounds=m(this.element)),this.elementBounds}},{key:'highlight',value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=arguments[2];if(this.contents){var i=this.contents.range(e),o=function(){t.emit(lo.VIEWS.MARK_CLICKED,e,n)};n.epubcfi=e,this.pane||(this.pane=new Zo(this.iframe,this.element));var r=new Xo(i,'epubjs-hl',n,{fill:'yellow',\"fill-opacity\":'0.3',\"mix-blend-mode\":'multiply'}),s=this.pane.addMark(r);return this.highlights[e]={mark:s,element:s.element,listeners:[o,a]},s.element.setAttribute('ref','epubjs-hl'),s.element.addEventListener('click',o),s.element.addEventListener('touchstart',o),a&&(s.element.addEventListener('click',a),s.element.addEventListener('touchstart',a)),s}}},{key:'underline',value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=arguments[2];if(this.contents){var i=this.contents.range(e),o=function(){t.emit(lo.VIEWS.MARK_CLICKED,e,n)};n.epubcfi=e,this.pane||(this.pane=new Zo(this.iframe,this.element));var r=new Ko(i,'epubjs-ul',n,{stroke:'black',\"stroke-opacity\":'0.3',\"mix-blend-mode\":'multiply'}),s=this.pane.addMark(r);return this.underlines[e]={mark:s,element:s.element,listeners:[o,a]},s.element.setAttribute('ref','epubjs-ul'),s.element.addEventListener('click',o),s.element.addEventListener('touchstart',o),a&&(s.element.addEventListener('click',a),s.element.addEventListener('touchstart',a)),s}}},{key:'mark',value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=arguments[2];if(this.contents){if(e in this.marks){var o=this.marks[e];return o}var r=this.contents.range(e);if(r){var s=r.commonAncestorContainer,l=1===s.nodeType?s:s.parentNode,d=function(){t.emit(lo.VIEWS.MARK_CLICKED,e,n)};r.collapsed&&1===s.nodeType?(r=new Range,r.selectNodeContents(s)):r.collapsed&&(r=new Range,r.selectNodeContents(l));var c,p,u;if('pre-paginated'===this.layout.name||'horizontal'!==this.settings.axis){var h=r.getBoundingClientRect();c=h.top,p=h.right}else for(var g=r.getClientRects(),m=void 0,y=0;y!=g.length;y++)m=g[y],(!u||m.left<u)&&(u=m.left,p=u+this.layout.columnWidth-this.layout.gap,c=m.top);var i=this.document.createElement('a');return i.setAttribute('ref','epubjs-mk'),i.style.position='absolute',i.style.top=c+'px',i.style.left=p+'px',i.dataset.epubcfi=e,n&&mo(n).forEach(function(e){i.dataset[e]=n[e]}),a&&(i.addEventListener('click',a),i.addEventListener('touchstart',a)),i.addEventListener('click',d),i.addEventListener('touchstart',d),this.element.appendChild(i),this.marks[e]={element:i,listeners:[d,a]},l}}}},{key:'unhighlight',value:function(e){var t;e in this.highlights&&(t=this.highlights[e],this.pane.removeMark(t.mark),t.listeners.forEach(function(e){e&&t.element.removeEventListener('click',e)}),delete this.highlights[e])}},{key:'ununderline',value:function(e){var t;e in this.underlines&&(t=this.underlines[e],this.pane.removeMark(t.mark),t.listeners.forEach(function(e){e&&t.element.removeEventListener('click',e)}),delete this.underlines[e])}},{key:'unmark',value:function(e){var t;e in this.marks&&(t=this.marks[e],this.element.removeChild(t.element),t.listeners.forEach(function(e){e&&t.element.removeEventListener('click',e)}),delete this.marks[e])}},{key:'destroy',value:function(){for(var e in this.highlights)this.unhighlight(e);for(var t in this.underlines)this.ununderline(t);for(var n in this.marks)this.unmark(n);this.blobUrl&&w(this.blobUrl),this.displayed&&(this.displayed=!1,this.removeListeners(),this.stopExpanding=!0,this.element.removeChild(this.iframe),this.iframe=void 0,this.contents=void 0,this._textWidth=null,this._textHeight=null,this._width=null,this._height=null)}}]),e}();ka(Jo.prototype);var Qo=function(e){var t=typeof e;return null!=e&&('object'==t||'function'==t)},er='object'==typeof se&&se&&se.Object===Object&&se,tr='object'==typeof self&&self&&self.Object===Object&&self,nr=er||tr||Function('return this')(),ar=nr,ir=function(){return ar.Date.now()},or=ar.Symbol,rr=or,sr=Object.prototype,lr=sr.hasOwnProperty,dr=sr.toString,cr=rr?rr.toStringTag:void 0,pr=function(e){var t=lr.call(e,cr),n=e[cr];try{e[cr]=void 0}catch(t){}var a=dr.call(e);return t?e[cr]=n:delete e[cr],a},ur=Object.prototype,hr=ur.toString,gr=function(e){return hr.call(e)},mr='[object Null]',yr='[object Undefined]',fr=rr?rr.toStringTag:void 0,vr=function(e){return null!=e&&'object'==typeof e},kr=function(e){return'symbol'==typeof e||vr(e)&&J(e)=='[object Symbol]'},br=0/0,xr=/^\\s+|\\s+$/g,_r=/^[-+]0x[0-9a-f]+$/i,Er=/^0b[01]+$/i,wr=/^0o[0-7]+$/i,Sr=parseInt,Cr=function(e){if('number'==typeof e)return e;if(kr(e))return br;if(Qo(e)){var t='function'==typeof e.valueOf?e.valueOf():e;e=Qo(t)?t+'':t}if('string'!=typeof e)return 0===e?e:+e;e=e.replace(xr,'');var n=Er.test(e);return n||wr.test(e)?Sr(e.slice(2),n?2:8):_r.test(e)?br:+e},Rr='Expected a function',Tr=ae,Or=ie,Lr=Q,Nr='Expected a function',Ir=function(){function e(t){Xn(this,e),this.settings=t||{},this.id='epubjs-container-'+o(),this.container=this.create(this.settings),this.settings.hidden&&(this.wrapper=this.wrap(this.container))}return ta(e,[{key:'create',value:function(e){var t=e.height,n=e.width,a=e.overflow||!1,i=e.axis||'vertical',o=e.direction,r=e.scale;e.height&&s(e.height)&&(t=e.height+'px'),e.width&&s(e.width)&&(n=e.width+'px');var l=document.createElement('div');return l.id=this.id,l.classList.add('epub-container'),l.style.wordSpacing='0',l.style.lineHeight='0',l.style.verticalAlign='top','horizontal'===i&&(l.style.display='flex',l.style.flexDirection='row',l.style.flexWrap='nowrap'),n&&(l.style.width=n),t&&(l.style.height=t),a&&(l.style.overflow=a),o&&(l.dir=o,l.style.direction=o),o&&this.settings.fullsize&&(document.body.style.direction=o),r&&(l.style['transform-origin']='top left',l.style.transform='scale('+r+')',l.style.overflow='visible'),l}},{key:'wrap',value:function(e){var t=document.createElement('div');return t.style.visibility='hidden',t.style.overflow='hidden',t.style.width='0',t.style.height='0',t.appendChild(e),t}},{key:'getElement',value:function(e){var t;if(r(e)?t=e:'string'==typeof e&&(t=document.getElementById(e)),!t)throw new Error('Not an Element');return t}},{key:'attachTo',value:function(e){var t=this.getElement(e),n;if(t)return n=this.settings.hidden?this.wrapper:this.container,t.appendChild(n),this.element=t,t}},{key:'getContainer',value:function(){return this.container}},{key:'onResize',value:function(e){s(this.settings.width)&&s(this.settings.height)||(this.resizeFunc=ee(e,50),window.addEventListener('resize',this.resizeFunc,!1))}},{key:'onOrientationChange',value:function(e){this.orientationChangeFunc=e,window.addEventListener('orientationchange',this.orientationChangeFunc,!1)}},{key:'size',value:function(e,t){var n;null===e&&(n=this.element.getBoundingClientRect(),n.width&&(e=n.width,this.container.style.width=n.width+'px')),null===t&&(n=n||this.element.getBoundingClientRect(),n.height&&(t=n.height,this.container.style.height=n.height+'px')),s(e)||(n=this.container.getBoundingClientRect(),e=n.width),s(t)||(n=n||this.container.getBoundingClientRect(),t=n.height),this.containerStyles=window.getComputedStyle(this.container),this.containerPadding={left:parseFloat(this.containerStyles['padding-left'])||0,right:parseFloat(this.containerStyles['padding-right'])||0,top:parseFloat(this.containerStyles['padding-top'])||0,bottom:parseFloat(this.containerStyles['padding-bottom'])||0};var a=v();return e||(e=a.width),(this.settings.fullsize||!t)&&(t=a.height),this.width=e,this.height=t,{width:e-this.containerPadding.left-this.containerPadding.right,height:t-this.containerPadding.top-this.containerPadding.bottom}}},{key:'bounds',value:function(){var e;return'visible'!==this.container.style.overflow&&(e=this.container&&this.container.getBoundingClientRect()),e&&e.width&&e.height?e:v()}},{key:'getSheet',value:function(){var e=document.createElement('style');return e.appendChild(document.createTextNode('')),document.head.appendChild(e),e.sheet}},{key:'addStyleRules',value:function(e,t){var n='#'+this.id+' ',a='';this.sheet||(this.sheet=this.getSheet()),t.forEach(function(e){for(var t in e)e.hasOwnProperty(t)&&(a+=t+':'+e[t]+';')}),this.sheet.insertRule(n+e+' {'+a+'}',0)}},{key:'axis',value:function(e){'horizontal'===e?(this.container.style.display='flex',this.container.style.flexDirection='row',this.container.style.flexWrap='nowrap'):this.container.style.display='block'}},{key:'direction',value:function(e){this.container&&(this.container.dir=e,this.container.style.direction=e),this.settings.fullsize&&(document.body.style.direction=e)}},{key:'scale',value:function(e){this.container&&(this.container.style['transform-origin']='top left',this.container.style.transform='scale('+e+')')}},{key:'destroy',value:function(){var e;this.element&&(e=this.settings.hidden?this.wrapper:this.container,this.element.contains(e)&&this.element.removeChild(e),window.removeEventListener('resize',this.resizeFunc),window.removeEventListener('orientationChange',this.orientationChangeFunc))}}]),e}(),Ar=function(){function e(t){Xn(this,e),this.container=t,this._views=[],this.length=0,this.hidden=!1}return ta(e,[{key:'all',value:function(){return this._views}},{key:'first',value:function(){return this._views[0]}},{key:'last',value:function(){return this._views[this._views.length-1]}},{key:'indexOf',value:function(e){return this._views.indexOf(e)}},{key:'slice',value:function(){return this._views.slice.apply(this._views,arguments)}},{key:'get',value:function(e){return this._views[e]}},{key:'append',value:function(e){return this._views.push(e),this.container&&this.container.appendChild(e.element),this.length++,e}},{key:'prepend',value:function(e){return this._views.unshift(e),this.container&&this.container.insertBefore(e.element,this.container.firstChild),this.length++,e}},{key:'insert',value:function(e,t){return this._views.splice(t,0,e),this.container&&(t<this.container.children.length?this.container.insertBefore(e.element,this.container.children[t]):this.container.appendChild(e.element)),this.length++,e}},{key:'remove',value:function(e){var t=this._views.indexOf(e);-1<t&&this._views.splice(t,1),this.destroy(e),this.length--}},{key:'destroy',value:function(e){e.displayed&&e.destroy(),this.container&&this.container.removeChild(e.element),e=null}},{key:'forEach',value:function(){return this._views.forEach.apply(this._views,arguments)}},{key:'clear',value:function(){var e=this.length,t;if(this.length){for(var n=0;n<e;n++)t=this._views[n],this.destroy(t);this._views=[],this.length=0}}},{key:'find',value:function(e){for(var t=this.length,n=0,a;n<t;n++)if(a=this._views[n],a.displayed&&a.section.index==e.index)return a}},{key:'displayed',value:function(){for(var e=[],t=this.length,n=0,a;n<t;n++)a=this._views[n],a.displayed&&e.push(a);return e}},{key:'show',value:function(){for(var e=this.length,t=0,n;t<e;t++)n=this._views[t],n.displayed&&n.show();this.hidden=!1}},{key:'hide',value:function(){for(var e=this.length,t=0,n;t<e;t++)n=this._views[t],n.displayed&&n.hide();this.hidden=!0}}]),e}(),Pr=function(){function e(t){Xn(this,e),this.name='default',this.View=t.view,this.request=t.request,this.spine=t.spine,this.hooks=t.hooks,this.q=new oo(this),this.settings=p(this.settings||{},{infinite:!0,hidden:!1,width:void 0,height:void 0,axis:void 0,flow:'scrolled',ignoreClass:''}),p(this.settings,t.settings||{}),this.viewSettings={ignoreClass:this.settings.ignoreClass,hooks:this.hooks,axis:this.settings.axis,flow:this.settings.flow,layout:this.layout,method:this.settings.method||'url',width:0,height:0,forceEvenPages:!0},this.rendered=!1}return ta(e,[{key:'render',value:function(e,t){var n=e.tagName;n&&('body'==n.toLowerCase()||'html'==n.toLowerCase())&&(this.fullsize=!0),this.fullsize&&(this.settings.overflow='visible',this.overflow=this.settings.overflow),this.settings.size=t,this.stage=new Ir({width:t.width,height:t.height,overflow:this.overflow,hidden:this.settings.hidden,axis:this.settings.axis,fullsize:this.fullsize,direction:this.settings.direction,scale:this.settings.scale}),this.stage.attachTo(e),this.container=this.stage.getContainer(),this.views=new Ar(this.container),this._bounds=this.bounds(),this._stageSize=this.stage.size(),this.viewSettings.width=this._stageSize.width,this.viewSettings.height=this._stageSize.height,this.stage.onResize(this.onResized.bind(this)),this.stage.onOrientationChange(this.onOrientationChange.bind(this)),this.addEventListeners(),this.layout&&this.updateLayout(),this.rendered=!0}},{key:'addEventListeners',value:function(){var e;window.addEventListener('unload',function(){this.destroy()}.bind(this)),e=this.fullsize?window:this.container,e.addEventListener('scroll',this.onScroll.bind(this))}},{key:'removeEventListeners',value:function(){var e;e=this.fullsize?window:this.container,e&&e.removeEventListener('scroll',this.onScroll.bind(this))}},{key:'destroy',value:function(){clearTimeout(this.orientationTimeout),clearTimeout(this.resizeTimeout),clearTimeout(this.afterScrolled),this.clear(),this.removeEventListeners(),this.stage&&this.stage.destroy(),this.rendered=!1}},{key:'onOrientationChange',value:function(){var e=window,t=e.orientation;this.resize(),clearTimeout(this.orientationTimeout),this.orientationTimeout=setTimeout(function(){this.orientationTimeout=void 0,this.resize(),this.emit(lo.MANAGERS.ORIENTATION_CHANGE,t)}.bind(this),500)}},{key:'onResized',value:function(){this.resize()}},{key:'resize',value:function(e,t){var n=this.stage.size(e,t);return this.winBounds=v(),this.orientationTimeout&&this.winBounds.width===this.winBounds.height?void(this._stageSize=void 0):void(this._stageSize&&this._stageSize.width===n.width&&this._stageSize.height===n.height||(this._stageSize=n,this._bounds=this.bounds(),this.clear(),this.viewSettings.width=this._stageSize.width,this.viewSettings.height=this._stageSize.height,this.updateLayout(),this.emit(lo.MANAGERS.RESIZED,{width:this._stageSize.width,height:this._stageSize.height})))}},{key:'createView',value:function(e){return new this.View(e,this.viewSettings)}},{key:'display',value:function(e,t){var n=new B,a=n.promise;(t===e.href||s(t))&&(t=void 0);var i=this.views.find(e);if(i&&e){var o=i.offset();if('ltr'===this.settings.direction)this.scrollTo(o.left,o.top,!0);else{var r=i.width();this.scrollTo(o.left+r,o.top,!0)}if(t){var l=i.locationOf(t);this.moveTo(l)}return n.resolve(),a}return this.clear(),this.add(e).then(function(e){if(t){var n=e.locationOf(t);this.moveTo(n)}}.bind(this),function(e){n.reject(e)}).then(function(){var t;if('pre-paginated'===this.layout.name&&1<this.layout.divisor&&(t=F(e,this.spine),t))return this.add(t)}.bind(this)).then(function(){this.views.show(),n.resolve()}.bind(this)),a}},{key:'afterDisplayed',value:function(e){this.emit(lo.MANAGERS.ADDED,e)}},{key:'afterResized',value:function(e){this.emit(lo.MANAGERS.RESIZE,e.section)}},{key:'moveTo',value:function(e){var t=0,n=0;this.isPaginated?(t=oe(e.left/this.layout.delta)*this.layout.delta,t+this.layout.delta>this.container.scrollWidth&&(t=this.container.scrollWidth-this.layout.delta)):n=e.top,this.scrollTo(t,n,!0)}},{key:'add',value:function(e){var t=this,n=this.createView(e);return this.views.append(n),n.onDisplayed=this.afterDisplayed.bind(this),n.onResize=this.afterResized.bind(this),n.on(lo.VIEWS.AXIS,function(e){t.updateAxis(e)}),n.display(this.request)}},{key:'append',value:function(e){var t=this,n=this.createView(e);return this.views.append(n),n.onDisplayed=this.afterDisplayed.bind(this),n.onResize=this.afterResized.bind(this),n.on(lo.VIEWS.AXIS,function(e){t.updateAxis(e)}),n.display(this.request)}},{key:'prepend',value:function(e){var t=this,n=this.createView(e);return n.on(lo.VIEWS.RESIZED,function(e){t.counter(e)}),this.views.prepend(n),n.onDisplayed=this.afterDisplayed.bind(this),n.onResize=this.afterResized.bind(this),n.on(lo.VIEWS.AXIS,function(e){t.updateAxis(e)}),n.display(this.request)}},{key:'counter',value:function(e){'vertical'===this.settings.axis?this.scrollBy(0,e.heightDelta,!0):this.scrollBy(e.widthDelta,0,!0)}},{key:'next',value:function(){var e=this.settings.direction,t,n;if(this.views.length){if(this.isPaginated&&'horizontal'===this.settings.axis&&(!e||'ltr'===e))this.scrollLeft=this.container.scrollLeft,n=this.container.scrollLeft+this.container.offsetWidth+this.layout.delta,n<=this.container.scrollWidth?this.scrollBy(this.layout.delta,0,!0):t=F(this.views.last().section,this.spine);else if(this.isPaginated&&'horizontal'===this.settings.axis&&'rtl'===e)this.scrollLeft=this.container.scrollLeft,n=this.container.scrollLeft,0<n?this.scrollBy(this.layout.delta,0,!0):t=F(this.views.last().section,this.spine);else if(this.isPaginated&&'vertical'===this.settings.axis){this.scrollTop=this.container.scrollTop;var a=this.container.scrollTop+this.container.offsetHeight;a<this.container.scrollHeight?this.scrollBy(0,this.layout.height,!0):t=F(this.views.last().section,this.spine)}else t=F(this.views.last().section,this.spine);return t?(this.clear(),this.append(t).then(function(){var e;if('pre-paginated'===this.layout.name&&1<this.layout.divisor&&(e=F(t,this.spine),e))return this.append(e)}.bind(this),function(e){return e}).then(function(){this.views.show()}.bind(this))):void 0}}},{key:'prev',value:function(){var e=this.settings.direction,t,n;if(this.views.length){if(this.isPaginated&&'horizontal'===this.settings.axis&&(!e||'ltr'===e))this.scrollLeft=this.container.scrollLeft,n=this.container.scrollLeft,0<n?this.scrollBy(-this.layout.delta,0,!0):t=W(this.views.first().section,this.spine);else if(this.isPaginated&&'horizontal'===this.settings.axis&&'rtl'===e)this.scrollLeft=this.container.scrollLeft,n=this.container.scrollLeft+this.container.offsetWidth+this.layout.delta,n<=this.container.scrollWidth?this.scrollBy(-this.layout.delta,0,!0):t=W(this.views.first().section,this.spine);else if(this.isPaginated&&'vertical'===this.settings.axis){this.scrollTop=this.container.scrollTop;var a=this.container.scrollTop;0<a?this.scrollBy(0,-this.layout.height,!0):t=W(this.views.first().section,this.spine)}else t=W(this.views.first().section,this.spine);return t?(this.clear(),this.prepend(t).then(function(){var e;if('pre-paginated'===this.layout.name&&1<this.layout.divisor&&(e=W(t,this.spine),e))return this.prepend(e)}.bind(this),function(e){return e}).then(function(){this.isPaginated&&'horizontal'===this.settings.axis&&('rtl'===this.settings.direction?this.scrollTo(0,0,!0):this.scrollTo(this.container.scrollWidth-this.layout.delta,0,!0)),this.views.show()}.bind(this))):void 0}}},{key:'current',value:function(){var e=this.visible();return e.length?e[e.length-1]:null}},{key:'clear',value:function(){this.views&&(this.views.hide(),this.scrollTo(0,0,!0),this.views.clear())}},{key:'currentLocation',value:function(){return this.location='vertical'===this.settings.axis?this.scrolledLocation():this.paginatedLocation(),this.location}},{key:'scrolledLocation',value:function(){var e=this,t=this.visible(),n=this.container.getBoundingClientRect(),a=n.height<window.innerHeight?n.height:window.innerHeight,o=0,r=0;this.fullsize&&(o=window.scrollY);var i=t.map(function(t){var s=t.section.index,l=t.section.source||t.section.href,d=t.position(),c=t.height(),p=o+n.top-d.top+r,u=p+a-r;u>c&&(u=c,r=u-p);var h=e.layout.count(c,a).pages,g=re(p/a),m=[],y=re(u/a);m=[];for(var f=g,i;f<=y;f++)i=f+1,m.push(i);var v=e.mapping.page(t.contents,t.section.cfiBase,p,u);return{index:s,href:l,pages:m,totalPages:h,mapping:v}});return i}},{key:'paginatedLocation',value:function(){var e=this,t=this.visible(),n=this.container.getBoundingClientRect(),a=0,o=0;this.fullsize&&(a=window.scrollX);var i=t.map(function(t){var r=t.section.index,s=t.section.source||t.section.href,l=t.position().left,d=t.width(),c=a+n.left-l+o,p=c+e.layout.width-o,u=e.mapping.page(t.contents,t.section.cfiBase,c,p),h=e.layout.count(d).pages,g=oe(c/e.layout.pageWidth),m=[],y=oe(p/e.layout.pageWidth);if(0>g&&(g=0,++y),'rtl'===e.settings.direction){var f=g;g=h-y,y=h-f}for(var v=g+1,i;v<=y;v++)i=v,m.push(i);return{index:r,href:s,pages:m,totalPages:h,mapping:u}});return i}},{key:'isVisible',value:function(e,t,n,a){var i=e.position(),o=a||this.bounds();return!!('horizontal'===this.settings.axis&&i.right>o.left-t&&i.left<o.right+n)||!!('vertical'===this.settings.axis&&i.bottom>o.top-t&&i.top<o.bottom+n)}},{key:'visible',value:function(){for(var e=this.bounds(),t=this.views.displayed(),n=t.length,a=[],o=0,i,r;o<n;o++)r=t[o],i=this.isVisible(r,0,0,e),!0===i&&a.push(r);return a}},{key:'scrollBy',value:function(e,t,n){var a='rtl'===this.settings.direction?-1:1;n&&(this.ignore=!0),this.fullsize?window.scrollBy(e*a,t*a):(e&&(this.container.scrollLeft+=e*a),t&&(this.container.scrollTop+=t)),this.scrolled=!0}},{key:'scrollTo',value:function(e,t,n){n&&(this.ignore=!0),this.fullsize?window.scrollTo(e,t):(this.container.scrollLeft=e,this.container.scrollTop=t),this.scrolled=!0}},{key:'onScroll',value:function(){var e,t;this.fullsize?(e=window.scrollY,t=window.scrollX):(e=this.container.scrollTop,t=this.container.scrollLeft),this.scrollTop=e,this.scrollLeft=t,this.ignore?this.ignore=!1:(this.emit(lo.MANAGERS.SCROLL,{top:e,left:t}),clearTimeout(this.afterScrolled),this.afterScrolled=setTimeout(function(){this.emit(lo.MANAGERS.SCROLLED,{top:this.scrollTop,left:this.scrollLeft})}.bind(this),20))}},{key:'bounds',value:function(){var e;return e=this.stage.bounds(),e}},{key:'applyLayout',value:function(e){this.layout=e,this.updateLayout()}},{key:'updateLayout',value:function(){this.stage&&(this._stageSize=this.stage.size(),this.isPaginated?(this.layout.calculate(this._stageSize.width,this._stageSize.height,this.settings.gap),this.settings.offset=this.layout.delta):this.layout.calculate(this._stageSize.width,this._stageSize.height),this.viewSettings.width=this.layout.width,this.viewSettings.height=this.layout.height,this.setLayout(this.layout))}},{key:'setLayout',value:function(e){this.viewSettings.layout=e,this.mapping=new vo(e.props,this.settings.direction,this.settings.axis),this.views&&this.views.forEach(function(t){t&&t.setLayout(e)})}},{key:'updateAxis',value:function(e,t){this.isPaginated||(e='vertical'),(t||e!==this.settings.axis)&&(this.settings.axis=e,this.stage&&this.stage.axis(e),this.viewSettings.axis=e,this.mapping&&(this.mapping=new vo(this.layout.props,this.settings.direction,this.settings.axis)),this.layout&&('vertical'===e?this.layout.spread('none'):this.layout.spread(this.layout.settings.spread)))}},{key:'updateFlow',value:function(e){var t='paginated'===e||'auto'===e;this.isPaginated=t,('scrolled-doc'===e||'scrolled-continuous'===e||'scrolled'===e)&&this.updateAxis('vertical'),this.viewSettings.flow=e,this.overflow=this.settings.overflow?this.settings.overflow:t?'hidden':'auto',this.updateLayout()}},{key:'getContents',value:function(){var e=[];return this.views?(this.views.forEach(function(t){var n=t&&t.contents;n&&e.push(n)}),e):e}},{key:'direction',value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'ltr';this.settings.direction=e,this.stage&&this.stage.direction(e),this.viewSettings.direction=e,this.updateLayout()}},{key:'isRendered',value:function(){return this.rendered}},{key:'scale',value:function(e){this.settings.scale=e,this.stage&&this.stage.scale(e)}}]),e}();ka(Pr.prototype),Ra('getPrototypeOf',function(){return function(e){return _t(kt(e))}});var Br=le.Object.getPrototypeOf,jr=a(function(e){e.exports={default:Br,__esModule:!0}}),Dr=n(jr),zr=a(function(e,t){t.__esModule=!0;var n=function(e){return e&&e.__esModule?e:{default:e}}(Zi);t.default=function(e,t){if(!e)throw new ReferenceError('this hasn\\'t been initialised - super() hasn\\'t been called');return t&&('object'===('undefined'==typeof t?'undefined':(0,n.default)(t))||'function'==typeof t)?t:e}}),Mr=n(zr),qr=function(e,t){if(xe(e),!be(t)&&null!==t)throw TypeError(t+': can\\'t set as prototype!')},Fr={set:Object.setPrototypeOf||('__proto__'in{}?function(e,t,n){try{n=ke(Function.call,ja.f(Object.prototype,'__proto__').set,2),n(e,[]),t=!(e instanceof Array)}catch(n){t=!0}return function(e,a){return qr(e,a),t?e.__proto__=a:n(e,a),e}}({},!1):void 0),check:qr};je(je.S,'Object',{setPrototypeOf:Fr.set});var Wr=le.Object.setPrototypeOf,Hr=a(function(e){e.exports={default:Wr,__esModule:!0}});n(Hr),je(je.S,'Object',{create:ut});var Ur=le.Object,Yr=function(e,t){return Ur.create(e,t)},Vr=a(function(e){e.exports={default:Yr,__esModule:!0}}),Gr=n(Vr),Kr=a(function(e,t){function n(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var a=n(Hr),i=n(Vr),o=n(Zi);t.default=function(e,t){if('function'!=typeof t&&null!==t)throw new TypeError('Super expression must either be null or a function, not '+('undefined'==typeof t?'undefined':(0,o.default)(t)));e.prototype=(0,i.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(a.default?(0,a.default)(e,t):e.__proto__=t)}}),Xr=n(Kr),$r=function(e){function t(e){Xn(this,t);var n=Mr(this,(t.__proto__||Dr(t)).call(this,e));return n.name='continuous',n.settings=p(n.settings||{},{infinite:!0,overflow:void 0,axis:void 0,flow:'scrolled',offset:500,offsetDelta:250,width:void 0,height:void 0}),p(n.settings,e.settings||{}),'undefined'!=e.settings.gap&&0===e.settings.gap&&(n.settings.gap=e.settings.gap),n.viewSettings={ignoreClass:n.settings.ignoreClass,hooks:n.hooks,axis:n.settings.axis,flow:n.settings.flow,layout:n.layout,method:n.settings.method||'url',width:0,height:0,forceEvenPages:!1},n.scrollTop=0,n.scrollLeft=0,n}return Xr(t,e),ta(t,[{key:'display',value:function(e,t){return Pr.prototype.display.call(this,e,t).then(function(){return this.fill()}.bind(this))}},{key:'fill',value:function(e){var t=this,n=e||new B;return this.q.enqueue(function(){return t.check()}).then(function(e){e?t.fill(n):n.resolve()}),n.promise}},{key:'moveTo',value:function(e){var t=0,n=0;this.isPaginated?t=oe(e.left/this.layout.delta)*this.layout.delta:n=e.top,(0<t||0<n)&&this.scrollBy(t,n,!0)}},{key:'afterResized',value:function(e){this.emit(lo.MANAGERS.RESIZE,e.section)}},{key:'removeShownListeners',value:function(e){e.onDisplayed=function(){}}},{key:'add',value:function(e){var t=this,n=this.createView(e);return this.views.append(n),n.on(lo.VIEWS.RESIZED,function(){n.expanded=!0}),n.on(lo.VIEWS.AXIS,function(e){t.updateAxis(e)}),n.onDisplayed=this.afterDisplayed.bind(this),n.onResize=this.afterResized.bind(this),n.display(this.request)}},{key:'append',value:function(e){var t=this.createView(e);return t.on(lo.VIEWS.RESIZED,function(){t.expanded=!0}),this.views.append(t),t.onDisplayed=this.afterDisplayed.bind(this),t}},{key:'prepend',value:function(e){var t=this,n=this.createView(e);return n.on(lo.VIEWS.RESIZED,function(e){t.counter(e),n.expanded=!0}),this.views.prepend(n),n.onDisplayed=this.afterDisplayed.bind(this),n}},{key:'counter',value:function(e){'vertical'===this.settings.axis?this.scrollBy(0,e.heightDelta,!0):this.scrollBy(e.widthDelta,0,!0)}},{key:'update',value:function(e){for(var t=this.bounds(),n=this.views.all(),a=n.length,o='undefined'==typeof e?this.settings.offset||0:e,r=new B,s=[],l=0,i,d;l<a;l++)if(d=n[l],i=this.isVisible(d,o,o,t),!0!==i)this.q.enqueue(d.destroy.bind(d)),clearTimeout(this.trimTimeout),this.trimTimeout=setTimeout(function(){this.q.enqueue(this.trim.bind(this))}.bind(this),250);else if(!d.displayed){var c=d.display(this.request).then(function(e){e.show()},function(){d.hide()});s.push(c)}else d.show();return s.length?Gn.all(s).catch(function(e){r.reject(e)}):(r.resolve(),r.promise)}},{key:'check',value:function(e,t){var n=this,a=new B,i=[],o='horizontal'===this.settings.axis,r=this.settings.offset||0;e&&o&&(r=e),t&&!o&&(r=t);var s=this._bounds,l='rtl'===this.settings.direction,d=o&&l?-1:1,c=o?this.scrollLeft:this.scrollTop*d,p=o?s.width:s.height,u=o?this.container.scrollWidth:this.container.scrollHeight,h=function(){var e=n.views.first(),t=e&&W(e.section,n.spine);t&&i.push(n.prepend(t))},g=function(){var e=n.views.last(),t=e&&F(e.section,n.spine);t&&i.push(n.append(t))};c+p+r>=u&&(o&&l?h():g()),0>c-r&&(o&&l?g():h());var m=i.map(function(e){return e.displayed});return i.length?Gn.all(m).then(function(){if('pre-paginated'===n.layout.name&&n.layout.props.spread)return n.check()}).then(function(){return n.update(r)},function(e){return e}):(this.q.enqueue(function(){this.update()}.bind(this)),a.resolve(!1),a.promise)}},{key:'trim',value:function(){for(var e=new B,t=this.views.displayed(),n=t[0],a=t[t.length-1],o=this.views.indexOf(n),r=this.views.indexOf(a),s=this.views.slice(0,o),l=this.views.slice(r+1),d=0;d<s.length-1;d++)this.erase(s[d],s);for(var i=1;i<l.length;i++)this.erase(l[i]);return e.resolve(),e.promise}},{key:'erase',value:function(e,t){var n,a;this.settings.height?(n=this.container.scrollTop,a=this.container.scrollLeft):(n=window.scrollY,a=window.scrollX);var i=e.bounds();this.views.remove(e),t&&('vertical'===this.settings.axis?this.scrollTo(0,n-i.height,!0):this.scrollTo(a-i.width,0,!0))}},{key:'addEventListeners',value:function(){window.addEventListener('unload',function(){this.ignore=!0,this.destroy()}.bind(this)),this.addScrollListeners()}},{key:'addScrollListeners',value:function(){var e;this.tick=ei,this.settings.height?(this.prevScrollTop=this.container.scrollTop,this.prevScrollLeft=this.container.scrollLeft):(this.prevScrollTop=window.scrollY,this.prevScrollLeft=window.scrollX),this.scrollDeltaVert=0,this.scrollDeltaHorz=0,this.settings.height?(e=this.container,this.scrollTop=this.container.scrollTop,this.scrollLeft=this.container.scrollLeft):(e=window,this.scrollTop=window.scrollY,this.scrollLeft=window.scrollX),e.addEventListener('scroll',this.onScroll.bind(this)),this._scrolled=Lr(this.scrolled.bind(this),30),this.didScroll=!1}},{key:'removeEventListeners',value:function(){var e;e=this.settings.height?this.container:window,e.removeEventListener('scroll',this.onScroll.bind(this))}},{key:'onScroll',value:function(){var e=Math.abs,t=void 0,n=void 0,a='rtl'===this.settings.direction?-1:1;this.settings.height?(t=this.container.scrollTop,n=this.container.scrollLeft):(t=window.scrollY*a,n=window.scrollX*a),this.scrollTop=t,this.scrollLeft=n,this.ignore?this.ignore=!1:this._scrolled(),this.scrollDeltaVert+=e(t-this.prevScrollTop),this.scrollDeltaHorz+=e(n-this.prevScrollLeft),this.prevScrollTop=t,this.prevScrollLeft=n,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(function(){this.scrollDeltaVert=0,this.scrollDeltaHorz=0}.bind(this),150),this.didScroll=!1}},{key:'scrolled',value:function(){this.q.enqueue(function(){this.check()}.bind(this)),this.emit(lo.MANAGERS.SCROLL,{top:this.scrollTop,left:this.scrollLeft}),clearTimeout(this.afterScrolled),this.afterScrolled=setTimeout(function(){this.emit(lo.MANAGERS.SCROLLED,{top:this.scrollTop,left:this.scrollLeft})}.bind(this))}},{key:'next',value:function(){var e='pre-paginated'===this.layout.props.name&&this.layout.props.spread?2*this.layout.props.delta:this.layout.props.delta;this.views.length&&(this.isPaginated&&'horizontal'===this.settings.axis?this.scrollBy(e,0,!0):this.scrollBy(0,this.layout.height,!0),this.q.enqueue(function(){this.check()}.bind(this)))}},{key:'prev',value:function(){var e='pre-paginated'===this.layout.props.name&&this.layout.props.spread?2*this.layout.props.delta:this.layout.props.delta;this.views.length&&(this.isPaginated&&'horizontal'===this.settings.axis?this.scrollBy(-e,0,!0):this.scrollBy(0,-this.layout.height,!0),this.q.enqueue(function(){this.check()}.bind(this)))}},{key:'updateAxis',value:function(e,t){this.isPaginated||(e='vertical'),(t||e!==this.settings.axis)&&(this.settings.axis=e,this.stage&&this.stage.axis(e),this.viewSettings.axis=e,this.mapping&&this.mapping.axis(e),this.layout&&('vertical'===e?this.layout.spread('none'):this.layout.spread(this.layout.settings.spread)),this.settings.infinite='vertical'===e)}}]),t}(Pr),Zr=function(){function e(t,n){var a=this;Xn(this,e),this.settings=p(this.settings||{},{width:null,height:null,ignoreClass:'',manager:'default',view:'iframe',flow:null,layout:null,spread:null,minSpreadWidth:800,stylesheet:null,script:null,worker:void 0,workerScope:void 0}),p(this.settings,n),'object'===Ji(this.settings.manager)&&(this.manager=this.settings.manager),this.hooks={},this.hooks.display=new no(this),this.hooks.content=new no(this),this.hooks.unloaded=new no(this),this.hooks.layout=new no(this),this.hooks.render=new no(this),this.hooks.show=new no(this),this.hooks.content.register(this.handleLinks.bind(this)),this.hooks.content.register(this.passEvents.bind(this)),this.hooks.content.register(this.adjustImages.bind(this)),this.hooks.content.register(this.addIdentifier.bind(this)),this.themes=new fo(this),this.annotations=new _o(this),this.epubcfi=new to,this.q=new oo(this),this.location=void 0,this.spineByHref=void 0,this.spineBySource=void 0,this.spineById=void 0,this.starting=new B,this.started=this.starting.promise,this.q.enqueue(this.started),t&&this.unpack(t),this.settings.worker&&navigator&&'serviceWorker'in navigator&&this.q.enqueue(function(){return a.worker(a.settings.worker).catch(function(){return a.starting=new B,a.started=a.starting.promise,a.q.enqueue(a.started)})})}return ta(e,[{key:'unpack',value:function(e){var t=this;if(!e)throw new Error('No manifest provided');this.manifest='string'==typeof e?JSON.parse(e):e;this.manifest.spine.map(function(e,t){return e.index=t,e});this.spineByHref={},this.spineBySource={},this.spineById={},this.manifest.spine.forEach(function(e,n){t.spineByHref[decodeURI(e.href)]=n,t.spineByHref[encodeURI(e.href)]=n,t.spineByHref[e.href]=n,e.source&&(t.spineBySource[decodeURI(e.source)]=n,t.spineBySource[encodeURI(e.source)]=n,t.spineBySource[e.source]=n),t.spineById[e.idref]=n}),this.book=new uo(e),this.start()}},{key:'setManager',value:function(e){this.manager=e}},{key:'requireManager',value:function(e){var t;return t='string'==typeof e&&'default'===e?Pr:'string'==typeof e&&'continuous'===e?$r:e,t}},{key:'requireView',value:function(e){var t;return t='string'==typeof e&&'iframe'===e?Jo:e,t}},{key:'start',value:function(){this.manager||(this.ViewManager=this.requireManager(this.settings.manager),this.View=this.requireView(this.settings.view),this.manager=new this.ViewManager({view:this.View,spine:this.manifest.spine,hooks:this.hooks,settings:this.settings})),this.direction(this.manifest.metadata.direction),this.settings.globalLayoutProperties=this.determineLayoutProperties(this.manifest.metadata),this.flow(this.settings.globalLayoutProperties.flow),this.layout(this.settings.globalLayoutProperties),this.manager.on(lo.MANAGERS.ADDED,this.afterDisplayed.bind(this)),this.manager.on(lo.MANAGERS.REMOVED,this.afterRemoved.bind(this)),this.manager.on(lo.MANAGERS.RESIZED,this.onResized.bind(this)),this.manager.on(lo.MANAGERS.ORIENTATION_CHANGE,this.onOrientationChange.bind(this)),this.manager.on(lo.MANAGERS.SCROLLED,this.reportLocation.bind(this)),this.emit(lo.RENDITION.STARTED),this.starting.resolve()}},{key:'attachTo',value:function(e){return this.q.enqueue(function(){this.manager.render(e,{width:this.settings.width,height:this.settings.height}),this.emit(lo.RENDITION.ATTACHED)}.bind(this))}},{key:'display',value:function(e){return this.displaying&&this.displaying.resolve(),this.q.enqueue(this._display,e)}},{key:'_display',value:function(e){var t=this,n=new B,a=n.promise,i;return(this.displaying=n,this.locations&&this.locations.length()&&(l(e)||'1.0'===e)&&(e=this.locations.cfiFromPercentage(parseFloat(e))),i=this.findInSpine(e),!i)?(n.reject(new Error('No Section Found')),a):(this.manager.display(i,e).then(function(){n.resolve(i),t.displaying=void 0,t.emit(lo.RENDITION.DISPLAYED,i),t.reportLocation()},function(e){t.emit(lo.RENDITION.DISPLAY_ERROR,e)}),a)}},{key:'afterDisplayed',value:function(e){var t=this;e.on(lo.VIEWS.MARK_CLICKED,function(n,a){return t.triggerMarkEvent(n,a,e)}),this.hooks.render.trigger(e,this).then(function(){e.contents?t.hooks.content.trigger(e.contents,t).then(function(){t.emit(lo.RENDITION.RENDERED,e.section,e)}):t.emit(lo.RENDITION.RENDERED,e.section,e)})}},{key:'afterRemoved',value:function(e){var t=this;this.hooks.unloaded.trigger(e,this).then(function(){t.emit(lo.RENDITION.REMOVED,e.section,e)})}},{key:'onResized',value:function(e){this.emit(lo.RENDITION.RESIZED,{width:e.width,height:e.height}),this.location&&this.location.start&&this.display(this.location.start.cfi)}},{key:'onOrientationChange',value:function(e){this.emit(lo.RENDITION.ORIENTATION_CHANGE,e)}},{key:'moveTo',value:function(e){this.manager.moveTo(e)}},{key:'resize',value:function(e,t){e&&(this.settings.width=e),t&&(this.settings.height=t),this.manager.resize(e,t)}},{key:'clear',value:function(){this.manager.clear()}},{key:'next',value:function(){return this.q.enqueue(this.manager.next.bind(this.manager)).then(this.reportLocation.bind(this))}},{key:'prev',value:function(){return this.q.enqueue(this.manager.prev.bind(this.manager)).then(this.reportLocation.bind(this))}},{key:'determineLayoutProperties',value:function(e){var t=this.settings.layout||e.layout||'reflowable',n=this.settings.spread||e.spread||'auto',a=this.settings.orientation||e.orientation||'auto',i=this.settings.flow||e.flow||'auto',o=e.viewport||'',r=this.settings.minSpreadWidth||e.minSpreadWidth||800,s=this.settings.direction||e.direction||'ltr',l;return l={layout:t,spread:n,orientation:a,flow:i,viewport:o,minSpreadWidth:r,direction:s},l}},{key:'flow',value:function(e){var t=e;('scrolled'===e||'scrolled-doc'===e||'scrolled-continuous'===e)&&(t='scrolled'),('auto'===e||'paginated'===e)&&(t='paginated'),this.settings.flow=e,this._layout&&this._layout.flow(t),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this.manager&&this.manager.updateFlow(t),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}},{key:'layout',value:function(e){var t=this;return e&&(this._layout=new yo(e),this._layout.spread(e.spread,this.settings.minSpreadWidth),this._layout.on(lo.LAYOUT.UPDATED,function(e,n){t.emit(lo.RENDITION.LAYOUT,e,n)})),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this._layout}},{key:'spread',value:function(e,t){this._layout.spread(e,t),this.manager.isRendered()&&this.manager.updateLayout()}},{key:'direction',value:function(e){this.settings.direction=e||'ltr',this.manager&&this.manager.direction(this.settings.direction),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}},{key:'reportLocation',value:function(){return this.q.enqueue(function(){requestAnimationFrame(function(){var e=this.manager.currentLocation();if(e&&e.then&&'function'==typeof e.then)e.then(function(e){var t=this.located(e);t&&t.start&&t.end&&(this.location=t,this.emit(lo.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,href:this.location.start.href,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(lo.RENDITION.RELOCATED,this.location))}.bind(this));else if(e){var t=this.located(e);if(!t||!t.start||!t.end)return;this.location=t,this.emit(lo.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,href:this.location.start.href,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(lo.RENDITION.RELOCATED,this.location)}}.bind(this))}.bind(this))}},{key:'currentLocation',value:function(){var e=this.manager.currentLocation();if(e&&e.then&&'function'==typeof e.then)e.then(function(e){var t=this.located(e);return t}.bind(this));else if(e){var t=this.located(e);return t}}},{key:'located',value:function(e){if(!e.length)return{};var t=e[0],n=e[e.length-1],a={start:{index:t.index,href:t.href,cfi:t.mapping.start,displayed:{page:t.pages[0]||1,total:t.totalPages}},end:{index:n.index,href:n.href,cfi:n.mapping.end,displayed:{page:n.pages[n.pages.length-1]||1,total:n.totalPages}}};if(this.locations){var i=this.locations.locationFromCfi(t.mapping.start),o=this.locations.locationFromCfi(n.mapping.end);null!=i&&(a.start.location=i,a.start.percentage=this.locations.percentageFromLocation(i)),null!=o&&(a.end.location=o,a.end.percentage=this.locations.percentageFromLocation(o))}if(this.pageList){var r=this.pageList.pageFromCfi(t.mapping.start),s=this.pageList.pageFromCfi(n.mapping.end);-1!=r&&(a.start.page=r),-1!=s&&(a.end.page=s)}return n.index===this.manifest.spine[this.manifest.spine.length-1].index&&a.end.displayed.page>=a.end.displayed.total&&(a.atEnd=!0),t.index===this.manifest.spine[0].index&&1===a.start.displayed.page&&(a.atStart=!0),a}},{key:'destroy',value:function(){this.q.clear(),this.q=void 0,this.manager&&this.manager.destroy(),this.manifest=void 0,this.spineByHref=void 0,this.spineBySource=void 0,this.spineById=void 0,this.hooks.display.clear(),this.hooks.content.clear(),this.hooks.layout.clear(),this.hooks.render.clear(),this.hooks.show.clear(),this.hooks={},this.themes.destroy(),this.themes=void 0,this.epubcfi=void 0,this.starting=void 0,this.started=void 0}},{key:'passEvents',value:function(t){var n=this,e=xo.listenedEvents;e.forEach(function(a){t.on(a,function(e){return n.triggerViewEvent(e,t)})}),t.on(lo.CONTENTS.SELECTED,function(a){return n.triggerSelectedEvent(a,t)})}},{key:'triggerViewEvent',value:function(t,e){this.emit(t.type,t,e)}},{key:'triggerSelectedEvent',value:function(e,t){this.emit(lo.RENDITION.SELECTED,e,t)}},{key:'triggerMarkEvent',value:function(e,t,n){this.emit(lo.RENDITION.MARK_CLICKED,e,t,n)}},{key:'getRange',value:function(e,t){var n=new to(e),a=this.manager.visible().filter(function(e){if(n.spinePos===e.index)return!0});if(a.length)return a[0].contents.range(n,t)}},{key:'adjustImages',value:function(e){return'pre-paginated'===this._layout.name?new Gn(function(e){e()}):(e.addStylesheetRules({img:{\"max-width\":(this._layout.columnWidth?this._layout.columnWidth+'px':'100%')+'!important',\"max-height\":(this._layout.height?.6*this._layout.height+'px':'60%')+'!important',\"object-fit\":'contain',\"page-break-inside\":'avoid'},svg:{\"max-width\":(this._layout.columnWidth?this._layout.columnWidth+'px':'100%')+'!important',\"max-height\":(this._layout.height?.6*this._layout.height+'px':'60%')+'!important',\"page-break-inside\":'avoid'}}),new Gn(function(e){setTimeout(function(){e()},1)}))}},{key:'addIdentifier',value:function(e){var t=this.book.metadata.identifier;e.addIdentifier(t)}},{key:'getContents',value:function(){return this.manager?this.manager.getContents():[]}},{key:'views',value:function(){var e=this.manager?this.manager.views:void 0;return e||[]}},{key:'handleLinks',value:function(e){var t=this;e&&e.on(lo.CONTENTS.LINK_CLICKED,function(e){var n=t.book.path.relative(e);t.display(n)})}},{key:'findInSpine',value:function(e){var t=0;if(this.epubcfi.isCfiString(e)){var n=new to(e);t=n.spinePos}else'number'==typeof e||!1===isNaN(e)?t=e:'string'==typeof e&&0===e.indexOf('#')?t=this.spineById[e.substring(1)]:'string'==typeof e&&(e=e.split('#')[0],t=this.spineByHref[e]||this.spineByHref[encodeURI(e)]||this.spineBySource[e]||this.spineBySource[encodeURI(e)]);return this.manifest.spine[t]||null}},{key:'key',value:function(e){var t=e||this.manifest.metadata.identifier;return'epubjs-'+ro+'-'+t}},{key:'worker',value:function(e){var t=this,n=new B,a=this.key(),i=new ci(this.book.url),o=this.book.source?this.book.source.type:'';if('application/epub+zip'!==o&&i.origin===window.location.origin&&n.resolve(),'serviceWorker'in navigator){var r=navigator.serviceWorker.controller;r&&n.resolve(),navigator.serviceWorker.register(e,{scope:this.settings.workerScope}).then(function(e){r=navigator.serviceWorker.controller,e.active&&!r&&(t.emit(lo.RENDITION.WORKER_INACTIVE),n.resolve()),r&&n.resolve()},function(e){console.error(e),t.emit(lo.RENDITION.WORKER_FAILED),n.reject('Worker registration failed',e)}),navigator.serviceWorker.addEventListener('message',function(e){!1,'active'===e.data.msg&&n.resolve()}),navigator.serviceWorker.addEventListener('controllerchange',function(){r=navigator.serviceWorker.controller,r&&n.resolve()})}else n.resolve();return n.promise}},{key:'cache',value:function(e){e||(e=navigator.serviceWorker.controller),e.postMessage({method:'add',key:key,resources:this.manifest.resources})}},{key:'scale',value:function(e){return this.manager&&this.manager.scale(e)}}]),e}();ka(Zr.prototype);var Jr=a(function(e){!function(t){function n(e,t,n,a){var o=t&&t.prototype instanceof i?t:i,r=Object.create(o.prototype),s=new h(a||[]);return r._invoke=d(e,n,s),r}function a(e,t,n){try{return{type:'normal',arg:e.call(t,n)}}catch(e){return{type:'throw',arg:e}}}function i(){}function o(){}function r(){}function s(e){['next','throw','return'].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function l(e){function t(n,i,o,r){var s=a(e[n],e,i);if('throw'===s.type)r(s.arg);else{var l=s.arg,d=l.value;return d&&'object'==typeof d&&f.call(d,'__await')?Promise.resolve(d.__await).then(function(e){t('next',e,o,r)},function(e){t('throw',e,o,r)}):Promise.resolve(d).then(function(e){l.value=e,o(l)},r)}}function n(e,n){function a(){return new Promise(function(a,i){t(e,n,a,i)})}return i=i?i.then(a,a):a()}var i;this._invoke=n}function d(e,t,n){var i=E;return function(o,r){if(i===S)throw new Error('Generator is already running');if(i===C){if('throw'===o)throw r;return m()}for(n.method=o,n.arg=r;;){var s=n.delegate;if(s){var l=c(s,n);if(l){if(l===R)continue;return l}}if('next'===n.method)n.sent=n._sent=n.arg;else if('throw'===n.method){if(i===E)throw i=C,n.arg;n.dispatchException(n.arg)}else'return'===n.method&&n.abrupt('return',n.arg);i=S;var d=a(e,t,n);if('normal'===d.type){if(i=n.done?C:w,d.arg===R)continue;return{value:d.arg,done:n.done}}'throw'===d.type&&(i=C,n.method='throw',n.arg=d.arg)}}}function c(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,'throw'===t.method){if(e.iterator.return&&(t.method='return',t.arg=void 0,c(e,t),'throw'===t.method))return R;t.method='throw',t.arg=new TypeError('The iterator does not provide a \\'throw\\' method')}return R}var i=a(n,e.iterator,t.arg);if('throw'===i.type)return t.method='throw',t.arg=i.arg,t.delegate=null,R;var o=i.arg;if(!o)return t.method='throw',t.arg=new TypeError('iterator result is not an object'),t.delegate=null,R;if(o.done)t[e.resultName]=o.value,t.next=e.nextLoc,'return'!==t.method&&(t.method='next',t.arg=void 0);else return o;return t.delegate=null,R}function p(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function u(e){var t=e.completion||{};t.type='normal',delete t.arg,e.completion=t}function h(e){this.tryEntries=[{tryLoc:'root'}],e.forEach(p,this),this.reset(!0)}function g(e){if(e){var t=e[k];if(t)return t.call(e);if('function'==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(f.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:m}}function m(){return{value:void 0,done:!0}}var y=Object.prototype,f=y.hasOwnProperty,v='function'==typeof Symbol?Symbol:{},k=v.iterator||'@@iterator',b=v.asyncIterator||'@@asyncIterator',x=v.toStringTag||'@@toStringTag',_=t.regeneratorRuntime;if(_)return void(e.exports=_);_=t.regeneratorRuntime=e.exports,_.wrap=n;var E='suspendedStart',w='suspendedYield',S='executing',C='completed',R={},T={};T[k]=function(){return this};var O=Object.getPrototypeOf,L=O&&O(O(g([])));L&&L!==y&&f.call(L,k)&&(T=L);var N=r.prototype=i.prototype=Object.create(T);o.prototype=N.constructor=r,r.constructor=o,r[x]=o.displayName='GeneratorFunction',_.isGeneratorFunction=function(e){var t='function'==typeof e&&e.constructor;return!!t&&(t===o||'GeneratorFunction'===(t.displayName||t.name))},_.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,r):(e.__proto__=r,!(x in e)&&(e[x]='GeneratorFunction')),e.prototype=Object.create(N),e},_.awrap=function(e){return{__await:e}},s(l.prototype),l.prototype[b]=function(){return this},_.AsyncIterator=l,_.async=function(e,t,a,i){var o=new l(n(e,t,a,i));return _.isGeneratorFunction(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},s(N),N[x]='Generator',N[k]=function(){return this},N.toString=function(){return'[object Generator]'},_.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},_.values=g,h.prototype={constructor:h,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method='next',this.arg=void 0,this.tryEntries.forEach(u),!e)for(var t in this)'t'===t.charAt(0)&&f.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0],t=e.completion;if('throw'===t.type)throw t.arg;return this.rval},dispatchException:function(e){function t(t,a){return o.type='throw',o.arg=e,n.next=t,a&&(n.method='next',n.arg=void 0),!!a}if(this.done)throw e;for(var n=this,a=this.tryEntries.length-1;0<=a;--a){var i=this.tryEntries[a],o=i.completion;if('root'===i.tryLoc)return t('end');if(i.tryLoc<=this.prev){var r=f.call(i,'catchLoc'),s=f.call(i,'finallyLoc');if(r&&s){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(r){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);}else if(!s)throw new Error('try statement without catch or finally');else if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1,a;0<=n;--n)if(a=this.tryEntries[n],a.tryLoc<=this.prev&&f.call(a,'finallyLoc')&&this.prev<a.finallyLoc){var i=a;break}i&&('break'===e||'continue'===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method='next',this.next=i.finallyLoc,R):this.complete(o)},complete:function(e,t){if('throw'===e.type)throw e.arg;return'break'===e.type||'continue'===e.type?this.next=e.arg:'return'===e.type?(this.rval=this.arg=e.arg,this.method='return',this.next='end'):'normal'===e.type&&t&&(this.next=t),R},finish:function(e){for(var t=this.tryEntries.length-1,n;0<=t;--t)if(n=this.tryEntries[t],n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),u(n),R},catch:function(e){for(var t=this.tryEntries.length-1,n;0<=t;--t)if(n=this.tryEntries[t],n.tryLoc===e){var a=n.completion;if('throw'===a.type){var i=a.arg;u(n)}return i}throw new Error('illegal catch attempt')},delegateYield:function(e,t,n){return this.delegate={iterator:g(e),resultName:t,nextLoc:n},'next'===this.method&&(this.arg=void 0),R}}}(function(){return this}()||Function('return this')())}),Qr=function(){return this}()||Function('return this')(),g=Qr.regeneratorRuntime&&0<=Object.getOwnPropertyNames(Qr).indexOf('regeneratorRuntime'),es=g&&Qr.regeneratorRuntime;Qr.regeneratorRuntime=void 0;if(g)Qr.regeneratorRuntime=es;else try{delete Qr.regeneratorRuntime}catch(t){Qr.regeneratorRuntime=void 0}var ts=Jr,ns=a(function(e,t){t.__esModule=!0;var n=function(e){return e&&e.__esModule?e:{default:e}}(Vn);t.default=function(e){return function(){var t=e.apply(this,arguments);return new n.default(function(e,a){function i(o,r){try{var s=t[o](r),l=s.value}catch(e){return void a(e)}return s.done?void e(l):n.default.resolve(l).then(function(e){i('next',e)},function(e){i('throw',e)})}return i('next')})}}}),as=n(ns),is=a(function(e){(function(t,n){t||(t=window||se),e.exports?e.exports=n(t):t.URL=n(t)})(se,function(e){function t(e){return void 0!==p[e]}function n(){s.call(this),this._isInvalid=!0}function a(e){return''==e&&n.call(this),e.toLowerCase()}function o(e){var t=e.charCodeAt(0);return 32<t&&127>t&&-1==[34,35,60,62,63,96].indexOf(t)?e:encodeURIComponent(e)}function r(e){var t=e.charCodeAt(0);return 32<t&&127>t&&-1==[34,35,60,62,96].indexOf(t)?e:encodeURIComponent(e)}function i(e,s,l){var d=s||'scheme start',y=0,f='',v=!1,k=!1;loop:for(;(e[y-1]!=m||0==y)&&!this._isInvalid;){var b=e[y];switch(d){case'scheme start':if(b&&h.test(b))f+=b.toLowerCase(),d='scheme';else if(!s){f='',d='no scheme';continue}else break loop;break;case'scheme':if(b&&g.test(b))f+=b.toLowerCase();else if(':'==b){if(this._scheme=f,f='',s)break loop;t(this._scheme)&&(this._isRelative=!0),d='file'==this._scheme?'relative':this._isRelative&&l&&l._scheme==this._scheme?'relative or authority':this._isRelative?'authority first slash':'scheme data'}else if(!s){f='',y=0,d='no scheme';continue}else if(m==b)break loop;else break loop;break;case'scheme data':'?'==b?(this._query='?',d='query'):'#'==b?(this._fragment='#',d='fragment'):m!=b&&'\\t'!=b&&'\\n'!=b&&'\\r'!=b&&(this._schemeData+=o(b));break;case'no scheme':if(!l||!t(l._scheme))n.call(this);else{d='relative';continue}break;case'relative or authority':if('/'==b&&'/'==e[y+1])d='authority ignore slashes';else{d='relative';continue}break;case'relative':if(this._isRelative=!0,'file'!=this._scheme&&(this._scheme=l._scheme),m==b){this._host=l._host,this._port=l._port,this._path=l._path.slice(),this._query=l._query,this._username=l._username,this._password=l._password;break loop}else if('/'==b||'\\\\'==b)d='relative slash';else if('?'==b)this._host=l._host,this._port=l._port,this._path=l._path.slice(),this._query='?',this._username=l._username,this._password=l._password,d='query';else if('#'==b)this._host=l._host,this._port=l._port,this._path=l._path.slice(),this._query=l._query,this._fragment='#',this._username=l._username,this._password=l._password,d='fragment';else{var c=e[y+1],x=e[y+2];'file'==this._scheme&&h.test(b)&&(':'==c||'|'==c)&&(m==x||'/'==x||'\\\\'==x||'?'==x||'#'==x)||(this._host=l._host,this._port=l._port,this._username=l._username,this._password=l._password,this._path=l._path.slice(),this._path.pop()),d='relative path';continue}break;case'relative slash':if('/'==b||'\\\\'==b)d='file'==this._scheme?'file host':'authority ignore slashes';else{'file'!=this._scheme&&(this._host=l._host,this._port=l._port,this._username=l._username,this._password=l._password),d='relative path';continue}break;case'authority first slash':if('/'==b)d='authority second slash';else{d='authority ignore slashes';continue}break;case'authority second slash':if(d='authority ignore slashes','/'!=b)continue;break;case'authority ignore slashes':if('/'!=b&&'\\\\'!=b){d='authority';continue}else;break;case'authority':if('@'==b){v&&(f+='%40'),v=!0;for(var _=0,i;_<f.length;_++)if(i=f[_],'\\t'!=i&&'\\n'!=i&&'\\r'!=i){if(':'==i&&null===this._password){this._password='';continue}var E=o(i);null===this._password?this._username+=E:this._password+=E}f=''}else if(m==b||'/'==b||'\\\\'==b||'?'==b||'#'==b){y-=f.length,f='',d='host';continue}else f+=b;break;case'file host':if(m==b||'/'==b||'\\\\'==b||'?'==b||'#'==b){2==f.length&&h.test(f[0])&&(':'==f[1]||'|'==f[1])?d='relative path':0==f.length?d='relative path start':(this._host=a.call(this,f),f='',d='relative path start');continue}else if('\\t'==b||'\\n'==b||'\\r'==b);else f+=b;break;case'host':case'hostname':if(':'==b&&!k){if(this._host=a.call(this,f),f='',d='port','hostname'==s)break loop;}else if(m==b||'/'==b||'\\\\'==b||'?'==b||'#'==b){if(this._host=a.call(this,f),f='',d='relative path start',s)break loop;continue}else if('\\t'!=b&&'\\n'!=b&&'\\r'!=b)'['==b?k=!0:']'==b&&(k=!1),f+=b;else;break;case'port':if(/[0-9]/.test(b))f+=b;else if(m==b||'/'==b||'\\\\'==b||'?'==b||'#'==b||s){if(''!=f){var w=parseInt(f,10);w!=p[this._scheme]&&(this._port=w+''),f=''}if(s)break loop;d='relative path start';continue}else if('\\t'==b||'\\n'==b||'\\r'==b);else n.call(this);break;case'relative path start':if(d='relative path','/'!=b&&'\\\\'!=b)continue;break;case'relative path':if(m==b||'/'==b||'\\\\'==b||!s&&('?'==b||'#'==b)){var S;(S=u[f.toLowerCase()])&&(f=S),'..'==f?(this._path.pop(),'/'!=b&&'\\\\'!=b&&this._path.push('')):'.'==f&&'/'!=b&&'\\\\'!=b?this._path.push(''):'.'!=f&&('file'==this._scheme&&0==this._path.length&&2==f.length&&h.test(f[0])&&'|'==f[1]&&(f=f[0]+':'),this._path.push(f)),f='','?'==b?(this._query='?',d='query'):'#'==b&&(this._fragment='#',d='fragment')}else'\\t'!=b&&'\\n'!=b&&'\\r'!=b&&(f+=o(b));break;case'query':s||'#'!=b?m!=b&&'\\t'!=b&&'\\n'!=b&&'\\r'!=b&&(this._query+=r(b)):(this._fragment='#',d='fragment');break;case'fragment':m!=b&&'\\t'!=b&&'\\n'!=b&&'\\r'!=b&&(this._fragment+=b);}y++}}function s(){this._scheme='',this._schemeData='',this._username='',this._password=null,this._host='',this._port='',this._path=[],this._query='',this._fragment='',this._isInvalid=!1,this._isRelative=!1}function l(e,t){void 0===t||t instanceof l||(t=new l(t+'')),this._url=e,s.call(this);var n=e.replace(/^[ \\t\\r\\n\\f]+|[ \\t\\r\\n\\f]+$/g,'');i.call(this,n,null,t)}var d=!1;if(!e.forceJURL)try{var c=new URL('b','http://a');c.pathname='c%20d',d='http://a/c%20d'===c.href}catch(t){}if(d)return e.URL;var p=Gr(null);p.ftp=21,p.file=0,p.gopher=70,p.http=80,p.https=443,p.ws=80,p.wss=443;var u=Gr(null);u['%2e']='.',u['.%2e']='..',u['%2e.']='..',u['%2e%2e']='..';var h=/[a-zA-Z]/,g=/[a-zA-Z0-9\\+\\-\\.]/,m;l.prototype={toString:function(){return this.href},get href(){if(this._isInvalid)return this._url;var e='';return(''!=this._username||null!=this._password)&&(e=this._username+(null==this._password?'':':'+this._password)+'@'),this.protocol+(this._isRelative?'//'+e+this.host:'')+this.pathname+this._query+this._fragment},set href(e){s.call(this),i.call(this,e)},get protocol(){return this._scheme+':'},set protocol(e){this._isInvalid||i.call(this,e+':','scheme start')},get host(){return this._isInvalid?'':this._port?this._host+':'+this._port:this._host},set host(e){this._isInvalid||!this._isRelative||i.call(this,e,'host')},get hostname(){return this._host},set hostname(e){this._isInvalid||!this._isRelative||i.call(this,e,'hostname')},get port(){return this._port},set port(e){this._isInvalid||!this._isRelative||i.call(this,e,'port')},get pathname(){return this._isInvalid?'':this._isRelative?'/'+this._path.join('/'):this._schemeData},set pathname(e){this._isInvalid||!this._isRelative||(this._path=[],i.call(this,e,'relative path start'))},get search(){return this._isInvalid||!this._query||'?'==this._query?'':this._query},set search(e){this._isInvalid||!this._isRelative||(this._query='?','?'==e[0]&&(e=e.slice(1)),i.call(this,e,'query'))},get hash(){return this._isInvalid||!this._fragment||'#'==this._fragment?'':this._fragment},set hash(e){this._isInvalid||(this._fragment='#','#'==e[0]&&(e=e.slice(1)),i.call(this,e,'fragment'))},get origin(){var e;if(this._isInvalid||!this._scheme)return'';switch(this._scheme){case'file':return'file://';case'data':case'javascript':case'mailto':return'null';}return e=this.host,e?this._scheme+'://'+e:''}};var y=e.URL;return y&&(l.createObjectURL=function(){return y.createObjectURL.apply(y,arguments)},l.revokeObjectURL=function(e){y.revokeObjectURL(e)}),l})}),os=!1,rs=function(){function e(t){var n=this;Xn(this,e),this.waiting={},this.ready=new Gn(function(e,t){n.resolveReady=e,n.rejectReady=t}),t&&t.worker&&(this.worker=new Worker(t.worker),this.worker.addEventListener('message',this.listen.bind(this)),this.ask('init',[t]))}return ta(e,[{key:'ask',value:function(e,t){var n=new B,a=n.id;if(this.worker){var i=he({method:e,args:t,promise:a});e in this.waiting?this.waiting[a].push(n):this.waiting[a]=[n],os,this.worker.postMessage(i)}else n.resolve(this.epub[e].apply(this.epub,t));return n.promise}},{key:'listen',value:function(e){var t=e.data;if('string'==typeof t&&(t=JSON.parse(t)),os,t.promise&&t.promise in this.waiting){var n=this.waiting[t.promise].shift();n&&n.resolve(t.value)}if(t.eventName)switch(t.eventName){case'ready':this.manifest=e.data.value,this.book=new uo(this.manifest),this.resolveReady(this.book);break;case'failed':this.rejectReady(e.data.error);}}},{key:'open',value:function(e){var t=this;return this.ask('open',[e]).then(function(e){return'string'==typeof e?(t.manifest=JSON.parse(e),t.book=new uo(t.manifest)):t.book=e,t.resolveReady(t.book),t.book})}},{key:'key',value:function(e){return this.ask('key',[e])}},{key:'replacements',value:function(){var e=this;return this.ask('replacements').then(function(t){return e.manifest=t,e.book=new uo(e.manifest),e.book})}},{key:'cache',value:function(){var e=this;return this.ask('cache').then(function(t){return e.manifest=t,e.book=new uo(e.manifest),e.book})}},{key:'locations',value:function(){var e=this;return this.ask('replacements').then(function(t){return e.manifest=t,e.book=new uo(e.manifest),e.book})}},{key:'generateLocations',value:function(e){var t=this;return this.ask('generateLocations',[e]).then(function(e){if(t.book)return t.book.locations=e,e})}},{key:'loadLocations',value:function(e){var t;this.book&&(t='string'==typeof t?JSON.parse(e):e,this.book.locations=t)}},{key:'destroy',value:function(){this.ask('destroy'),this.worker.removeEventListener('message',this.listen)}}]),e}(),ss=function(){var e=as(ts.mark(function e(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=arguments,i,o;return ts.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=void 0,o=void 0,0!==a.length&&(1!==a.length||'object'!==Ji(a[0]))){e.next=4;break}return e.abrupt('return',new(Function.prototype.bind.apply(Fo,[null].concat(Array.prototype.slice.call(a)))));case 4:return i=n.worker?new rs(n):new Fo(n),e.abrupt('return',i.open(t).then(function(e){return e.renderTo=function(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return n&&'undefined'!=typeof n.worker&&'undefined'==typeof a.worker&&(a.worker=n.worker),o=new Zr(e.manifest,a),o.attachTo(t),o.on('workerFailed',function(){o.clear(),i.replacements().then(function(e){o.unpack(e.manifest),o.display(o.location)})}),o},e.generateLocations=function(t){return i.generateLocations(t).then(function(t){return e.locations=t,t})},e._destroy=e.destroy,e.destroy=function(){e._destroy(),i.destroy(),o.destroy()},window.Epub=i,e}));case 6:case'end':return e.stop();}},e,this)}));return function(){return e.apply(this,arguments)}}();return ss.VERSION=ro,ss.CFI=to,ss.Book=uo,ss.Rendition=Zr,ss.Contents=xo,ss.utils=oi,ss});\n//# sourceMappingURL=epub.min.js.map\n";var BRIDGE="window.onerror = function (message, file, line, col, error) {\n  var msg = JSON.stringify({method:\"error\", value: message});\n  window.postMessage(msg, \"*\");\n};\n\n(function () {\n   var waitForReactNativePostMessageReady;\n\n  function _ready() {\n    var contents;\n    var targetOrigin = \"*\";\n    var sendMessage = function(obj) {\n      try {\n          window.postMessage(JSON.stringify(obj), targetOrigin);\n      } catch (error) {\n          window.postMessage(error.message, targetOrigin);\n      }\n    };\n\n    var preventTap = false;\n    var q = [];\n    var _isReady = false;\n\n    var book;\n    var rendition;\n\n    var minSpreadWidth = 800;\n    var axis = \"horizontal\";\n\n    var isChrome = /Chrome/.test(navigator.userAgent);\n    var isWebkit = !isChrome && /AppleWebKit/.test(navigator.userAgent);\n\n    var snapWidth = window.innerWidth;\n    var last_known_scroll_position = 0;\n    var ticking = false;\n    var touchCanceler = false;\n    var resizeCanceler = false;\n    var animating = false;\n\n    // debug\n    console.log = function() {\n      sendMessage({method:\"log\", value: Array.from(arguments)});\n    };\n\n    console.error = function() {\n      sendMessage({method:\"error\", value: Array.from(arguments)});\n    };\n\n    // var isReactNativePostMessageReady = !!window.originalPostMessage;\n    var isReactNativePostMessageReady = !!window.originalPostMessage || window.postMessage.toString().indexOf(\"[native code]\") === -1;\n    var hasReactNativePostMessage = typeof window.webkit !== \"undefined\" &&\n                                    typeof window.webkit.messageHandlers !== \"undefined\" &&\n                                    typeof window.webkit.messageHandlers.reactNative !== \"undefined\" &&\n                                    typeof window.webkit.messageHandlers.reactNative.postMessage !== \"undefined\";\n\n    clearTimeout(waitForReactNativePostMessageReady);\n    if (!isReactNativePostMessageReady && hasReactNativePostMessage) {\n      window.originalPostMessage = window.postMessage;\n      window.postMessage = function (data) { window.webkit.messageHandlers.reactNative.postMessage(data); };\n    } else if (!isReactNativePostMessageReady && !hasReactNativePostMessage){\n      waitForReactNativePostMessageReady = setTimeout(_ready, 1);\n      return;\n    }\n\n    function onMessage(e) {\n      var message = e.data;\n      handleMessage(message);\n    }\n\n    async function handleMessage(message) {\n      var decoded = (typeof message === \"object\") ? message : JSON.parse(message);\n      var response;\n      var result;\n\n      sendMessage({method:\"log\", value: \"[Rendition] handleMessage: \" + message});\n\n      switch (decoded.method) {\n        case \"open\": {\n          var url = decoded.args[0];\n          var options = decoded.args.length > 1 && decoded.args[1];\n          await openEpub(url, options);\n\n          if (options && options.webviewStylesheet) {\n            var head = document.getElementsByTagName('head')[0];\n            var link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.type = 'text/css';\n            link.href = options.webviewStylesheet;\n            head.appendChild(link);\n          }\n\n          break;\n        }\n        case \"display\": {\n          var args = decoded.args && decoded.args.length && decoded.args[0];\n          var target;\n\n          sendMessage({method:\"log\", value: \"[Rendition] display\"});\n\n          if (!args) {\n            target = undefined;\n          }\n          else if (args.target) {\n            target = args.target.toString();\n          }\n          else if (args.spine) {\n            target = parseInt(args.spine);\n          }\n\n          if (rendition) {\n            sendMessage({method:\"log\", value: \"[Rendition] display target: \" + target});\n            rendition.display(target);\n          } else {\n            sendMessage({method:\"log\", value: \"[Rendition] queue message: \" + message});\n            q.push(message);\n          }\n          break;\n        }\n        case \"flow\": {\n          var direction = decoded.args.length && decoded.args[0];\n          axis = (direction === \"paginated\") ? \"horizontal\" : \"vertical\";\n\n            sendMessage({method:\"log\", value: \"rendition.flow\"});\n            sendMessage({method:\"log\", value: direction});\n\n          if (rendition) {\n            rendition.flow(direction);\n          } else {\n            q.push(message);\n          }\n\n          break;\n        }\n        case \"setLocations\": {\n          var locations = decoded.args[0];\n          if (book) {\n            book.locations.load(locations);\n          } else {\n            q.push(message);\n          }\n\n          if (rendition) {\n            rendition.reportLocation();\n          }\n          break;\n        }\n        case \"reportLocation\": {\n          if (rendition) {\n            rendition.reportLocation();\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"minSpreadWidth\": {\n          minSpreadWidth = decoded.args;\n          break;\n        }\n        case \"mark\": {\n          if (rendition) {\n            rendition.annotations.mark.apply(rendition.annotations, decoded.args);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"underline\": {\n          if (rendition) {\n            rendition.annotations.underline.apply(rendition.annotations, decoded.args);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"highlight\": {\n          if (rendition) {\n            rendition.annotations.highlight.apply(rendition.annotations, decoded.args);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"removeAnnotation\": {\n          if (rendition) {\n            rendition.annotations.remove.apply(rendition.annotations, decoded.args);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"themes\": {\n          var themes = decoded.args[0];\n          if (rendition) {\n            rendition.themes.register(themes);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"theme\": {\n          var theme = decoded.args[0];\n          if (rendition) {\n            rendition.themes.select(theme);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"fontSize\": {\n          var fontSize = decoded.args[0];\n          if (rendition) {\n            rendition.themes.fontSize(fontSize);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"font\": {\n          var font = decoded.args[0];\n          if (rendition) {\n            rendition.themes.font(font);\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"next\": {\n          if (rendition) {\n            rendition.next();\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n        case \"prev\": {\n          if (rendition) {\n            rendition.prev();\n          } else {\n            q.push(message);\n          }\n          break;\n        }\n      }\n    }\n\n    async function openEpub(url, options) {\n      var settings = Object.assign({\n        manager: \"continuous\",\n        overflow: \"visible\",\n        method: \"blobUrl\"\n      }, options);\n\n      window.book = book = await ePub(url);\n\n      window.rendition = rendition = book.renderTo(document.body, settings);\n\n      rendition.hooks.content.register(function(contents) {\n        sendMessage({method:\"log\", value: '[Bridge] hooks.content.register'});\n        var doc = contents.document;\n        var startPosition = { x: -1, y: -1 };\n        var currentPosition = { x: -1, y: -1 };\n        var isLongPress = false;\n        var longPressTimer;\n        var touchduration = 300;\n        var $body = doc.getElementsByTagName('body')[0];\n\n        function touchStartHandler(e) {\n          var f, target;\n          startPosition.x = e.targetTouches[0].pageX;\n          startPosition.y = e.targetTouches[0].pageY;\n          currentPosition.x = e.targetTouches[0].pageX;\n          currentPosition.y = e.targetTouches[0].pageY;\n          isLongPress = false;\n\n          if (isWebkit) {\n            for (var i=0; i < e.targetTouches.length; i++) {\n              f = e.changedTouches[i].force;\n              if (f >= 0.8 && !preventTap) {\n                target = e.changedTouches[i].target;\n\n                if (target.getAttribute(\"ref\") === \"epubjs-mk\") {\n                  return;\n                }\n\n                clearTimeout(longPressTimer);\n\n                cfi = contents.cfiFromNode(target).toString();\n\n                sendMessage({method:\"longpress\", position: currentPosition, cfi: cfi});\n                isLongPress = false;\n                preventTap = true;\n              }\n            }\n          }\n\n\n          longPressTimer = setTimeout(function() {\n            target = e.targetTouches[0].target;\n\n            if (target.getAttribute(\"ref\") === \"epubjs-mk\") {\n              return;\n            }\n\n            cfi = contents.cfiFromNode(target).toString();\n\n            sendMessage({method:\"longpress\", position: currentPosition, cfi: cfi});\n            preventTap = true;\n          }, touchduration);\n        }\n\n        function touchMoveHandler(e) {\n          currentPosition.x = e.targetTouches[0].pageX;\n          currentPosition.y = e.targetTouches[0].pageY;\n          clearTimeout(longPressTimer);\n        }\n\n        function touchEndHandler(e) {\n          var cfi;\n          clearTimeout(longPressTimer);\n\n          if(preventTap) {\n            preventTap = false;\n            return;\n          }\n\n          if(Math.abs(startPosition.x - currentPosition.x) < 2 &&\n             Math.abs(startPosition.y - currentPosition.y) < 2) {\n\n            var target = e.changedTouches[0].target;\n\n            if (target.getAttribute(\"ref\") === \"epubjs-mk\" ||\n                target.getAttribute(\"ref\") === \"epubjs-hl\" ||\n                target.getAttribute(\"ref\") === \"epubjs-ul\") {\n              return;\n            }\n\n            cfi = contents.cfiFromNode(target).toString();\n\n            if(isLongPress) {\n              sendMessage({method:\"longpress\", position: currentPosition, cfi: cfi});\n              isLongPress = false;\n            } else {\n              setTimeout(function() {\n                if(preventTap) {\n                  preventTap = false;\n                  isLongPress = false;\n                  return;\n                }\n                sendMessage({method:\"press\", position: currentPosition, cfi: cfi});\n              }, 10);\n            }\n          }\n        }\n\n        function touchForceHandler(e) {\n          var f = e.changedTouches[0].force;\n          if (f >= 0.8 && !preventTap) {\n            var target = e.changedTouches[0].target;\n\n            if (target.getAttribute(\"ref\") === \"epubjs-mk\") {\n              return;\n            }\n\n            clearTimeout(longPressTimer);\n\n            cfi = contents.cfiFromNode(target).toString();\n\n            sendMessage({method:\"longpress\", position: currentPosition, cfi: cfi});\n            isLongPress = false;\n            preventTap = true;\n          }\n        }\n\n        if(!isWebkit) {\n\n          var prevX;\n          var flick = 0;\n          var pan = false;\n\n          doc.addEventListener('touchmove', function(e) {\n            var screenX = e.touches[0].screenX;\n            var delta = prevX - screenX;\n\n            touchMoveHandler(e);\n\n            if (axis !== \"horizontal\") {\n              return;\n            }\n\n            if (Math.abs(delta) > 0.5) {\n              pan = true;\n            }\n\n            if (delta > 20) {\n              flick = 1;\n            }\n\n            if (delta < -20) {\n              flick = -1;\n            }\n\n            // if (!animating) {\n            //   if (delta) {\n            //     window.scrollBy(delta, 0);\n            //   }\n            // }\n\n            prevX = screenX;\n\n            e.preventDefault();\n          }, { capture: true, passive: false });\n\n          doc.addEventListener('touchstart', function(e) {\n\n            touchStartHandler(e);\n\n            resizeCanceler = false;\n\n          }, { capture: false, passive: true });\n\n          doc.addEventListener('touchend', function(e) {\n\n            touchEndHandler(e);\n\n            if (axis !== \"horizontal\") {\n              return;\n            }\n\n            if(!animating) {\n\n              if (flick === 1) {\n                snap(last_known_scroll_position + snapWidth + 10);\n              }\n              else if (flick === -1) {\n                snap(last_known_scroll_position - snapWidth + 10);\n              }\n              else if (pan) {\n                snap(last_known_scroll_position);\n              }\n\n            }\n\n            prevX = undefined;\n            flick = 0;\n            pan = false;\n          }, { capture: true, passive: false });\n\n        } else {\n          doc.addEventListener(\"touchstart\", touchStartHandler, false);\n\n          doc.addEventListener(\"touchmove\", touchMoveHandler, false);\n\n          doc.addEventListener(\"touchend\", touchEndHandler, false);\n\n          doc.addEventListener('touchforcechange', touchForceHandler, false);\n        }\n\n      }.bind(this));\n\n      rendition.on(\"relocated\", function(location){\n        sendMessage({method:\"relocated\", location: location});\n      });\n\n      rendition.on(\"selected\", function (cfiRange) {\n        preventTap = true;\n        sendMessage({method:\"selected\", cfiRange: cfiRange});\n      });\n\n      rendition.on(\"markClicked\", function (cfiRange, data) {\n        preventTap = true;\n        sendMessage({method:\"markClicked\", cfiRange: cfiRange, data: data});\n      });\n\n      rendition.on(\"rendered\", function (section) {\n        sendMessage({method:\"rendered\", sectionIndex: section.index});\n      });\n\n      rendition.on(\"added\", function (section) {\n        sendMessage({method:\"added\", sectionIndex: section.index});\n      });\n\n      rendition.on(\"removed\", function (section) {\n        sendMessage({method:\"removed\", sectionIndex: section.index});\n      });\n\n      rendition.on(\"resized\", function(size){\n        sendMessage({method:\"resized\", size: size});\n      });\n\n      // replay messages\n      rendition.started.then(function() {\n        var msg;\n        for (var i = 0; i < q.length; i++) {\n          msg = q.shift();\n          handleMessage(msg);\n        }\n      });\n\n      book.ready.then(function(){\n        _isReady = true;\n\n        sendMessage({method:\"ready\"});\n\n      });\n\n      window.addEventListener(\"unload\", function () {\n        book && book.destroy();\n      });\n    }\n\n    window.addEventListener(\"message\", onMessage);\n    // React native uses document for postMessages\n    document.addEventListener(\"message\", onMessage);\n\n    sendMessage({method:\"loaded\", value: true});\n\n    // Snap scrolling\n    if(!isWebkit) {\n\n      // Disable momentum scrolling\n      document.getElementsByTagName('body')[0].style.overflow = \"hidden\";\n\n      window.addEventListener('scroll', function(e) {\n        last_known_scroll_position = window.scrollX;\n      });\n\n      window.addEventListener('resize', function(e) {\n        resizeCanceler = true;\n        snapWidth = window.innerWidth;\n        animating = false;\n      });\n    }\n\n    function snap(scroll_pos) {\n      var snapTo = Math.round(scroll_pos / snapWidth) * snapWidth;\n      if (scroll_pos % snapWidth > 0) {\n        scrollToX(snapTo, 25000);\n      }\n    }\n\n    function scrollToX(scrollTargetX, speed, easing) {\n        var scrollX = window.scrollX,\n            scrollTargetX = scrollTargetX || 0,\n            speed = speed || 2000,\n            easing = easing || 'easeOutSine',\n            currentTime = 0;\n\n        animating = true;\n\n        // min time .1, max time .8 seconds\n        var time = Math.max(.1, Math.min(Math.abs(scrollX - scrollTargetX) / speed, .8));\n\n        // easing equations from https://github.com/danro/easing-js/blob/master/easing.js\n        var PI_D2 = Math.PI / 2,\n        easingEquations = {\n            easeOutSine: function (pos) {\n                return Math.sin(pos * (Math.PI / 2));\n            },\n            easeInOutSine: function (pos) {\n                return (-0.5 * (Math.cos(Math.PI * pos) - 1));\n            },\n            easeInOutQuint: function (pos) {\n                if ((pos /= 0.5) < 1) {\n                    return 0.5 * Math.pow(pos, 5);\n                }\n                return 0.5 * (Math.pow((pos - 2), 5) + 2);\n            }\n        };\n\n        // add animation loop\n        function tick() {\n            currentTime += 1 / 60;\n\n            var p = currentTime / time;\n            var t = easingEquations[easing](p);\n\n            if (touchCanceler) {\n              return;\n            }\n\n            if (resizeCanceler) {\n              resizeCanceler = false;\n              return;\n            }\n\n            if (p < 1) {\n                window.requestAnimationFrame(tick);\n\n                window.scrollTo(scrollX + ((scrollTargetX - scrollX) * t), 0);\n            } else {\n                window.scrollTo(scrollTargetX, 0);\n                animating = false;\n            }\n        }\n\n        tick();\n    }\n  }\n\n  if ( document.readyState === 'complete' ) {\n    _ready();\n  } else {\n    window.addEventListener(\"load\", _ready, false);\n  }\n}());\n";var EMBEDDED_HTML="\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no\">\n  <title>epubjs</title>\n  <script>"+EPUBJS+"</script>\n  <script>"+BRIDGE+"</script>\n  <style>\n    body {\n      margin: 0;\n      -webkit-tap-highlight-color: rgba(0,0,0,0);\n      -webkit-tap-highlight-color: transparent; /* For some Androids */\n    }\n  </style>\n</head><body></body></html>\n";var Rendition=function(_Component){_inherits(Rendition,_Component);function Rendition(props){_classCallCheck(this,Rendition);var _this=_possibleConstructorReturn(this,(Rendition.__proto__||Object.getPrototypeOf(Rendition)).call(this,props));_this.state={loaded:false};return _this;}_createClass(Rendition,[{key:"componentDidMount",value:function componentDidMount(){this._isMounted=true;if(this.props.url){this.load(this.props.url);}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this._isMounted=false;this.destroy();}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){if(prevProps.url!==this.props.url){this.load(this.props.url);}if(prevProps.display!==this.props.display){this.display(this.props.display);}if(prevProps.orientation!==this.props.orientation){}if(prevProps.flow!==this.props.flow){this.flow(this.props.flow||"paginated");}if(prevProps.themes!==this.props.themes){this.themes(this.props.themes);}if(prevProps.themes!==this.props.theme){this.theme(this.props.theme);}if(prevProps.fontSize!==this.props.fontSize){this.fontSize(this.props.fontSize);}if(prevProps.font!==this.props.font){this.font(this.props.font);}}},{key:"load",value:function load(bookUrl){if(!this._webviewLoaded)return;__DEV__&&console.log("[Rendition] loading book: ",bookUrl);var config={"minSpreadWidth":this.props.minSpreadWidth||800,"flow":this.props.flow||"paginated"};if(this.props.stylesheet){config.stylesheet=this.props.stylesheet;}if(this.props.webviewStylesheet){config.webviewStylesheet=this.props.webviewStylesheet;}if(this.props.script){config.script=this.props.script;}this.sendToBridge("open",[bookUrl,config]);this.display(this.props.display);if(this.props.themes){this.themes(this.props.themes);}if(this.props.theme){this.theme(this.props.theme);}if(this.props.fontSize){this.fontSize(this.props.fontSize);}if(this.props.font){this.font(this.props.font);}}},{key:"display",value:function display(target){var spine=typeof target==="number"&&target;if(!this._webviewLoaded)return;if(spine){this.sendToBridge("display",[{"spine":spine}]);}else if(target){this.sendToBridge("display",[{"target":target}]);}else{this.sendToBridge("display");}}},{key:"flow",value:function flow(f){this.sendToBridge("flow",[f]);}},{key:"themes",value:function themes(t){this.sendToBridge("themes",[t]);}},{key:"theme",value:function theme(t){this.sendToBridge("theme",[t]);}},{key:"font",value:function font(f){this.sendToBridge("font",[f]);}},{key:"fontSize",value:function fontSize(f){this.sendToBridge("fontSize",[f]);}},{key:"setLocations",value:function setLocations(locations){this.locations=locations;if(this.isReady){this.sendToBridge("setLocations",[this.locations]);}}},{key:"reportLocation",value:function reportLocation(){if(this.isReady){this.sendToBridge("reportLocation");}}},{key:"highlight",value:function highlight(cfiRange,data){this.sendToBridge("highlight",[cfiRange,data]);}},{key:"underline",value:function underline(cfiRange,data){this.sendToBridge("underline",[cfiRange,data]);}},{key:"mark",value:function mark(cfiRange,data){this.sendToBridge("mark",[cfiRange,data]);}},{key:"unhighlight",value:function unhighlight(cfiRange,data){this.sendToBridge("removeAnnotation",[cfiRange,data]);}},{key:"ununderline",value:function ununderline(cfiRange,data){this.sendToBridge("removeAnnotation",[cfiRange,data]);}},{key:"unmark",value:function unmark(cfiRange,data){this.sendToBridge("removeAnnotation",[cfiRange,data]);}},{key:"next",value:function next(){this.sendToBridge("next");}},{key:"prev",value:function prev(){this.sendToBridge("prev");}},{key:"destroy",value:function destroy(){}},{key:"postMessage",value:function postMessage(str){if(this.refs.webviewbridge){return this.refs.webviewbridge.postMessage(str);}}},{key:"sendToBridge",value:function sendToBridge(method,args,promiseId){var str=JSON.stringify({method:method,args:args,promise:promiseId});if(!this.refs.webviewbridge){return;}this.refs.webviewbridge.postMessage(str);}},{key:"_onWebViewLoaded",value:function _onWebViewLoaded(){this._webviewLoaded=true;console.log('[Rendition] Web view has loaded');if(this.props.url){this.load(this.props.url);}}},{key:"_onBridgeMessage",value:function _onBridgeMessage(e){var msg=e.nativeEvent.data;var decoded;if(typeof msg==="string"){decoded=JSON.parse(msg);}else{decoded=msg;}var p;switch(decoded.method){case"log":{console.log.apply(console.log,[decoded.value]);break;}case"error":{if(this.props.onError){this.props.onError(decoded.value);}else{console.error.apply(console.error,[decoded.value]);}break;}case"loaded":{this._onWebViewLoaded();break;}case"rendered":{console.log("[Rendition] rendered");if(!this.state.loaded){this.setState({loaded:true});}break;}case"relocated":{var _decoded=decoded,location=_decoded.location;this._relocated(location);if(!this.state.loaded){this.setState({loaded:true});}break;}case"resized":{var _decoded2=decoded,size=_decoded2.size;console.log("resized",size.width,size.height);break;}case"press":{this.props.onPress&&this.props.onPress(decoded.cfi,decoded.position,this);break;}case"longpress":{this.props.onLongPress&&this.props.onLongPress(decoded.cfi,this);break;}case"selected":{var _decoded3=decoded,cfiRange=_decoded3.cfiRange;this._selected(cfiRange);break;}case"markClicked":{var _decoded4=decoded,_cfiRange=_decoded4.cfiRange,data=_decoded4.data;this._markClicked(_cfiRange,data);break;}case"added":{var _decoded5=decoded,sectionIndex=_decoded5.sectionIndex;this.props.onViewAdded&&this.props.onViewAdded(sectionIndex);break;}case"removed":{var _decoded6=decoded,_sectionIndex=_decoded6.sectionIndex;this.props.beforeViewRemoved&&this.props.beforeViewRemoved(_sectionIndex);break;}case"ready":{console.log("[Rendition] ready");this._ready();break;}default:{console.log("[Rendition] msg",decoded);}}}},{key:"_relocated",value:function _relocated(visibleLocation){this._visibleLocation=visibleLocation;if(this.props.onRelocated){this.props.onRelocated(visibleLocation,this);}}},{key:"_selected",value:function _selected(cfiRange){if(this.props.onSelected){this.props.onSelected(cfiRange,this);}}},{key:"_markClicked",value:function _markClicked(cfiRange,data){if(this.props.onMarkClicked){this.props.onMarkClicked(cfiRange,data,this);}}},{key:"_ready",value:function _ready(){this.isReady=true;if(this.locations){this.sendToBridge("setLocations",[this.locations]);}this.props.onDisplayed&&this.props.onDisplayed();}},{key:"render",value:function render(){var _this2=this;var WebViewer=_reactNative.Platform.OS==='ios'?_reactNativeWkwebviewReborn2.default:_reactNative.WebView;var loader=_react2.default.createElement(_reactNative.TouchableOpacity,{onPress:function onPress(){return _this2.props.onPress('');},style:styles.loadScreen,__source:{fileName:_jsxFileName,lineNumber:375}},_react2.default.createElement(_reactNative.View,{style:[styles.loadScreen,{backgroundColor:this.props.backgroundColor||"#FFFFFF"}],__source:{fileName:_jsxFileName,lineNumber:376}},_react2.default.createElement(_reactNative.ActivityIndicator,{color:this.props.color||"black",size:this.props.size||"large",style:{flex:1},__source:{fileName:_jsxFileName,lineNumber:379}})));if(!this.props.url){return loader;}return _react2.default.createElement(_reactNative.View,{ref:"framer",style:styles.container,__source:{fileName:_jsxFileName,lineNumber:393}},_react2.default.createElement(WebViewer,{ref:"webviewbridge",source:{html:EMBEDDED_HTML,baseUrl:this.props.url},style:[styles.manager,{backgroundColor:this.props.backgroundColor||"#FFFFFF"}],scalesPageToFit:false,bounces:false,javaScriptEnabled:true,scrollEnabled:true,pagingEnabled:this.props.flow==="paginated",onMessage:this._onBridgeMessage.bind(this),__source:{fileName:_jsxFileName,lineNumber:394}}),!this.state.loaded?loader:null);}}]);return Rendition;}(_react.Component);var styles=_reactNative.StyleSheet.create({container:{flex:1,flexDirection:"column"},manager:{flex:1},scrollContainer:{flex:1,marginTop:0,flexDirection:"row",flexWrap:"nowrap",backgroundColor:"#F8F8F8"},rowContainer:{flex:1},loadScreen:{position:"absolute",top:0,bottom:0,left:0,right:0,backgroundColor:"#fff",justifyContent:"center",alignItems:"center"}});(0,_eventEmitter2.default)(Rendition.prototype);module.exports=Rendition;